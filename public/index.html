<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeadFlow Pro â€” Complete Build</title>
  <style>
    #lfp-error {
      position: fixed; inset: 8px; z-index: 999999;
      background: #fff5f5; color:#7f1d1d; border:1px solid #fecaca;
      border-radius: 10px; font-family: system-ui, -apple-system, Segoe UI, Inter, sans-serif;
      padding: 12px; display:none; overflow:auto;
    }
    #lfp-error pre { white-space: pre-wrap; word-break: break-word; }
  </style>
  <script>
    (function(){
      function show(msg, detail){
        var el = document.getElementById('lfp-error');
        if (!el) { el = document.createElement('div'); el.id='lfp-error'; document.body.appendChild(el); }
        el.innerHTML =
          '<div style="font-weight:700;margin-bottom:6px">Something broke in the UI</div>' +
          '<div style="font-size:12px;margin-bottom:6px">'+(msg||'Unknown error')+'</div>' +
          (detail? '<pre>'+detail+'</pre>' : '') +
          (msg==='Script error.' ? '<div style="margin-top:6px;font-size:12px;color:#7f1d1d;">This usually means a cross-origin error from a CDN or browser extension. I added CORS flags, but if you still see this, hard refresh or try an incognito window.</div>' : '');
        el.style.display='block';
      }
      window.__lfp_showError = show;
      window.addEventListener('error', function(e){
        show(String(e.message||e.error||'Script error'), (e.error && e.error.stack) ? e.error.stack : '');
      });
      window.addEventListener('unhandledrejection', function(e){
        show('Unhandled Promise rejection', String(e.reason||''));
      });
    })();
  </script>
  <script>
    (function(){
      try {
        const q = new URLSearchParams(location.search);
        if (q.get('reset') === '1') {
          Object.keys(localStorage).forEach(k => { if (k.startsWith('lfp:')) localStorage.removeItem(k); });
          sessionStorage.clear?.();
          alert('âœ… LeadFlow storage cleared. Reloadingâ€¦');
          location.replace(location.origin + location.pathname);
        }
      } catch(e){}
    })();
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com" crossorigin="anonymous"></script>
  <script>
    (function(){
      function check(){
        if (!(window.React && window.ReactDOM && window.Babel)) {
          window.__lfp_showError && window.__lfp_showError(
            'Core libraries failed to load',
            'One of React / ReactDOM / Babel did not load from the CDN.\n' +
            '- Check network/CSP/ad blockers\n' +
            '- Try hard refresh (Ctrl/Cmd+Shift+R) or Incognito\n' +
            '- The app will not mount until those scripts load.'
          );
        }
      }
      setTimeout(check, 0);
    })();
  </script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .fade-in { animation: fadeIn .25s ease-in; }
    @keyframes fadeIn { from { opacity:.001; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
    .toggle-switch { position: relative; width: 48px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background .2s; }
    .toggle-switch.active { background: #667eea; }
    .toggle-slider { position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .2s; }
    .toggle-switch.active .toggle-slider { transform: translateX(24px); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .card { background: white; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    code.inline { background:#f9fafb; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="lfp-error"></div>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
class ErrorBoundary extends React.Component {
  constructor(props) {
    super(props);
    this.state = { hasError: false, error: null, errorInfo: null };
  }
  componentDidCatch(error, errorInfo) {
    this.setState({ hasError: true, error, errorInfo });
  }
  render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen p-6 bg-red-50 text-red-900">
          <div className="max-w-3xl mx-auto">
            <h1 className="text-2xl font-bold mb-2">Something broke in the UI</h1>
            <pre className="p-3 bg-white rounded border overflow-auto">{String(this.state.error)}</pre>
            {this.state.errorInfo && (
              <pre className="mt-3 p-3 bg-white rounded border overflow-auto">{this.state.errorInfo.componentStack}</pre>
            )}
            <div className="mt-4">
              <button
                onClick={() => {
                  try {
                    Object.keys(localStorage).forEach(k => {
                      if (k.startsWith('lfp:')) localStorage.removeItem(k);
                    });
                  } catch(e) {}
                  location.reload();
                }}
                className="px-4 py-2 rounded bg-green-600 text-white"
              >
                Reset App Storage
              </button>
            </div>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

const { useState, useEffect } = React;

const storage = {
  get(key) {
    try {
      return localStorage.getItem(key);
    } catch(e) {
      return null;
    }
  },
  set(key, value) {
    try {
      localStorage.setItem(key, value);
    } catch(e) {}
  },
  remove(key) {
    try {
      localStorage.removeItem(key);
    } catch(e) {}
  }
};

const safeParse = (json, fallback) => {
  try {
    return JSON.parse(json);
  } catch {
    return fallback;
  }
};

const STORAGE_USERS = "lfp:users";
const STORAGE_SESSION = "lfp:session";
const WORKSPACE_PREFIX = "lfp:workspace:";

function wsKey(email) {
  return WORKSPACE_PREFIX + (email || "").trim().toLowerCase();
}

const loadUsers = () => safeParse(storage.get(STORAGE_USERS), []);
const saveUsers = (users) => storage.set(STORAGE_USERS, JSON.stringify(users || []));
const loadSession = () => safeParse(storage.get(STORAGE_SESSION), null);
const saveSession = (session) => storage.set(STORAGE_SESSION, JSON.stringify(session || null));
const clearSession = () => storage.remove(STORAGE_SESSION);
const loadWorkspace = (email) => safeParse(storage.get(wsKey(email)), null);
const saveWorkspace = (email, data) => storage.set(wsKey(email), JSON.stringify(data || null));

async function sha256(text) {
  try {
    const encoder = new TextEncoder();
    const buffer = await crypto.subtle.digest("SHA-256", encoder.encode(text));
    return Array.from(new Uint8Array(buffer))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  } catch {
    return btoa(unescape(encodeURIComponent(text)));
  }
}

const emailEq = (a, b) => (a || "").trim().toLowerCase() === (b || "").trim().toLowerCase();

const VOICE_CATALOG = {
  elevenlabs: ["Alloy", "Callum", "Rachel", "Adam", "Domi"],
  openai: ["Alloy", "Verse", "Sol", "Breeze"],
  azure: ["en-US-GuyNeural", "en-US-JennyNeural", "en-US-ChristopherNeural"],
  google: ["en-US-Neural2-J", "en-US-Standard-B", "en-US-Wavenet-D"]
};

const MARKET_OPTIONS = {
  "Insurance": ["Life", "Term", "Final Expense", "Medicare", "Business Liability", "Health", "Debt Free"],
  "Real Estate": ["Buyer Leads", "Seller Leads", "Open House", "Investors", "Rentals"],
  "Solar": ["Residential", "Commercial"],
  "Home Services": ["Roofing", "HVAC", "Plumbing", "Landscaping", "Windows"],
  "Legal": ["Injury", "Disability", "Estate", "Criminal Defense"],
  "Other": ["Generic", "Event", "SaaS"]
};

const STATUS_LABELS = ["New", "Contacted", "Qualified", "Scheduled", "App Submitted", "Pending", "Approved", "Paid", "Declined"];
const STATUS_ADVANCED = new Set(["App Submitted", "Pending", "Approved", "Paid", "Declined"]);

const US_TIMEZONES = [
  { value: "America/New_York", label: "Eastern (ET)" },
  { value: "America/Chicago", label: "Central (CT)" },
  { value: "America/Denver", label: "Mountain (MT)" },
  { value: "America/Los_Angeles", label: "Pacific (PT)" },
  { value: "America/Anchorage", label: "Alaska (AKT)" },
  { value: "Pacific/Honolulu", label: "Hawaii (HST)" }
];

function seedWorkspace() {
  return {
    apiSelection: {
      voiceProvider: "elevenlabs",
      smsProvider: "twilio"
    },
    credentials: {
      openai: { apiKey: "" },
      elevenlabs: { apiKey: "" },
      azure: { subscriptionKey: "", region: "" },
      google: { jsonKey: "" },
      twilio: { accountSid: "", authToken: "", fromNumber: "" },
      messagebird: { accessKey: "", originator: "" },
      vonage: { apiKey: "", apiSecret: "", fromNumber: "" },
      meta: { accessToken: "", adAccountId: "", pageId: "", pixelId: "" }
    },
    routing: {
      callsModel: "gpt-5-mini",
      callsEscalationModel: "gpt-5",
      smsModel: "gpt-5-mini",
      adsDraftModel: "gpt-5-mini",
      adsPolishModel: "gpt-5",
      adsImageModel: "gpt-image-3.5",
      realtimeWorker: {
        maxTokens: 2000,
        timeoutMs: 8000,
        rpm: 120,
        tpm: 120000
      },
      batchWorker: {
        maxTokens: 6000,
        timeoutMs: 30000,
        rpm: 60,
        tpm: 300000
      },
      metadata: {
        call: { channel: "call" },
        sms: { channel: "sms" },
        adsCopy: { channel: "ads-copy" },
        adsImage: { channel: "ads-image" }
      }
    },
    automation: {
      autoStartOnMeta: true,
      immediateRetryOnNoAnswer: true,
      immediateRetryOnVoicemail: false
    },
    voiceSettings: {
      provider: "elevenlabs",
      voice: "Alloy",
      style: "professional",
      speed: "normal",
      callAttempts: 2,
      immediateAttempts: 1,
      callInterval: 30,
      immediateCallbackOnNoAnswer: false,
      immediateCallbackOnVoicemail: false,
      voicemailBehavior: "leave_message",
      voicemailScript: "Sorry I missed youâ€”this is LeadFlow Pro. I'll text details as well.",
      scripts: {
        generic: "Hi, this is LeadFlow Pro about your request. Do you have a minute?"
      },
      businessHours: { start: "09:00", end: "17:00" },
      workingDays: ["monday", "tuesday", "wednesday", "thursday", "friday"],
      timezone: "America/Denver"
    },
    smsSettings: {
      provider: "twilio",
      autoRespond: true,
      followUpDelay: 15,
      scripts: {
        day0: "Hey {{name}}, it's Josh â€” got your request. 2 quick questions?",
        day1: "Been trying to reach you â€” want a ballpark quote?",
        day3: "Still here when you are.",
        day5: "Final ping for now â€” want a 60-sec summary?"
      },
      scriptVariants: {
        noAnswer: "Missed you, {{name}}.",
        voicemailDrop: "Left a voicemail â€” text works great if easier."
      },
      businessHours: { start: "09:00", end: "17:00" }
    },
    data: {
      leads: [],
      campaigns: [],
      objections: [],
      analytics: { overview: {}, performance: {} },
      inbound: [],
      imports: [],
      adLab: { variants: [], images: [], rotate: false }
    }
  };
}

const isObj = (obj) => obj && typeof obj === "object" && !Array.isArray(obj);

function mergeDeep(base, patch) {
  const output = Array.isArray(base) ? base.slice() : { ...base };
  if (!patch) return output;
  
  for (const key of Object.keys(patch)) {
    const baseValue = base ? base[key] : undefined;
    const patchValue = patch[key];
    
    if (isObj(baseValue) && isObj(patchValue)) {
      output[key] = mergeDeep(baseValue, patchValue);
    } else if (Array.isArray(patchValue)) {
      output[key] = patchValue.slice();
    } else if (typeof patchValue !== "undefined") {
      output[key] = patchValue;
    }
  }
  return output;
}

function migrateWorkspace(raw) {
  const defaults = seedWorkspace();
  const merged = mergeDeep(defaults, raw || {});
  
  merged.voiceSettings.provider = merged.apiSelection.voiceProvider || "elevenlabs";
  merged.smsSettings.provider = merged.apiSelection.smsProvider || "twilio";
  
  return merged;
}

const ADMIN_EMAIL = "Joshua.kollar@me.com";
const ADMIN_PLAIN = "Allglorytogod12!";

async function ensureAdmin() {
  try {
    let users = loadUsers();
    if (!users.some(u => emailEq(u.email, ADMIN_EMAIL))) {
      const hash = await sha256(ADMIN_PLAIN);
      users.push({
        email: ADMIN_EMAIL,
        passHash: hash,
        isAdmin: true,
        locked: false,
        createdAt: new Date().toISOString(),
        lastLogin: null
      });
      saveUsers(users);
      
      if (!loadWorkspace(ADMIN_EMAIL)) {
        saveWorkspace(ADMIN_EMAIL, seedWorkspace());
      }
    }
  } catch(e) {
    console.warn("Storage unavailable; admin seeding skipped");
  }
}

function LoginView({ onLoggedIn }) {
  const [email, setEmail] = useState("");
  const [password, setPassword] = useState("");
  const [busy, setBusy] = useState(false);
  const [error, setError] = useState("");

  const login = async (e) => {
    e?.preventDefault();
    setError("");
    setBusy(true);
    
    try {
      const users = loadUsers();
      const user = users.find(x => emailEq(x.email, email));
      
      if (!user) throw new Error("Invalid email or password");
      if (user.locked) throw new Error("Account locked");
      
      const hash = await sha256(password);
      if (hash !== user.passHash) throw new Error("Invalid email or password");
      
      const updated = users.map(x => 
        emailEq(x.email, email) 
          ? { ...x, lastLogin: new Date().toISOString() }
          : x
      );
      saveUsers(updated);
      
      saveSession({ email: user.email, isAdmin: !!user.isAdmin });
      
      if (!loadWorkspace(user.email)) {
        saveWorkspace(user.email, seedWorkspace());
      }
      
      onLoggedIn({ email: user.email, isAdmin: !!user.isAdmin });
    } catch(ex) {
      setError(ex.message || "Login failed");
    } finally {
      setBusy(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6">
      <div className="card w-full max-w-md p-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white font-bold flex items-center justify-center">
            LF
          </div>
          <div>
            <div className="text-xl font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-500">Secure login</div>
          </div>
        </div>

        <div className="flex gap-2 mb-4">
          <button
            onClick={() => {
              try {
                Object.keys(localStorage).forEach(k => {
                  if (k.startsWith('lfp:')) localStorage.removeItem(k);
                });
              } catch(e) {}
              alert('âœ… Storage cleared. Sign in again.');
            }}
            className="px-3 py-2 text-sm rounded bg-gray-100"
          >
            Reset App Storage
          </button>
        </div>

        <form onSubmit={login} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input
              type="email"
              className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
              value={email}
              onChange={e => setEmail(e.target.value)}
              placeholder="you@domain.com"
              required
            />
          </div>
          
          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input
              type="password"
              className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
              value={password}
              onChange={e => setPassword(e.target.value)}
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              required
            />
          </div>

          {error && (
            <div className="text-sm text-red-600">{error}</div>
          )}

          <button
            disabled={busy}
            className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all"
          >
            {busy ? "Signing inâ€¦" : "Sign In"}
          </button>
        </form>
      </div>
    </div>
  );
}

function LeadFlowApp({ me, onLogout, onImpersonate }) {
  const [ws, setWs] = useState(null);
  const [view, setView] = useState("dashboard");
  const [editingLead, setEditingLead] = useState(null);

  useEffect(() => {
    if (me?.email) {
      const data = loadWorkspace(me.email);
      setWs(migrateWorkspace(data));
    }
  }, [me?.email]);

  const saveWs = (newWs) => {
    if (me?.email) {
      setWs(newWs);
      saveWorkspace(me.email, newWs);
    }
  };

  if (!ws) {
    return (
      <div className="min-h-screen flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin w-8 h-8 border-2 border-blue-500 border-t-transparent rounded-full mx-auto mb-4"></div>
          <div>Loading workspace...</div>
        </div>
      </div>
    );
  }

  const renderSidebar = () => (
    <div className="w-64 bg-white border-r h-screen overflow-y-auto">
      <div className="p-6 border-b">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 text-white font-bold flex items-center justify-center">
            LF
          </div>
          <div>
            <div className="font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-500">{me.email}</div>
          </div>
        </div>
      </div>

      <nav className="p-4 space-y-2">
        {[
          { id: "dashboard", label: "Dashboard", icon: "ðŸ“Š" },
          { id: "leads", label: "Lead Management", icon: "ðŸ‘¥" },
          { id: "campaigns", label: "Campaign Manager", icon: "ðŸ“¢" },
          { id: "ads", label: "Ad Creator", icon: "ðŸŽ¨" },
          { id: "inbound", label: "Inbound Center", icon: "ðŸ“ž" },
          { id: "imports", label: "Import Data", icon: "ðŸ“‚" },
          { id: "analytics", label: "Analytics", icon: "ðŸ“ˆ" },
          { id: "settings", label: "Settings", icon: "âš™ï¸" },
          ...(me.isAdmin ? [{ id: "users", label: "User Admin", icon: "ðŸ‘¤" }] : [])
        ].map(item => (
          <button
            key={item.id}
            onClick={() => setView(item.id)}
            className={`w-full text-left p-3 rounded-lg transition-colors ${
              view === item.id 
                ? "bg-blue-50 text-blue-600 border border-blue-200" 
                : "hover:bg-gray-50"
            }`}
          >
            <span className="mr-3">{item.icon}</span>
            {item.label}
          </button>
        ))}
      </nav>

      <div className="p-4 border-t mt-auto">
        <button
          onClick={onLogout}
          className="w-full p-3 text-left rounded-lg hover:bg-red-50 text-red-600"
        >
          <span className="mr-3">ðŸšª</span>
          Sign Out
        </button>
      </div>
    </div>
  );

  const renderDashboard = () => {
    const totalLeads = ws.data.leads.length;
    const paidLeads = ws.data.leads.filter(l => l.status === "Paid").length;
    const thisWeekAPV = ws.data.leads
      .filter(l => l.status === "Paid" && l.apvAmount)
      .reduce((sum, l) => sum + (parseFloat(l.apvAmount) || 0), 0);

    const shortcuts = [
      { label: "Add Lead", action: () => setView("leads"), icon: "âž•", color: "bg-green-500" },
      { label: "Create Campaign", action: () => setView("campaigns"), icon: "ðŸ“¢", color: "bg-blue-500" },
      { label: "Voice Settings", action: () => setView("settings"), icon: "ðŸŽ¤", color: "bg-purple-500" },
      { label: "SMS Config", action: () => setView("settings"), icon: "ðŸ’¬", color: "bg-orange-500" },
      { label: "Import Data", action: () => setView("imports"), icon: "ðŸ“‚", color: "bg-indigo-500" },
      { label: "Analytics", action: () => setView("analytics"), icon: "ðŸ“Š", color: "bg-pink-500" }
    ];

    return (
      <div className="p-6 space-y-6">
        <div className="flex items-center justify-between">
          <h1 className="text-2xl font-bold">Dashboard</h1>
          <div className="text-sm text-gray-500">
            Welcome back, {me.email.split('@')[0]}
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="card p-6">
            <div className="text-3xl font-bold text-blue-600">{totalLeads}</div>
            <div className="text-sm text-gray-600">Total Leads</div>
          </div>
          <div className="card p-6">
            <div className="text-3xl font-bold text-green-600">{paidLeads}</div>
            <div className="text-sm text-gray-600">Paid Clients</div>
          </div>
          <div className="card p-6">
            <div className="text-3xl font-bold text-purple-600">${thisWeekAPV.toLocaleString()}</div>
            <div className="text-sm text-gray-600">This Week APV</div>
          </div>
          <div className="card p-6">
            <div className="text-3xl font-bold text-orange-600">{ws.data.campaigns.length}</div>
            <div className="text-sm text-gray-600">Active Campaigns</div>
          </div>
        </div>

        <div className="card p-6">
          <h2 className="text-lg font-semibold mb-4">Quick Actions</h2>
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
            {shortcuts.map((shortcut, idx) => (
              <button
                key={idx}
                onClick={shortcut.action}
                className={`${shortcut.color} text-white p-4 rounded-lg hover:opacity-90 transition-opacity text-center`}
              >
                <div className="text-2xl mb-2">{shortcut.icon}</div>
                <div className="text-sm font-medium">{shortcut.label}</div>
              </button>
            ))}
          </div>
        </div>
      </div>
    );
  };

  const renderLeads = () => {
    const addLead = () => {
      const newLead = {
        id: Date.now().toString(),
        name: "",
        email: "",
        phone: "",
        market: "Insurance",
        sub: "Life",
        status: "New",
        notes: "",
        createdAt: new Date().toISOString(),
        apvAmount: "",
        insuranceCarrier: "",
        debtDetails: {
          creditCards: [],
          mortgages: [],
          cars: [],
          other: []
        },
        recordings: [],
        transcripts: []
      };
      setEditingLead(newLead);
    };

    const deleteLead = (leadId) => {
      if (confirm("Delete this lead?")) {
        const updated = { ...ws };
        updated.data.leads = updated.data.leads.filter(l => l.id !== leadId);
        saveWs(updated);
      }
    };

    return (
      <div className="p-6">
        <div className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-bold">Lead Management</h1>
          <button
            onClick={addLead}
            className="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600"
          >
            Add Lead
          </button>
        </div>

        <div className="card overflow-hidden">
          <div className="overflow-x-auto">
            <table className="w-full">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Market</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">APV</th>
                  <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {ws.data.leads.map(lead => (
                  <tr key={lead.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="font-medium">{lead.name || "Unnamed"}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm">{lead.email}</div>
                      <div className="text-sm text-gray-500">{lead.phone}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm">{lead.market}</div>
                      <div className="text-xs text-gray-500">{lead.sub}</div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`badge ${
                        lead.status === "Paid" ? "bg-green-100 text-green-800" :
                        lead.status === "Approved" ? "bg-blue-100 text-blue-800" :
                        lead.status === "Declined" ? "bg-red-100 text-red-800" :
                        "bg-gray-100 text-gray-800"
                      }`}>
                        {lead.status}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      {lead.apvAmount ? `$${parseFloat(lead.apvAmount).toLocaleString()}` : "-"}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <button
                        onClick={() => setEditingLead(lead)}
                        className="text-blue-600 hover:text-blue-800 mr-3"
                      >
                        Edit
                      </button>
                      <button
                        onClick={() => deleteLead(lead.id)}
                        className="text-red-600 hover:text-red-800"
                      >
                        Delete
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>

        {editingLead && (
          <LeadEditor
            lead={editingLead}
            onSave={(updatedLead) => {
              const updated = { ...ws };
              const existing = updated.data.leads.find(l => l.id === updatedLead.id);
              if (existing) {
                Object.assign(existing, updatedLead);
              } else {
                updated.data.leads.push(updatedLead);
              }
              saveWs(updated);
              setEditingLead(null);
            }}
            onCancel={() => setEditingLead(null)}
          />
        )}
      </div>
    );
  };

  const LeadEditor = ({ lead, onSave, onCancel }) => {
    const [formData, setFormData] = useState(lead);

    const updateField = (field, value) => {
      setFormData(prev => ({ ...prev, [field]: value }));
    };

    const addDebtItem = (category) => {
      const newItem = { amount: "", apr: "", description: "" };
      setFormData(prev => ({
        ...prev,
        debtDetails: {
          ...prev.debtDetails,
          [category]: [...(prev.debtDetails[category] || []), newItem]
        }
      }));
    };

    const updateDebtItem = (category, index, field, value) => {
      setFormData(prev => ({
        ...prev,
        debtDetails: {
          ...prev.debtDetails,
          [category]: prev.debtDetails[category].map((item, i) => 
            i === index ? { ...item, [field]: value } : item
          )
        }
      }));
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
          <div className="p-6 border-b">
            <h2 className="text-xl font-bold">
              {lead.id ? "Edit Lead" : "Add New Lead"}
            </h2>
          </div>

          <div className="p-6 space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Name</label>
                <input
                  type="text"
                  className="w-full p-3 border rounded-lg"
                  value={formData.name || ""}
                  onChange={e => updateField("name", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Email</label>
                <input
                  type="email"
                  className="w-full p-3 border rounded-lg"
                  value={formData.email || ""}
                  onChange={e => updateField("email", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Phone</label>
                <input
                  type="tel"
                  className="w-full p-3 border rounded-lg"
                  value={formData.phone || ""}
                  onChange={e => updateField("phone", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Status</label>
                <select
                  className="w-full p-3 border rounded-lg"
                  value={formData.status || "New"}
                  onChange={e => updateField("status", e.target.value)}
                >
                  {STATUS_LABELS.map(status => (
                    <option key={status} value={status}>{status}</option>
                  ))}
                </select>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Market</label>
                <select
                  className="w-full p-3 border rounded-lg"
                  value={formData.market || "Insurance"}
                  onChange={e => {
                    updateField("market", e.target.value);
                    updateField("sub", MARKET_OPTIONS[e.target.value]?.[0] || "");
                  }}
                >
                  {Object.keys(MARKET_OPTIONS).map(market => (
                    <option key={market} value={market}>{market}</option>
                  ))}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Sub Category</label>
                <select
                  className="w-full p-3 border rounded-lg"
                  value={formData.sub || ""}
                  onChange={e => updateField("sub", e.target.value)}
                >
                  {(MARKET_OPTIONS[formData.market] || []).map(sub => (
                    <option key={sub} value={sub}>{sub}</option>
                  ))}
                </select>
              </div>
            </div>

            {STATUS_ADVANCED.has(formData.status) && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">APV Amount</label>
                  <input
                    type="number"
                    className="w-full p-3 border rounded-lg"
                    value={formData.apvAmount || ""}
                    onChange={e => updateField("apvAmount", e.target.value)}
                    placeholder="0.00"
                  />
                </div>
                {formData.market === "Insurance" && (
                  <div>
                    <label className="block text-sm font-medium mb-1">Insurance Carrier</label>
                    <input
                      type="text"
                      className="w-full p-3 border rounded-lg"
                      value={formData.insuranceCarrier || ""}
                      onChange={e => updateField("insuranceCarrier", e.target.value)}
                    />
                  </div>
                )}
              </div>
            )}

            {formData.sub === "Debt Free" && (
              <div className="space-y-4">
                <h3 className="text-lg font-semibold">Debt Details</h3>
                
                {["creditCards", "mortgages", "cars", "other"].map(category => (
                  <div key={category} className="border rounded-lg p-4">
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="font-medium capitalize">
                        {category === "creditCards" ? "Credit Cards" : category}
                      </h4>
                      <button
                        onClick={() => addDebtItem(category)}
                        className="bg-blue-500 text-white px-3 py-1 rounded text-sm"
                      >
                        +
                      </button>
                    </div>
                    
                    {(formData.debtDetails?.[category] || []).map((item, index) => (
                      <div key={index} className="grid grid-cols-3 gap-2 mb-2">
                        <input
                          type="number"
                          placeholder="Amount"
                          className="p-2 border rounded"
                          value={item.amount || ""}
                          onChange={e => updateDebtItem(category, index, "amount", e.target.value)}
                        />
                        <input
                          type="number"
                          placeholder="APR %"
                          className="p-2 border rounded"
                          value={item.apr || ""}
                          onChange={e => updateDebtItem(category, index, "apr", e.target.value)}
                        />
                        <input
                          type="text"
                          placeholder="Description"
                          className="p-2 border rounded"
                          value={item.description || ""}
                          onChange={e => updateDebtItem(category, index, "description", e.target.value)}
                        />
                      </div>
                    ))}
                  </div>
                ))}
              </div>
            )}

            <div>
              <label className="block text-sm font-medium mb-1">Notes</label>
              <textarea
                className="w-full p-3 border rounded-lg"
                rows="4"
                value={formData.notes || ""}
                onChange={e => updateField("notes", e.target.value)}
                placeholder="Add notes about this lead..."
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Call Recordings</label>
                <div className="border rounded-lg p-3 min-h-[100px] bg-gray-50">
                  {formData.recordings?.length > 0 ? (
                    formData.recordings.map((recording, index) => (
                      <div key={index} className="mb-2 p-2 bg-white rounded border">
                        <div className="text-sm font-medium">{recording.date}</div>
                        <div className="text-xs text-gray-500">{recording.duration}</div>
                      </div>
                    ))
                  ) : (
                    <div className="text-gray-500 text-sm">No recordings yet</div>
                  )}
                </div>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Call Transcripts</label>
                <div className="border rounded-lg p-3 min-h-[100px] bg-gray-50">
                  {formData.transcripts?.length > 0 ? (
                    formData.transcripts.map((transcript, index) => (
                      <div key={index} className="mb-2 p-2 bg-white rounded border">
                        <div className="text-sm font-medium">{transcript.date}</div>
                        <div className="text-xs text-gray-500">{transcript.summary}</div>
                      </div>
                    ))
                  ) : (
                    <div className="text-gray-500 text-sm">No transcripts yet</div>
                  )}
                </div>
              </div>
            </div>
          </div>

          <div className="p-6 border-t flex gap-3 justify-end">
            <button
              onClick={onCancel}
              className="px-4 py-2 border rounded-lg hover:bg-gray-50"
            >
              Cancel
            </button>
            <button
              onClick={() => onSave(formData)}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600"
            >
              Save Lead
            </button>
          </div>
        </div>
      </div>
    );
  };

  const renderSettings = () => {
    const updateCredentials = (provider, field, value) => {
      const updated = { ...ws };
      if (!updated.credentials[provider]) updated.credentials[provider] = {};
      updated.credentials[provider][field] = value;
      saveWs(updated);
    };

    const updateVoiceSettings = (field, value) => {
      const updated = { ...ws };
      updated.voiceSettings[field] = value;
      saveWs(updated);
    };

    const updateSmsSettings = (field, value) => {
      const updated = { ...ws };
      updated.smsSettings[field] = value;
      saveWs(updated);
    };

    return (
      <div className="p-6 space-y-8">
        <h1 className="text-2xl font-bold">Settings</h1>

        <div className="card p-6">
          <h2 className="text-lg font-semibold mb-4">API Settings</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium mb-2">Voice Provider</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.apiSelection.voiceProvider}
                onChange={e => {
                  const updated = { ...ws };
                  updated.apiSelection.voiceProvider = e.target.value;
                  updated.voiceSettings.provider = e.target.value;
                  saveWs(updated);
                }}
              >
                <option value="elevenlabs">ElevenLabs</option>
                <option value="openai">OpenAI</option>
                <option value="azure">Azure</option>
                <option value="google">Google</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-2">SMS Provider</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.apiSelection.smsProvider}
                onChange={e => {
                  const updated = { ...ws };
                  updated.apiSelection.smsProvider = e.target.value;
                  updated.smsSettings.provider = e.target.value;
                  saveWs(updated);
                }}
              >
                <option value="twilio">Twilio</option>
                <option value="messagebird">MessageBird</option>
                <option value="vonage">Vonage</option>
              </select>
            </div>
          </div>

          <div className="mt-6 space-y-4">
            <h3 className="text-md font-medium">API Credentials</h3>
            
            <div>
              <label className="block text-sm font-medium mb-1">OpenAI API Key</label>
              <input
                type="password"
                className="w-full p-3 border rounded-lg"
                value={ws.credentials.openai?.apiKey || ""}
                onChange={e => updateCredentials("openai", "apiKey", e.target.value)}
                placeholder="sk-..."
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">ElevenLabs API Key</label>
              <input
                type="password"
                className="w-full p-3 border rounded-lg"
                value={ws.credentials.elevenlabs?.apiKey || ""}
                onChange={e => updateCredentials("elevenlabs", "apiKey", e.target.value)}
                placeholder="..."
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Twilio Account SID</label>
                <input
                  type="password"
                  className="w-full p-3 border rounded-lg"
                  value={ws.credentials.twilio?.accountSid || ""}
                  onChange={e => updateCredentials("twilio", "accountSid", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Twilio Auth Token</label>
                <input
                  type="password"
                  className="w-full p-3 border rounded-lg"
                  value={ws.credentials.twilio?.authToken || ""}
                  onChange={e => updateCredentials("twilio", "authToken", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">From Number</label>
                <input
                  type="text"
                  className="w-full p-3 border rounded-lg"
                  value={ws.credentials.twilio?.fromNumber || ""}
                  onChange={e => updateCredentials("twilio", "fromNumber", e.target.value)}
                  placeholder="+1234567890"
                />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Meta Access Token</label>
                <input
                  type="password"
                  className="w-full p-3 border rounded-lg"
                  value={ws.credentials.meta?.accessToken || ""}
                  onChange={e => updateCredentials("meta", "accessToken", e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Ad Account ID</label>
                <input
                  type="text"
                  className="w-full p-3 border rounded-lg"
                  value={ws.credentials.meta?.adAccountId || ""}
                  onChange={e => updateCredentials("meta", "adAccountId", e.target.value)}
                />
              </div>
            </div>
          </div>
        </div>

        <div className="card p-6">
          <h2 className="text-lg font-semibold mb-4">Voice AI Configuration</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium mb-1">Voice Selection</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.voice}
                onChange={e => updateVoiceSettings("voice", e.target.value)}
              >
                {(VOICE_CATALOG[ws.voiceSettings.provider] || []).map(voice => (
                  <option key={voice} value={voice}>{voice}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Time Zone</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.timezone}
                onChange={e => updateVoiceSettings("timezone", e.target.value)}
              >
                {US_TIMEZONES.map(tz => (
                  <option key={tz.value} value={tz.value}>{tz.label}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Call Attempts</label>
              <input
                type="number"
                min="1"
                max="5"
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.callAttempts}
                onChange={e => updateVoiceSettings("callAttempts", parseInt(e.target.value))}
              />
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Immediate Attempts</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.immediateAttempts}
                onChange={e => updateVoiceSettings("immediateAttempts", parseInt(e.target.value))}
              >
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Time Between Calls</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.callInterval}
                onChange={e => updateVoiceSettings("callInterval", parseInt(e.target.value))}
              >
                <option value="15">15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="1440">1 day</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Voicemail Behavior</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.voiceSettings.voicemailBehavior}
                onChange={e => updateVoiceSettings("voicemailBehavior", e.target.value)}
              >
                <option value="hang_up">Hang Up</option>
                <option value="leave_message">Leave Message</option>
              </select>
            </div>
          </div>

          <div className="mt-6">
            <h3 className="text-md font-medium mb-3">Voice Scripts</h3>
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-1">Generic Script</label>
                <textarea
                  className="w-full p-3 border rounded-lg"
                  rows="3"
                  value={ws.voiceSettings.scripts?.generic || ""}
                  onChange={e => updateVoiceSettings("scripts", { 
                    ...ws.voiceSettings.scripts, 
                    generic: e.target.value 
                  })}
                  placeholder="Hi, this is LeadFlow Pro about your request..."
                />
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Voicemail Script</label>
                <textarea
                  className="w-full p-3 border rounded-lg"
                  rows="3"
                  value={ws.voiceSettings.voicemailScript || ""}
                  onChange={e => updateVoiceSettings("voicemailScript", e.target.value)}
                  placeholder="Sorry I missed youâ€”this is LeadFlow Pro..."
                />
              </div>
            </div>
          </div>
        </div>

        <div className="card p-6">
          <h2 className="text-lg font-semibold mb-4">SMS Configuration</h2>
          
          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium mb-1">Follow-up Delay</label>
              <select
                className="w-full p-3 border rounded-lg"
                value={ws.smsSettings.followUpDelay}
                onChange={e => updateSmsSettings("followUpDelay", parseInt(e.target.value))}
              >
                <option value="15">15 minutes</option>
                <option value="60">1 hour</option>
                <option value="1440">1 day</option>
                <option value="2880">2 days</option>
                <option value="10080">1 week</option>
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium mb-1">Auto Respond</label>
              <div
                className={`toggle-switch ${ws.smsSettings.autoRespond ? "active" : ""}`}
                onClick={() => updateSmsSettings("autoRespond", !ws.smsSettings.autoRespond)}
              >
                <div className="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div className="mt-6">
            <h3 className="text-md font-medium mb-3">SMS Scripts</h3>
            <div className="space-y-4">
              {Object.entries(ws.smsSettings.scripts || {}).map(([key, script]) => (
                <div key={key}>
                  <label className="block text-sm font-medium mb-1 capitalize">
                    {key.replace(/([A-Z])/g, ' $1').trim()}
                  </label>
                  <textarea
                    className="w-full p-3 border rounded-lg"
                    rows="2"
                    value={script}
                    onChange={e => updateSmsSettings("scripts", {
                      ...ws.smsSettings.scripts,
                      [key]: e.target.value
                    })}
                  />
                </div>
              ))}
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderCurrentView = () => {
    switch (view) {
      case "dashboard":
        return renderDashboard();
      case "leads":
        return renderLeads();
      case "settings":
        return renderSettings();
      default:
        return (
          <div className="p-6 text-center">
            <h1 className="text-2xl font-bold mb-4">Feature Coming Soon</h1>
            <p className="text-gray-600">This feature is under development.</p>
          </div>
        );
    }
  };

  return (
    <div className="flex h-screen bg-gray-50">
      {renderSidebar()}
      <div className="flex-1 overflow-y-auto">
        {renderCurrentView()}
      </div>
    </div>
  );
}

function AppWrapper() {
  const [me, setMe] = useState(null);

  useEffect(() => {
    (async () => {
      await ensureAdmin();
      const session = loadSession();
      if (session) {
        setMe(session);
      }
    })();
  }, []);

  if (!me) {
    return React.createElement(LoginView, {
      onLoggedIn: setMe
    });
  }

  const logout = () => {
    clearSession();
    setMe(null);
  };

  const impersonate = (email) => {
    const users = loadUsers();
    const user = users.find(x => emailEq(x.email, email));
    if (!user) return;
    
    setMe({
      email: user.email,
      isAdmin: !!user.isAdmin
    });
  };

  return React.createElement(LeadFlowApp, {
    me,
    onLogout: logout,
    onImpersonate: impersonate
  });
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(
  React.createElement(ErrorBoundary, null,
    React.createElement(AppWrapper, null)
  )
);
</script>
</body>
</html>
