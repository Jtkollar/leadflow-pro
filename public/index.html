<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeadFlow Pro â€” Rescue Build</title>
  <!-- React + Babel + Tailwind + Font -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card{ background:white; border-radius:16px; box-shadow:0 10px 20px rgba(0,0,0,.06); }
    .badge{ padding:2px 8px; border-radius:999px; font-size:12px; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
  <div id="root"></div>

<script type="text/babel">
const {useState,useEffect,useMemo} = React;

/* =========================
   STORAGE / SESSION
   ========================= */
const STORAGE_USERS='lfp:users';
const STORAGE_SESSION='lfp:session';
const WORKSPACE_PREFIX='lfp:workspace:';
function emailEq(a,b){ return (a||'').trim().toLowerCase()===(b||'').trim().toLowerCase(); }
function loadUsers(){ try{return JSON.parse(localStorage.getItem(STORAGE_USERS))||[]}catch{ return[] } }
function saveUsers(u){ localStorage.setItem(STORAGE_USERS, JSON.stringify(u)); }
function loadSession(){ try{return JSON.parse(localStorage.getItem(STORAGE_SESSION))}catch{ return null } }
function saveSession(s){ localStorage.setItem(STORAGE_SESSION, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(STORAGE_SESSION); }
function wsKey(email){ return WORKSPACE_PREFIX + (email||'').toLowerCase(); }
function loadWorkspace(email){ try{ return JSON.parse(localStorage.getItem(wsKey(email)))||null }catch{ return null } }
function saveWorkspace(email,data){ localStorage.setItem(wsKey(email), JSON.stringify(data)); }
async function sha256(text){
  try{ const buf=await crypto.subtle.digest('SHA-256', new TextEncoder().encode(text));
       return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join(''); }
  catch{ return btoa(unescape(encodeURIComponent(text))); }
}

/* =========================
   HELPERS (dates & merge)
   ========================= */
function startOfWeek(d){ const x=new Date(d); const day=(x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function startOfMonth(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setDate(1); return x; }
function startOfYear(d){ const x=new Date(d); x.setHours(0,0,0,0); x.setMonth(0,1); return x; }

function mergeDefaults(base, incoming) {
  if (incoming == null) return JSON.parse(JSON.stringify(base));
  if (Array.isArray(base)) return Array.isArray(incoming) ? incoming : base;
  if (typeof base !== 'object' || base === null) return incoming ?? base;
  const out = { ...base };
  for (const k of Object.keys(base)) {
    const b = base[k]; const i = incoming[k];
    if (b && typeof b === 'object' && !Array.isArray(b)) out[k] = mergeDefaults(b, i ?? {});
    else out[k] = (i === undefined ? b : i);
  }
  for (const k of Object.keys(incoming)) if (out[k] === undefined) out[k] = incoming[k];
  return out;
}

/* =========================
   SEED (sample workspace)
   ========================= */
const ADMIN_EMAIL='Joshua.kollar@me.com';
const ADMIN_PLAIN='Allglorytogod12!';

async function ensureAdmin(){
  let users=loadUsers();
  if (!users.some(u=>emailEq(u.email,ADMIN_EMAIL))){
    users.push({ email:ADMIN_EMAIL, passHash:await sha256(ADMIN_PLAIN), isAdmin:true, locked:false, createdAt:new Date().toISOString(), lastLogin:null });
    saveUsers(users);
  }
  if (!loadWorkspace(ADMIN_EMAIL)) saveWorkspace(ADMIN_EMAIL, seedWorkspace());
}

function seedWorkspace(){
  const now = new Date();
  const w0 = startOfWeek(now), m0 = startOfMonth(now), y0 = startOfYear(now);
  // helper for random dates this year
  const daysAgo = n => { const d=new Date(now); d.setDate(d.getDate()-n); return d.toISOString(); };

  return {
    apiKeys:{ openai:'', meta:'', elevenlabs:'', twilio:'', smsFrom:'', voiceFrom:'' },
    settings:{},
    data:{
      leads:[
        { id:1, name:'Alex Morgan', phone:'(555) 123-4567', email:'alex@example.com', market:'Insurance', type:'Life', location:'ID', createdAt: daysAgo(2), status:'New',     statusUpdatedAt: daysAgo(2) },
        { id:2, name:'Sam Taylor',   phone:'(555) 987-6543', email:'sam@example.com',  market:'Insurance', type:'Term', location:'TX', createdAt: daysAgo(1), status:'Scheduled', statusUpdatedAt: daysAgo(0) },
        { id:3, name:'Jordan Lee',   phone:'',               email:'',                 market:'Insurance', type:'Final Expense', location:'AL', createdAt: daysAgo(9), status:'Contacted', statusUpdatedAt: daysAgo(6) },
        { id:4, name:'Chris Park',   phone:'(555) 222-0099', email:'chris@ex.com',     market:'Insurance', type:'Life', location:'FL', createdAt: daysAgo(10), status:'Paid', statusUpdatedAt: daysAgo(1), apv: 820 },
        { id:5, name:'Dana Wu',      phone:'(555) 888-7777', email:'dana@ex.com',      market:'Insurance', type:'Term', location:'CA', createdAt: daysAgo(25), status:'Paid', statusUpdatedAt: daysAgo(20), apv: 640 },
      ],
      // Simple ad spend ledger (date, amount)
      adSpends:[
        { at: daysAgo(1),  amount: 75 },
        { at: daysAgo(3),  amount: 90 },
        { at: daysAgo(8),  amount: 120 },
        { at: daysAgo(15), amount: 110 },
        { at: daysAgo(40), amount: 95 }
      ]
    }
  };
}

/* =========================
   LOGIN
   ========================= */
function LoginView({onLoggedIn}){
  const [email,setEmail]=useState(''); const [password,setPassword]=useState(''); const [err,setErr]=useState('');
  const [busy,setBusy]=useState(false);

  const login=async(e)=>{
    e?.preventDefault();
    setErr(''); setBusy(true);
    try{
      const users=loadUsers();
      const u=users.find(x=>emailEq(x.email,email));
      if(!u) throw new Error('Invalid email or password');
      if(u.locked) throw new Error('Account locked');
      const hash=await sha256(password);
      if(hash!==u.passHash) throw new Error('Invalid email or password');
      saveUsers(users.map(x=>emailEq(x.email,u.email)?{...x,lastLogin:new Date().toISOString()}:x));
      saveSession({email:u.email,isAdmin:!!u.isAdmin});
      if(!loadWorkspace(u.email)) saveWorkspace(u.email, seedWorkspace());
      onLoggedIn({email:u.email,isAdmin:!!u.isAdmin});
    }catch(ex){ setErr(ex.message||'Login failed'); }
    finally{ setBusy(false); }
  };

  return (
    <div className="min-h-screen flex items-center justify-center p-6">
      <div className="card w-full max-w-md p-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white font-bold flex items-center justify-center">LF</div>
          <div>
            <div className="text-xl font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-500">Secure login</div>
          </div>
        </div>
        <form onSubmit={login} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input type="email" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@domain.com" required/>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input type="password" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={password} onChange={e=>setPassword(e.target.value)} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/>
          </div>
          {err && <div className="text-sm text-red-600">{err}</div>}
          <button disabled={busy} className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">{busy?'Signing inâ€¦':'Sign In'}</button>
        </form>
      </div>
    </div>
  );
}

/* =========================
   APP (Rescue baseline)
   ========================= */
function LeadFlowApp({me,onLogout}){
  const ws = mergeDefaults(seedWorkspace(), loadWorkspace(me.email));
  const [leads,setLeads]=useState(ws.data.leads||[]);
  const [adSpends,setAdSpends]=useState(ws.data.adSpends||[]);
  const saveNow=()=> saveWorkspace(me.email,{...ws,data:{leads,adSpends}});

  // ---- METRICS (your requested logic) ----
  const now = new Date();
  const w0 = startOfWeek(now), m0 = startOfMonth(now), y0 = startOfYear(now);
  const isIn = (iso, from)=> (iso && new Date(iso) >= from);

  const OPEN_SET = new Set(['New','Contacted','Qualified']);

  const totalOpenLeads = leads.filter(l=>OPEN_SET.has(l.status)).length;

  const paidThisWeek  = leads.filter(l=>l.status==='Paid' && isIn(l.statusUpdatedAt, w0)).length;
  const paidThisMonth = leads.filter(l=>l.status==='Paid' && isIn(l.statusUpdatedAt, m0)).length;

  const scheduledToday = leads.filter(l=>l.status==='Scheduled' && new Date(l.statusUpdatedAt||l.createdAt).toDateString()===now.toDateString()).length;
  const scheduledThisWeek  = leads.filter(l=>l.status==='Scheduled' && isIn(l.statusUpdatedAt||l.createdAt, w0)).length;
  const scheduledThisMonth = leads.filter(l=>l.status==='Scheduled' && isIn(l.statusUpdatedAt||l.createdAt, m0)).length;

  const spendThisWeek  = adSpends.filter(s=>isIn(s.at, w0)).reduce((a,b)=>a+b.amount,0);
  const spendThisMonth = adSpends.filter(s=>isIn(s.at, m0)).reduce((a,b)=>a+b.amount,0);
  const spendThisYear  = adSpends.filter(s=>isIn(s.at, y0)).reduce((a,b)=>a+b.amount,0);

  const leadsThisWeek  = leads.filter(l=>isIn(l.createdAt, w0)).length;
  const leadsThisMonth = leads.filter(l=>isIn(l.createdAt, m0)).length;
  const leadsThisYear  = leads.filter(l=>isIn(l.createdAt, y0)).length;

  const conv = (paid,total)=> total? Math.round((paid/total)*100):0;
  const convWeek  = conv(leads.filter(l=>l.status==='Paid' && isIn(l.statusUpdatedAt, w0)).length,  leadsThisWeek);
  const convMonth = conv(leads.filter(l=>l.status==='Paid' && isIn(l.statusUpdatedAt, m0)).length, leadsThisMonth);
  const convYear  = conv(leads.filter(l=>l.status==='Paid' && isIn(l.statusUpdatedAt, y0)).length,  leadsThisYear);

  // ---- UI ----
  return (
    <div className="min-h-screen">
      <div className="flex">
        {/* Sidebar */}
        <aside className="hidden lg:block w-72 p-6 bg-white/90 backdrop-blur shadow-xl">
          <div className="flex items-center gap-3 mb-8 pb-4 border-b">
            <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl text-white font-bold flex items-center justify-center">LF</div>
            <div>
              <div className="font-bold">LeadFlow Pro</div>
              <div className="text-xs text-gray-600">{me.email}</div>
            </div>
          </div>
          <nav className="space-y-2">
            <div className="px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow">ğŸ“Š Dashboard</div>
            <button onClick={onLogout} className="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 text-red-600">ğŸšª Logout</button>
          </nav>
        </aside>

        {/* Main */}
        <main className="flex-1 p-4 lg:p-8">
          <header className="mb-8">
            <h1 className="text-3xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent">Dashboard Overview</h1>
            <p className="text-sm text-gray-600">Real-time metrics computed from your lead + spend data.</p>
          </header>

          {/* === Requested Widgets === */}
          <section className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 lg:gap-6 mb-6">
            <!-- OPEN LEADS -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-blue-500 to-blue-600 text-white">
              <div className="text-2xl">ğŸ‘¥</div>
              <div className="text-3xl font-bold mt-2">{totalOpenLeads}</div>
              <div className="text-sm opacity-90">Total Open Leads (New, Contacted, Qualified)</div>
            </div>

            <!-- PAID THIS WEEK -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-emerald-500 to-emerald-600 text-white">
              <div className="text-2xl">âœ…</div>
              <div className="text-3xl font-bold mt-2">{paidThisWeek}</div>
              <div className="text-sm opacity-90">Total Leads Paid This Week</div>
            </div>

            <!-- PAID THIS MONTH -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-teal-500 to-teal-600 text-white">
              <div className="text-2xl">ğŸ’¸</div>
              <div className="text-3xl font-bold mt-2">{paidThisMonth}</div>
              <div className="text-sm opacity-90">Total Leads Paid This Month</div>
            </div>

            <!-- SCHEDULED TODAY -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-purple-500 to-purple-600 text-white">
              <div className="text-2xl">ğŸ“…</div>
              <div className="text-3xl font-bold mt-2">{scheduledToday}</div>
              <div className="text-sm opacity-90">Scheduled Today</div>
            </div>

            <!-- SCHEDULED THIS WEEK -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-indigo-500 to-indigo-600 text-white">
              <div className="text-2xl">ğŸ—“ï¸</div>
              <div className="text-3xl font-bold mt-2">{scheduledThisWeek}</div>
              <div className="text-sm opacity-90">Scheduled This Week</div>
            </div>

            <!-- SCHEDULED THIS MONTH -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-fuchsia-500 to-fuchsia-600 text-white">
              <div className="text-2xl">ğŸ“†</div>
              <div className="text-3xl font-bold mt-2">{scheduledThisMonth}</div>
              <div className="text-sm opacity-90">Scheduled This Month</div>
            </div>

            <!-- AD SPEND WEEK -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-amber-500 to-amber-600 text-white">
              <div className="text-2xl">ğŸ’°</div>
              <div className="text-3xl font-bold mt-2">${spendThisWeek.toLocaleString()}</div>
              <div className="text-sm opacity-90">Ad Spend This Week</div>
            </div>

            <!-- AD SPEND MONTH -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-orange-500 to-orange-600 text-white">
              <div className="text-2xl">ğŸ“ˆ</div>
              <div className="text-3xl font-bold mt-2">${spendThisMonth.toLocaleString()}</div>
              <div className="text-sm opacity-90">Ad Spend This Month</div>
            </div>

            <!-- AD SPEND YEAR -->
            <div className="p-5 rounded-2xl bg-gradient-to-br from-rose-500 to-rose-600 text-white">
              <div className="text-2xl">ğŸ¦</div>
              <div className="text-3xl font-bold mt-2">${spendThisYear.toLocaleString()}</div>
              <div className="text-sm opacity-90">Ad Spend This Year</div>
            </div>

            <!-- CONVERSION WEEK -->
            <div className="p-5 rounded-2xl bg-white">
              <div className="text-2xl">ğŸ”„</div>
              <div className="text-3xl font-bold mt-2">{convWeek}%</div>
              <div className="text-sm text-gray-600">Conversion Rate This Week</div>
            </div>

            <!-- CONVERSION MONTH -->
            <div className="p-5 rounded-2xl bg-white">
              <div className="text-2xl">ğŸ“Š</div>
              <div className="text-3xl font-bold mt-2">{convMonth}%</div>
              <div className="text-sm text-gray-600">Conversion Rate This Month</div>
            </div>

            <!-- CONVERSION YEAR -->
            <div className="p-5 rounded-2xl bg-white">
              <div className="text-2xl">ğŸ—“</div>
              <div className="text-3xl font-bold mt-2">{convYear}%</div>
              <div className="text-sm text-gray-600">Conversion Rate This Year</div>
            </div>
          </section>

          {/* Simple table so you can see data driving the numbers */}
          <section className="card p-6">
            <div className="flex items-center justify-between mb-4">
              <h3 className="text-lg font-semibold">Leads (sample data)</h3>
              <button
                onClick={()=>{ saveNow(); alert('Saved locally'); }}
                className="px-3 py-2 rounded-lg bg-gradient-to-r from-blue-500 to-purple-600 text-white">
                ğŸ’¾ Save
              </button>
            </div>
            <div className="overflow-auto">
              <table className="min-w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left">Name</th>
                    <th className="px-3 py-2 text-left">Status</th>
                    <th className="px-3 py-2 text-left">Created</th>
                    <th className="px-3 py-2 text-left">Updated</th>
                    <th className="px-3 py-2 text-left">APV</th>
                  </tr>
                </thead>
                <tbody>
                  {leads.map(l=>(
                    <tr key={l.id} className="border-t">
                      <td className="px-3 py-2">{l.name}</td>
                      <td className="px-3 py-2">
                        <span className={`badge ${l.status==='Paid'?'bg-green-100 text-green-800':
                                                  l.status==='Scheduled'?'bg-purple-100 text-purple-800':
                                                  l.status==='Contacted'?'bg-orange-100 text-orange-800':
                                                  l.status==='New'?'bg-blue-100 text-blue-800':'bg-gray-100 text-gray-800'}`}>
                          {l.status}
                        </span>
                      </td>
                      <td className="px-3 py-2">{new Date(l.createdAt).toLocaleString()}</td>
                      <td className="px-3 py-2">{new Date(l.statusUpdatedAt||l.createdAt).toLocaleString()}</td>
                      <td className="px-3 py-2">{l.apv? `$${l.apv}`:'â€”'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
            <p className="text-xs text-gray-500 mt-3">Tip: â€œOpen Leadsâ€ counts statuses New/Contacted/Qualified only. Conversion is Paid Ã· Leads created in that period.</p>
          </section>
        </main>
      </div>
    </div>
  );
}

/* =========================
   WRAPPER
   ========================= */
function AppWrapper(){
  const [me,setMe]=useState(null);
  useEffect(()=>{ (async()=>{ await ensureAdmin(); const sess=loadSession(); if(sess) setMe(sess); })(); },[]);
  if(!me) return <LoginView onLoggedIn={setMe}/>;
  return <LeadFlowApp me={me} onLogout={()=>{ clearSession(); setMe(null); }}/>;
}

/* =========================
   MOUNT
   ========================= */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AppWrapper/>);
</script>
</body>
</html>
