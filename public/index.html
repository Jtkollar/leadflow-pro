<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeadFlow Pro — Multi-Tenant</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn .35s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
    .toggle-switch { position: relative; width: 48px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background .2s; }
    .toggle-switch.active { background: #667eea; }
    .toggle-slider { position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .2s; }
    .toggle-switch.active .toggle-slider { transform: translateX(24px); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .card { background: white; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    code.inline { background:#f9fafb; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

/* =========================
   PERSISTENCE / AUTH
   ========================= */
const STORAGE_USERS = 'lfp:users';
const STORAGE_SESSION = 'lfp:session';
const WORKSPACE_PREFIX = 'lfp:workspace:'; // + email

const ADMIN_EMAIL = 'Joshua.kollar@me.com';
const ADMIN_PLAIN = 'Allglorytogod12!';

async function sha256(text){
  try{
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  } catch { return btoa(unescape(encodeURIComponent(text))); }
}
function emailEq(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }

function loadUsers(){ try { return JSON.parse(localStorage.getItem(STORAGE_USERS)) || []; } catch { return []; } }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function loadSession(){ try { return JSON.parse(localStorage.getItem(STORAGE_SESSION)); } catch { return null; } }
function saveSession(sess){ localStorage.setItem(STORAGE_SESSION, JSON.stringify(sess)); }
function clearSession(){ localStorage.removeItem(STORAGE_SESSION); }
function wsKey(email){ return WORKSPACE_PREFIX + (email||'').trim().toLowerCase(); }
function loadWorkspace(email){ try{ return JSON.parse(localStorage.getItem(wsKey(email))) || null; } catch { return null; } }
function saveWorkspace(email, data){ localStorage.setItem(wsKey(email), JSON.stringify(data)); }

async function ensureAdmin(){
  let users = loadUsers();
  const hasAdmin = users.some(u => emailEq(u.email, ADMIN_EMAIL));
  if (!hasAdmin){
    const hash = await sha256(ADMIN_PLAIN);
    users.push({ email: ADMIN_EMAIL, passHash: hash, isAdmin: true, locked: false, createdAt: new Date().toISOString(), lastLogin: null });
    saveUsers(users);
    if (!loadWorkspace(ADMIN_EMAIL)){ saveWorkspace(ADMIN_EMAIL, seedWorkspace()); }
  }
}

/* =========================
   CATALOGS / CONSTANTS
   ========================= */
const VOICE_CATALOG = {
  elevenlabs: ['Alloy','Callum','Rachel','Adam','Domi'],
  openai:     ['Alloy','Verse','Sol','Breeze'],
  azure:      ['en-US-GuyNeural','en-US-JennyNeural','en-US-ChristopherNeural'],
  google:     ['en-US-Neural2-J','en-US-Standard-B','en-US-Wavenet-D']
};

const US_TZ = [
  { id: 'America/New_York', label: 'US/Eastern' },
  { id: 'America/Chicago', label: 'US/Central' },
  { id: 'America/Denver', label: 'US/Mountain' },
  { id: 'America/Los_Angeles', label: 'US/Pacific' },
  { id: 'America/Anchorage', label: 'US/Alaska' },
  { id: 'Pacific/Honolulu', label: 'US/Hawaii' }
];

// Markets with capitalized names + subs (added Debt Free under Insurance)
const MARKET_OPTIONS = {
  "Insurance":    ['Life','Term','Final Expense','Medicare','Business Liability','Health','Debt Free'],
  "Real Estate":  ['Buyer Leads','Seller Leads','Open House','Investors','Rentals'],
  "Solar":        ['Residential','Commercial'],
  "Home Services":['Roofing','HVAC','Plumbing','Landscaping','Windows'],
  "Legal":        ['Injury','Disability','Estate','Criminal Defense'],
  "Other":        ['Generic','Event','SaaS']
};

// Statuses: include extended pipeline
const STATUS_LABELS = [
  'New','Contacted','Qualified','Scheduled',
  'App Submitted','Pending','Approved','Paid','Declined'
];
const STATUS_ADVANCED = new Set(['App Submitted','Pending','Approved','Paid','Declined']);

// dashboard APV counts use leads with apv>0 (often Approved/Paid)

/* =========================
   PROMPT EXAMPLES (unchanged)
   ========================= */
const PROMPT_TEMPLATES = {
  "Insurance": {
    "Life": [
      { h:"Protect Your Family—Rates Most People Miss", c:"Quick 60-sec quote for {{CITY}} families. Lock in coverage before rates move again. No exam options available.", cta:"get-quote" },
      { h:"$250k Life Coverage from {{LOW_PRICE}}/mo*", c:"Compare top carriers in {{STATE}}. Licensed agent, no pushy sales. Reply YES for 2-question pre-qual.", cta:"learn-more" }
    ],
    "Term": [
      { h:"Term Life, No Guesswork", c:"Pick 10/20/30 year terms that fit your budget. See your best rate in under a minute.", cta:"get-quote" }
    ],
    "Final Expense": [
      { h:"Help Cover Final Costs—Fixed Rates", c:"Plans for 50–85 in {{STATE}}. No medical exam. See your options now—peace of mind for loved ones.", cta:"get-quote" }
    ],
    "Medicare": [
      { h:"Medicare Savings You Might Be Missing", c:"Local help in {{CITY}}. Check extra benefits in minutes. No obligation, just clarity.", cta:"learn-more" }
    ],
    "Business Liability":[
      { h:"Protect Your Business From The Unknown", c:"Instant COIs, flexible monthly plans. See what similar {{INDUSTRY}} pay in {{STATE}}.", cta:"get-quote" }
    ],
    "Health":[
      { h:"Lower Your Health Premium—Same Doctors", c:"Check ACA and private options fast. Many qualify for $0 plans. Find out in 60 seconds.", cta:"apply-now" }
    ],
    "Debt Free":[
      { h:"Erase High-APR Debt Faster", c:"Free plan for {{CITY}} families: consolidate + protect. See how much interest you can save.", cta:"learn-more" }
    ]
  },
  "Real Estate": {
    "Buyer Leads": [{ h:"New Listings in {{CITY}}—Before They Hit Zillow", c:"Free daily list of homes under {{PRICE}}. Tap for instant alerts.", cta:"learn-more" }],
    "Seller Leads": [{ h:"See What Your {{CITY}} Home Could Sell For", c:"No-obligation price in 60 secs. Real comps + AI trends.", cta:"learn-more" }],
    "Open House":  [{ h:"Open House This Weekend—VIP Early Access", c:"Skip the line, get agent notes + bonus photos. RSVP.", cta:"apply-now" }],
    "Investors":   [{ h:"Off-Market Deals in {{CITY}}", c:"Weekly cash-flowing properties with ARV & rent comps.", cta:"learn-more" }],
    "Rentals":     [{ h:"Hot Rentals, No Junk", c:"Hand-picked under {{PRICE}} in {{CITY}}. Text your must-haves.", cta:"call-now" }]
  },
  "Solar": {
    "Residential":[{ h:"Slash Your Power Bill—Home Solar in {{CITY}}", c:"Check incentives. $0 down options, 25-yr warranty.", cta:"learn-more" }],
    "Commercial":[{ h:"Lower Operating Costs with Commercial Solar", c:"ROI often under 5 yrs. Get a 10-min savings check.", cta:"apply-now" }]
  },
  "Home Services": {
    "Roofing":[{ h:"Storm Damage? Free Roof Check Today", c:"Local crew—photos, quote, insurance help. Limited slots.", cta:"call-now" }],
    "HVAC":[{ h:"A/C Not Keeping Up?", c:"Same-day service. Transparent pricing, 5-star techs.", cta:"call-now" }],
    "Plumbing":[{ h:"Emergency Plumber—We’re 20 Minutes Away", c:"No trip fee today. Text a pic for instant estimate.", cta:"call-now" }],
    "Landscaping":[{ h:"Curb Appeal, Done for You", c:"Weekly plans that fit your budget. Free design consult.", cta:"get-quote" }],
    "Windows":[{ h:"Energy Bill Too High?", c:"High-efficiency windows with seasonal discounts.", cta:"learn-more" }]
  },
  "Legal": {
    "Injury":[{ h:"Injured? Don’t Settle for Less", c:"Free case check. Pay nothing unless you win.", cta:"call-now" }],
    "Disability":[{ h:"Denied SSDI? Appeal Help", c:"We handle filings and deadlines. Free review.", cta:"learn-more" }],
    "Estate":[{ h:"Easy Wills & Trusts (Flat Fee)", c:"Attorney-drafted in days, not months.", cta:"apply-now" }],
    "Criminal Defense":[{ h:"Charged? Get a Plan by Tonight", c:"Urgent consults 24/7. Confidential.", cta:"call-now" }]
  },
  "Other": {
    "Generic":[{ h:"Get the Exact Thing You Need—Fast", c:"Tell us your goal; we’ll tailor the plan.", cta:"learn-more" }],
    "Event":[{ h:"Seats Are Going—Grab Yours", c:"Early registration bonus ends soon.", cta:"apply-now" }],
    "SaaS":[{ h:"Automate the Boring Stuff", c:"Teams cut busywork 40% with our app.", cta:"learn-more" }]
  }
};

/* =========================
   DEFAULT WORKSPACE
   ========================= */
function seedWorkspace(){
  return {
    apiKeys: { openai:'', meta:'', elevenlabs:'', twilio:'', smsFrom:'', voiceFrom:'' },
    routing: {
      callsModel: 'gpt-5-mini',
      callsEscalationModel: 'gpt-5',
      smsModel: 'gpt-5-mini',
      adsDraftModel: 'gpt-5-mini',
      adsPolishModel: 'gpt-5',
      adsImageModel: 'gpt-image-3.5',
      realtimeWorker: { maxTokens: 2000, timeoutMs: 8000, rpm: 120, tpm: 120000 },
      batchWorker:    { maxTokens: 6000, timeoutMs: 30000, rpm: 60,  tpm: 300000 },
      metadata: {
        call:     { channel: 'call' },
        sms:      { channel: 'sms' },
        adsCopy:  { channel: 'ads-copy' },
        adsImage: { channel: 'ads-image' },
      }
    },
    automation: {
      autoStartOnMeta: true,
      immediateRetryOnNoAnswer: true,
      immediateRetryOnVoicemail: false
    },
    voiceSettings: {
      provider: 'elevenlabs',
      voice: 'Alloy',
      style: 'professional',
      speed: 'normal',
      callAttempts: 2,
      callInterval: 30, // minutes; 1440 enabled in UI
      immediateCallbackOnNoAnswer: false,
      immediateCallbackOnVoicemail: false,
      voicemailBehavior: 'leave_message', // 'hangup'|'leave_message'
      voicemailScript: 'Sorry I missed you—this is LeadFlow Pro following up. I’ll text details, and you can call or text back anytime.',
      scripts: {
        generic: 'Hi, this is LeadFlow Pro about your request. Do you have a minute?',
        life: 'Hi, reaching out about your life insurance request. Do you have a minute now?',
        term: 'Hi, your term quote is ready—can I walk you through options?',
 (cd "$(git rev-parse --show-toplevel)" && git apply --3way <<'EOF' 
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -209,53 +209,53 @@ function seedWorkspace(){
         finalExpense: 'Hi, following up on your final expense inquiry. Quick questions?',
         medicare: 'Hi there, calling about your Medicare coverage questions. Is now good?'
       },
       businessHours: { start:'09:00', end:'17:00' },
       workingDays: ['monday','tuesday','wednesday','thursday','friday'],
       timezone: 'America/Denver' // Mountain default
     },
     smsSettings: {
       provider: 'twilio',
       autoRespond: true,
       followUpDelay: 15, // minutes; UI includes 1-2 days & next week
       scripts: {
         day0: 'Hey {{name}}, it’s Josh. Got your request—2 quick questions for your quote. Got a minute?',
         day1: 'Been trying to reach you about your request. Want me to text a ballpark quote?',
         day3: 'Still here when you are—want coverage options that fit your budget?',
         day5: 'Final ping for now. Want me to send a 60-sec summary?'
       },
       scriptVariants: {
         noAnswer: 'Missed you, {{name}}. Try again shortly or later today?',
         voicemailDrop: 'Left a voicemail. Text works great if easier—what time can I call?'
       },
       businessHours: { start:'09:00', end:'17:00' }
     },
     data: {
       leads: [
-        { id: 1, market:'Insurance', type:'Life', source:'Manual', name:'Alex Morgan', phone:'(555) 123-4567', email:'alex@example.com', status:'New', location:'ID', time:'Today 10:15 AM', notes:'Wants quick quote', isClient:false, callLogs:[] },
-        { id: 2, market:'Insurance', type:'Term', source:'Manual', name:'Sam Taylor', phone:'(555) 987-6543', email:'sam@example.com', status:'Scheduled', location:'TX', time:'Today 2:30 PM', isClient:false, callLogs:[] },
-        { id: 3, market:'Insurance', type:'Final Expense', source:'Manual', name:'Jordan Lee', phone:'', email:'', status:'Contacted', location:'AL', time:'Yesterday 4:05 PM', isClient:false, callLogs:[] }
+        { id: 1, market:'Insurance', type:'Life', source:'Manual', name:'Alex Morgan', phone:'(555) 123-4567', email:'alex@example.com', status:'New', location:'ID', address:'123 Main St', city:'Boise', state:'ID', zip:'83702', time:'Today 10:15 AM', notes:'Wants quick quote', isClient:false, callLogs:[] },
+        { id: 2, market:'Insurance', type:'Term', source:'Manual', name:'Sam Taylor', phone:'(555) 987-6543', email:'sam@example.com', status:'Scheduled', location:'TX', address:'456 Oak Ave', city:'Dallas', state:'TX', zip:'75201', time:'Today 2:30 PM', isClient:false, callLogs:[] },
+        { id: 3, market:'Insurance', type:'Final Expense', source:'Manual', name:'Jordan Lee', phone:'', email:'', status:'Contacted', location:'AL', address:'789 Pine Rd', city:'Birmingham', state:'AL', zip:'35203', time:'Yesterday 4:05 PM', isClient:false, callLogs:[] }
       ],
       campaigns: [
         { id:'c1', name:'Insurance/Life - ID, OR', market:'Insurance', type:'Life', budget:100, status:'active', leads:24, costPerLead:12.45 }
       ],
       objections: [],
       analytics: {
         overview: { totalLeads: 3, totalCampaigns: 1, conversionRate: 34, avgCostPerLead: 14.12 },
         performance: { callAnswerRate: 41, smsResponseRate: 52, schedulingRate: 23, revenuePerLead: 186.4 }
       },
       inbound: [],
       imports: [],
       adLab: { variants: [], rotate: false }
     }
   };
 }
 
 /* =========================
    HELPERS
    ========================= */
 function startOfWeek(d){ const x = new Date(d); const day = (x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
 function startOfMonth(d){ const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
 function startOfYear(d){ const x = new Date(d); x.setMonth(0,1); x.setHours(0,0,0,0); return x; }
 
 /* =========================
    LOGIN
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -640,67 +640,65 @@ const Dashboard = () => {
           <StatCard label="Total Leads Paid This Month" value={paidThisMonth} icon="💵" gradient="from-emerald-600 to-emerald-700"/>
         </div>
 
         {/* Column 2: Scheduled */}
         <div className="space-y-4">
           <StatCard label="Scheduled Today" value={scheduledToday} icon="📅" gradient="from-purple-500 to-purple-600"/>
           <StatCard label="Scheduled This Week" value={scheduledWeek} icon="🗓️" gradient="from-purple-600 to-indigo-600"/>
           <StatCard label="Scheduled This Month" value={scheduledMonth} icon="🗃️" gradient="from-indigo-600 to-indigo-700"/>
         </div>
 
         {/* Column 3: Ad Spend */}
         <div className="space-y-4">
           <StatCard label="Ad Spend This Week" value={Money(adSpendWeek)} icon="💰" gradient="from-orange-500 to-orange-600"/>
           <StatCard label="Ad Spend This Month" value={Money(adSpendMonth)} icon="💳" gradient="from-orange-600 to-amber-600"/>
           <StatCard label="Ad Spend This Year" value={Money(adSpendYear)} icon="🏦" gradient="from-amber-600 to-yellow-600"/>
         </div>
 
         {/* Column 4: Conversion Rate */}
         <div className="space-y-4">
           <StatCard label="Conversion Rate This Week" value={Pct(convWeek)} icon="📈" gradient="from-teal-500 to-teal-600"/>
           <StatCard label="Conversion Rate This Month" value={Pct(convMonth)} icon="📊" gradient="from-teal-600 to-cyan-600"/>
           <StatCard label="Conversion Rate This Year" value={Pct(convYear)} icon="📌" gradient="from-cyan-600 to-sky-600"/>
         </div>
       </div>
 
-      /* Keep your APV row (unchanged) */
       <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
         <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
           <div className="text-xs text-gray-500">APV This Week</div>
           <div className="text-2xl font-bold">${apvStats.week.toLocaleString()}</div>
         </div>
         <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
           <div className="text-xs text-gray-500">APV This Month</div>
           <div className="text-2xl font-bold">${apvStats.month.toLocaleString()}</div>
         </div>
         <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
           <div className="text-xs text-gray-500">APV This Year</div>
           <div className="text-2xl font-bold">${apvStats.year.toLocaleString()}</div>
         </div>
       </div>
-
-     /* Recent Leads + Quick Actions (as before) */
+ 
       <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
         <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
           <h3 className="text-lg lg:text-xl font-bold mb-4">Recent Leads</h3>
           <div className="space-y-3">
             {leads.slice(0, 3).map(lead => (
               <button key={lead.id} onClick={()=>openLeadEditor(lead)} className="w-full text-left p-3 lg:p-4 border border-gray-200 rounded-xl hover:border-blue-300">
                 <div className="flex justify-between items-start mb-2">
                   <div className="font-semibold text-sm lg:text-base">{lead.name}</div>
                   <span className={`px-2 lg:px-3 py-1 rounded-full text-xs font-medium ${
                     lead.status === 'New' ? 'bg-blue-100 text-blue-800' :
                     lead.status === 'Contacted' ? 'bg-orange-100 text-orange-800' :
                     lead.status === 'Scheduled' ? 'bg-purple-100 text-purple-800' :
                     lead.status === 'Paid' ? 'bg-green-100 text-green-800' :
                     'bg-gray-100 text-gray-800'
                   }`}>{lead.status}</span>
                 </div>
                 <div className="text-xs lg:text-sm text-gray-600">
                   {lead.market}/{lead.type} • {lead.location||'—'} • {lead.time||'—'}
                 </div>
               </button>
             ))}
             {leads.length===0 && <div className="text-gray-500">No leads yet.</div>}
           </div>
         </div>
 
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -922,170 +920,199 @@ const Dashboard = () => {
                 </div>
               </div>
             ))}
             {localVariants.length===0 && <div className="text-gray-500">No variants yet. Click “Add Variant”.</div>}
           </div>
           {bestVariant && (
             <div className="mt-4 text-sm text-gray-700">
               Current best: <span className="font-semibold">{bestVariant.headline}</span>
             </div>
           )}
         </div>
       </div>
     );
   };
 
   /* ---------- Leads (click to edit + advanced statuses + notes + recordings) ---------- */
   const LeadManagement = () => {
     const [searchTerm, setSearchTerm] = useState('');
     const [filterMarket, setFilterMarket] = useState('');
     const [filterType, setFilterType] = useState('');
     const [filterStatus, setFilterStatus] = useState('');
     const [showImportModal, setShowImportModal] = useState(false);
     const [showTestModal, setShowTestModal] = useState(false);
     const [showAddLead, setShowAddLead] = useState(false);
 
-    const [newLead, setNewLead] = useState({ market:'Insurance', type:'Life', source:'Manual', name:'', phone:'', email:'', location:'', status:'New', notes:'' });
+    const [newLead, setNewLead] = useState({ market:'Insurance', type:'Life', source:'Manual', name:'', phone:'', email:'', location:'', address:'', city:'', state:'', zip:'', status:'New', notes:'' });
+    const [selectedIds, setSelectedIds] = useState(new Set());
 
     const filteredLeads = leads.filter(lead => {
       const term = searchTerm.toLowerCase();
       const matchesSearch = (lead.name||'').toLowerCase().includes(term) || (lead.phone||'').includes(searchTerm) || (lead.email||'').toLowerCase().includes(term);
       const matchesMarket = !filterMarket || lead.market===filterMarket;
       const matchesType = !filterType || (lead.type||'').toLowerCase() === filterType.toLowerCase();
       const matchesStatus = !filterStatus || lead.status===filterStatus;
       return matchesSearch && matchesMarket && matchesType && matchesStatus;
     });
 
+    const toggleSelect = (id) => {
+      setSelectedIds(prev => {
+        const next = new Set(prev);
+        if (next.has(id)) next.delete(id); else next.add(id);
+        return next;
+      });
+    };
+    const deleteSelected = async () => {
+      if (selectedIds.size === 0) return;
+      if (!confirm(`Delete ${selectedIds.size} selected lead(s)?`)) return;
+      const ids = Array.from(selectedIds);
+      for (const id of ids) {
+        try { await fetch(`/api/leads/${id}`, { method:'DELETE' }).catch(()=>{}); } catch {}
+      }
+      setLeads(prev => prev.filter(l=>!selectedIds.has(l.id)));
+      setSelectedIds(new Set());
+    };
+
     const handleFileUpload = async (event, type) => {
       const file = event.target.files[0]; if (!file) return;
       if (type === 'csv') {
         const text = await file.text();
         const rows = parseCSV(text).slice(0, 200);
         const imp = { id: Date.now(), filename: file.name, createdAt: new Date().toISOString(), rows, mapped: {}, dropPlaceholders: true };
         const next = [imp, ...imports];
         setImports(next); saveNow({ imports: next });
         alert(`✅ CSV loaded (${rows.length} preview rows). Go to Imports to map.`);
         setShowImportModal(false); setActiveTab('imports');
       } else {
         alert('🔍 PDF scanning simulated (connect OCR later).');
         const imp = { id: Date.now(), filename: file.name, createdAt: new Date().toISOString(), rows: [], mapped: {}, dropPlaceholders: true };
         const next = [imp, ...imports];
         setImports(next); saveNow({ imports: next });
         setShowImportModal(false); setActiveTab('imports');
       }
     };
 
     const saveNewLead = async () => {
       if (!newLead.name || !newLead.phone) { alert('Name and phone are required'); return; }
       const created = { ...newLead, id: Date.now(), time: new Date().toLocaleString(), callLogs: [], isClient: false };
       try{ await fetch('/api/leads', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(created) }).catch(()=>{}); } catch {}
       setLeads(prev => [created, ...prev]);
       setShowAddLead(false);
-      setNewLead({ market:'Insurance', type:'Life', source:'Manual', name:'', phone:'', email:'', location:'', status:'New', notes:'' });
+      setNewLead({ market:'Insurance', type:'Life', source:'Manual', name:'', phone:'', email:'', location:'', address:'', city:'', state:'', zip:'', status:'New', notes:'' });
 
       // auto-start outreach if Meta and automation enabled
       if (created.source === 'Meta' && automation.autoStartOnMeta) {
         alert('⚡ Auto-start outreach: calling now (sim).');
         try{ await fetch('/api/ai-call', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ leadId: created.id, phoneNumber: created.phone, method:'call', routing, metadata: routing.metadata.call }) }).catch(()=>{});}catch{}
       }
     };
 
     const deleteLead = async (leadId) => {
       if (!confirm('Delete this lead?')) return;
       try{ await fetch(`/api/leads/${leadId}`, { method:'DELETE' }).catch(()=>{}); }catch{}
       setLeads(prev => prev.filter(l=>l.id!==leadId));
+      setSelectedIds(prev => { const next = new Set(prev); next.delete(leadId); return next; });
     };
 
     return (
       <div className="space-y-6 fade-in">
         <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
           <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
             <h3 className="text-lg lg:text-xl font-bold">Lead Pipeline</h3>
             <div className="flex flex-wrap gap-2">
               <button onClick={()=>setShowAddLead(true)} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 transition-all text-sm">➕ Add Lead</button>
 
               <input type="file" accept=".csv" onChange={(e)=>handleFileUpload(e,'csv')} className="hidden" id="csv-upload-direct"/>
               <label htmlFor="csv-upload-direct" className="px-3 py-2 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition-all text-sm cursor-pointer">📊 Upload CSV</label>
 
               <input type="file" accept=".pdf" onChange={(e)=>handleFileUpload(e,'pdf')} className="hidden" id="pdf-upload-direct"/>
               <label htmlFor="pdf-upload-direct" className="px-3 py-2 bg-red-100 text-red-700 rounded-xl hover:bg-red-200 transition-all text-sm cursor-pointer">📄 Scan PDF → CSV</label>
 
               <button onClick={()=>setShowImportModal(true)} className="px-3 py-2 bg-blue-100 text-blue-700 rounded-xl hover:bg-blue-200 transition-all text-sm">📋 Import Options</button>
               <button onClick={()=>setShowTestModal(true)} className="px-3 py-2 bg-amber-100 text-amber-700 rounded-xl hover:bg-amber-200 transition-all text-sm">🧪 Test System</button>
             </div>
           </div>
 
           <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
-            <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={filterMarket} onChange={(e)=>setFilterMarket(e.target.value)}>
+            <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={filterMarket} onChange={(e)=>{ setFilterMarket(e.target.value); setFilterType(''); }}>
               <option value="">All Markets</option>
               {Object.keys(MARKET_OPTIONS).map(m=><option key={m} value={m}>{m}</option>)}
             </select>
             <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={filterType} onChange={(e)=>setFilterType(e.target.value)}>
               <option value="">All Sub-Types</option>
-              {Object.values(MARKET_OPTIONS).flat().map(t=><option key={t} value={t}>{t}</option>)}
-            </select>
-            <input type="text" className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Search leads…" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)}/>
-            <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={filterStatus} onChange={(e)=>setFilterStatus(e.target.value)}>
-              <option value="">All Status</option>
-              {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
-            </select>
+              {(filterMarket ? MARKET_OPTIONS[filterMarket] : Object.values(MARKET_OPTIONS).flat()).map(t=> <option key={t} value={t}>{t}</option>)}
+          </select>
+          <input type="text" className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Search leads…" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)}/>
+          <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={filterStatus} onChange={(e)=>setFilterStatus(e.target.value)}>
+            <option value="">All Status</option>
+            {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
+          </select>
+        </div>
+
+        {selectedIds.size > 0 && (
+          <div className="mb-4">
+            <button onClick={deleteSelected} className="px-3 py-2 bg-red-100 text-red-700 rounded-xl hover:bg-red-200 transition-all text-sm">Delete Selected ({selectedIds.size})</button>
           </div>
+        )}
 
-          <div className="space-y-4">
-            {filteredLeads.map(lead=>(
+        <div className="space-y-4">
+          {filteredLeads.map(lead=>(
               <div key={lead.id} className="p-4 border border-gray-200 rounded-xl hover:border-blue-300 transition-all">
                 <div className="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
-                  <div>
-                    <button onClick={()=>openLeadEditor(lead)} className="font-semibold text-lg text-left hover:underline">{lead.name}</button>
-                    <div className="text-sm text-gray-600">{lead.phone || '—'} • {lead.email || '—'}</div>
+                  <div className="flex items-start gap-2">
+                    <input type="checkbox" className="mt-1" checked={selectedIds.has(lead.id)} onChange={()=>toggleSelect(lead.id)}/>
+                    <div>
+                      <button onClick={()=>openLeadEditor(lead)} className="font-semibold text-lg text-left hover:underline">{lead.name}</button>
+                      <div className="text-sm text-gray-600">{lead.phone || '—'} • {lead.email || '—'}</div>
+                    </div>
                   </div>
                   <div className="flex items-center gap-2">
                     <span className={`badge ${
                       lead.status==='New'?'bg-blue-100 text-blue-800':
                       lead.status==='Contacted'?'bg-orange-100 text-orange-800':
                       lead.status==='Scheduled'?'bg-purple-100 text-purple-800':
                       lead.status==='Paid'?'bg-green-100 text-green-800':
                       'bg-gray-100 text-gray-800'
                     }`}>{lead.status}</span>
                     {lead.isClient && <span className="badge bg-green-50 text-green-700 border border-green-200">Client</span>}
                     <button onClick={()=>openLeadEditor(lead)} className="px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">✏️ Edit</button>
                     <button onClick={()=>{ if(confirm('Delete this lead?')) deleteLead(lead.id); }} className="px-2 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">🗑️</button>
                   </div>
                 </div>
                 <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
-                  <div className="text-sm text-gray-600">{lead.market}/{lead.type} • {lead.location || '—'} • {lead.time || '—'}</div>
+                  <div className="text-sm text-gray-600">{lead.market}/{lead.type} • {lead.city || lead.location || '—'} • {lead.time || '—'}</div>
                   <div className="flex flex-wrap gap-2">
                     <button onClick={()=>initiateContact(lead,'call')} className="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-all text-sm">📞 AI Call</button>
                     <button onClick={()=>initiateContact(lead,'sms')} className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all text-sm">💬 AI SMS</button>
                     <button className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-all text-sm">📅 Schedule</button>
                   </div>
                 </div>
                 {lead.apv ? <div className="mt-2 text-xs text-gray-700">APV: <strong>${Number(lead.apv).toLocaleString()}</strong> {lead.carrier? `• Carrier: ${lead.carrier}`:''}</div> : null}
               </div>
-            ))}
-            {filteredLeads.length===0 && <div className="text-center py-8 text-gray-500">No leads found</div>}
-          </div>
+          ))}
+          {filteredLeads.length===0 && <div className="text-center py-8 text-gray-500">No leads found</div>}
+        </div>
         </div>
 
         {/* Import Modal */}
         {showImportModal && (
           <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
             <div className="bg-white rounded-2xl p-6 max-w-md w-full">
               <h3 className="text-xl font-bold mb-4">Import Leads</h3>
               <div className="space-y-4">
                 <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                   <div className="text-2xl mb-2">📄</div>
                   <h4 className="font-semibold mb-2">Upload PDF</h4>
                   <p className="text-sm text-gray-600 mb-3">Front-end sim. Connect OCR later.</p>
                   <input type="file" accept=".pdf" onChange={(e)=>handleFileUpload(e,'pdf')} className="hidden" id="pdf-upload"/>
                   <label htmlFor="pdf-upload" className="px-4 py-2 bg-red-100 text-red-700 rounded-lg cursor-pointer hover:bg-red-200 transition-all">Choose PDF File</label>
                 </div>
                 <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                   <div className="text-2xl mb-2">📊</div>
                   <h4 className="font-semibold mb-2">Upload CSV</h4>
                   <p className="text-sm text-gray-600 mb-3">Preview first 200 rows.</p>
                   <input type="file" accept=".csv" onChange={(e)=>handleFileUpload(e,'csv')} className="hidden" id="csv-upload"/>
                   <label htmlFor="csv-upload" className="px-4 py-2 bg-green-100 text-green-700 rounded-lg cursor-pointer hover:bg-green-200 transition-all">Choose CSV File</label>
                 </div>
               </div>
               <div className="flex gap-3 mt-6">
                 <button onClick={()=>setShowImportModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">Close</button>
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -1131,50 +1158,54 @@ const Dashboard = () => {
                 // Auto outreach if source Meta
                 if (created.source==='Meta' && automation.autoStartOnMeta) {
                   alert('⚡ Auto-start outreach: calling now (sim).');
                 }
               } else {
                 setLeads(prev => prev.map(l => l.id===lead.id ? lead : l));
               }
             }}
           />
         )}
       </div>
     );
   };
 
   /* ---------- Lead Editor Modal (full editor) ---------- */
   function LeadEditorModal({ initialLead, onClose, onSave }) {
     const [lead, setLead] = useState(() => ({
       id: initialLead.id,
       market: initialLead.market || 'Insurance',
       type: initialLead.type || '',
       source: initialLead.source || 'Manual',
       name: initialLead.name || '',
       phone: initialLead.phone || '',
       email: initialLead.email || '',
       location: initialLead.location || '',
+      address: initialLead.address || '',
+      city: initialLead.city || '',
+      state: initialLead.state || '',
+      zip: initialLead.zip || '',
       status: initialLead.status || 'New',
       notes: initialLead.notes || '',
       apv: initialLead.apv || '',
       apvDate: initialLead.apvDate || null,
       carrier: initialLead.carrier || '',
       isClient: !!initialLead.isClient,
       debt: initialLead.debt || { creditCards:[], mortgages:[], cars:[], others:[] },
       callLogs: initialLead.callLogs || [],
       time: initialLead.time || new Date().toLocaleString()
     }));
     const [tab, setTab] = useState('profile');
 
     const isInsurance = lead.market === 'Insurance';
     const showAPVSection = isInsurance && STATUS_ADVANCED.has(lead.status);
 
     const addDebtRow = (key)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: [ ...(prev.debt[key]||[]), { amount:'', apr:'', label:'' } ] } }));
     const updateDebtRow = (key, idx, field, value)=> {
       setLead(prev=>{
         const arr = [...(prev.debt[key]||[])];
         arr[idx] = { ...arr[idx], [field]: value };
         return { ...prev, debt: { ...prev.debt, [key]: arr } };
       });
     };
     const removeDebtRow = (key, idx)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: (prev.debt[key]||[]).filter((_,i)=>i!==idx) } }));
 
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -1234,50 +1265,66 @@ const Dashboard = () => {
                 </select>
               </div>
               <div>
                 <label className="block text-sm font-medium mb-1">Status</label>
                 <select className="w-full p-3 border rounded-xl" value={lead.status} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                   {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                 </select>
               </div>
 
               <div>
                 <label className="block text-sm font-medium mb-1">Name</label>
                 <input className="w-full p-3 border rounded-xl" value={lead.name} onChange={(e)=>setLead(prev=>({...prev, name:e.target.value}))}/>
               </div>
               <div>
                 <label className="block text-sm font-medium mb-1">Phone</label>
                 <input className="w-full p-3 border rounded-xl" value={lead.phone} onChange={(e)=>setLead(prev=>({...prev, phone:e.target.value}))}/>
               </div>
               <div>
                 <label className="block text-sm font-medium mb-1">Email</label>
                 <input className="w-full p-3 border rounded-xl" value={lead.email} onChange={(e)=>setLead(prev=>({...prev, email:e.target.value}))}/>
               </div>
               <div>
                 <label className="block text-sm font-medium mb-1">Location</label>
                 <input className="w-full p-3 border rounded-xl" value={lead.location} onChange={(e)=>setLead(prev=>({...prev, location:e.target.value}))}/>
               </div>
+              <div>
+                <label className="block text-sm font-medium mb-1">Address</label>
+                <input className="w-full p-3 border rounded-xl" value={lead.address} onChange={(e)=>setLead(prev=>({...prev, address:e.target.value}))}/>
+              </div>
+              <div>
+                <label className="block text-sm font-medium mb-1">City</label>
+                <input className="w-full p-3 border rounded-xl" value={lead.city} onChange={(e)=>setLead(prev=>({...prev, city:e.target.value}))}/>
+              </div>
+              <div>
+                <label className="block text-sm font-medium mb-1">State</label>
+                <input className="w-full p-3 border rounded-xl" value={lead.state} onChange={(e)=>setLead(prev=>({...prev, state:e.target.value}))}/>
+              </div>
+              <div>
+                <label className="block text-sm font-medium mb-1">ZIP</label>
+                <input className="w-full p-3 border rounded-xl" value={lead.zip} onChange={(e)=>setLead(prev=>({...prev, zip:e.target.value}))}/>
+              </div>
 
               {/* Conditional APV/Carrier quick note */}
               {showAPVSection && (
                 <div className="md:col-span-2 bg-blue-50 border border-blue-200 p-3 rounded-xl text-sm">
                   Status enables APV + Carrier fields in “Status & APV” tab.
                 </div>
               )}
             </div>
           )}
 
           {/* STATUS + APV */}
           {tab==='status' && (
             <div className="space-y-4">
               <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                 <div>
                   <label className="block text-sm font-medium mb-1">Status</label>
                   <select className="w-full p-3 border rounded-xl" value={lead.status} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                     {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                   </select>
                 </div>
                 <div>
                   <label className="block text-sm font-medium mb-1">Carrier (Insurance)</label>
                   <input className="w-full p-3 border rounded-xl" value={lead.carrier || ''} onChange={(e)=>setLead(prev=>({...prev, carrier:e.target.value}))} disabled={!showAPVSection}/>
                 </div>
                 <div>
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -1739,82 +1786,86 @@ const Dashboard = () => {
 
             <div className="space-y-3">
               <h4 className="font-semibold">Recent Inbound</h4>
               {inboundEvents.map(evt=>(
                 <div key={evt.id} className="p-3 border rounded-xl">
                   <div className="flex justify-between">
                     <div className="font-semibold">{evt.type==='call'?'📞 Call':'💬 SMS'} from {evt.from || 'unknown'}</div>
                     <span className="text-xs text-gray-500">{evt.time}</span>
                   </div>
                   {evt.text && <div className="text-sm text-gray-700 mt-1">“{evt.text}”</div>}
                   <div className="text-xs text-gray-600 mt-1">Matched lead: {evt.matchedLeadId ? `#${evt.matchedLeadId}` : (evt.askName ? 'ask for name' : 'not found')}</div>
                 </div>
               ))}
               {inboundEvents.length===0 && <div className="text-gray-500 text-sm">No inbound yet.</div>}
             </div>
           </div>
         </div>
       </div>
     );
   };
 
   /* ---------- Imports ---------- */
   const Imports = () => {
     const [selectedImport, setSelectedImport] = useState(imports[0] || null);
     const [importsFilterPlaceholders, setImportsFilterPlaceholders] = useState(true);
-    const [currentMapping, setCurrentMapping] = useState({ name:'', phone:'', email:'', type:'', market:'', location:'', time:'', source:'', custom1:'', custom2:'' });
+    const [currentMapping, setCurrentMapping] = useState({ name:'', phone:'', email:'', type:'', market:'', location:'', address:'', city:'', state:'', zip:'', time:'', source:'', custom1:'', custom2:'' });
 
     useEffect(()=>{ if (!selectedImport && imports.length) setSelectedImport(imports[0]); }, [imports, selectedImport]);
 
     const rows0 = selectedImport?.rows || [];
     const headers = Object.keys(rows0[0] || {});
     const filteredRows = useMemo(()=>{
       const rows = rows0;
       if (!importsFilterPlaceholders) return rows.slice(0, 200);
       return rows.filter(r=>{
         const values = Object.values(r).join(' ').toLowerCase();
         return !values.includes('example') && !values.includes('(555)');
       }).slice(0, 200);
     },[rows0, importsFilterPlaceholders]);
 
     const saveMapping = () => {
       if (!selectedImport) return;
       const updated = imports.map(i => i.id===selectedImport.id ? { ...i, mapped: currentMapping, dropPlaceholders: importsFilterPlaceholders } : i);
       setImports(updated); saveNow({ imports: updated });
       alert('✅ Mapping saved.');
     };
     const importToLeads = () => {
       if (!selectedImport) return;
       const newLeads = filteredRows.map((row)=>({
         id: Date.now() + Math.floor(Math.random()*100000),
         name: row[currentMapping.name] || 'Unknown',
         phone: row[currentMapping.phone] || '',
         email: row[currentMapping.email] || '',
         market: row[currentMapping.market] || 'Insurance',
         type: (row[currentMapping.type] || 'Other'),
         source: row[currentMapping.source] || 'Import',
         location: row[currentMapping.location] || '',
+        address: row[currentMapping.address] || '',
+        city: row[currentMapping.city] || '',
+        state: row[currentMapping.state] || '',
+        zip: row[currentMapping.zip] || '',
         time: row[currentMapping.time] || new Date().toLocaleString(),
         status: 'New',
         isClient:false,
         callLogs:[]
       }));
       setLeads(prev => [...newLeads, ...prev]);
       alert(`✅ Imported ${newLeads.length} leads.`);
     };
     const deleteImport = () => {
       if (!selectedImport) return;
       if (!confirm('Delete this import file from the list?')) return;
       const updated = imports.filter(i => i.id !== selectedImport.id);
       setImports(updated); saveNow({ imports: updated });
       setSelectedImport(updated[0] || null);
     };
 
     return (
       <div className="space-y-6 fade-in">
         <div className="bg-white rounded-2xl p-6 shadow-lg">
           <h3 className="text-xl font-bold mb-4">📂 Imports</h3>
           <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
             <div className="space-y-3">
               <h4 className="font-semibold">Files</h4>
               {imports.map(imp=>(
                 <button key={imp.id} onClick={()=>{ setSelectedImport(imp); setCurrentMapping(imp.mapped || currentMapping); }}
diff --git a/public/index.html b/public/index.html
index a0ef7c669fde650569ab7d74d587e8019e474610..b10d9d8e5df56c5c2f39aa6f59ddc69e6363c16a 100644
--- a/public/index.html
+++ b/public/index.html
@@ -1838,51 +1889,51 @@ const Dashboard = () => {
                         <input type="checkbox" checked={importsFilterPlaceholders} onChange={(e)=>setImportsFilterPlaceholders(e.target.checked)}/>
                         Filter placeholders (e.g., “example”, 555)
                       </label>
                       <button onClick={deleteImport} className="px-3 py-1 bg-gray-100 rounded">Delete</button>
                     </div>
                   </div>
 
                   <div className="overflow-auto border rounded-xl">
                     <table className="min-w-full text-sm">
                       <thead className="bg-gray-50">
                         <tr>{headers.map(h=><th key={h} className="px-3 py-2 text-left font-medium text-gray-700">{h}</th>)}</tr>
                       </thead>
                       <tbody>
                         {filteredRows.map((row,idx)=>(
                           <tr key={idx} className="border-t">{headers.map(h=><td key={h} className="px-3 py-2">{row[h]}</td>)}</tr>
                         ))}
                         {filteredRows.length===0 && <tr><td className="px-3 py-6 text-center text-gray-500" colSpan="999">No rows to show.</td></tr>}
                       </tbody>
                     </table>
                   </div>
                   <div className="text-xs text-gray-500">Showing up to 200 rows (preview).</div>
 
                   <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                     {[
                       ['name','Name'], ['phone','Phone'], ['email','Email'],
-                      ['market','Market'], ['type','Sub-Type'], ['location','City'], ['time','Time'], ['source','Source'],
+                      ['market','Market'], ['type','Sub-Type'], ['location','Location'], ['address','Address'], ['city','City'], ['state','State'], ['zip','ZIP'], ['time','Time'], ['source','Source'],
                       ['custom1','Custom 1'], ['custom2','Custom 2']
                     ].map(([field,label])=>(
                       <div key={field}>
                         <label className="block text-sm font-medium mb-1">{label} → {field}</label>
                         <select className="w-full p-2 border rounded" value={currentMapping[field] || ''} onChange={(e)=>setCurrentMapping(prev=>({...prev, [field]: e.target.value}))}>
                           <option value="">Skip</option>
                           {headers.map(h=><option key={h} value={h}>{h}</option>)}
                         </select>
                       </div>
                     ))}
                   </div>
 
                   <div className="flex gap-3">
                     <button onClick={saveMapping} className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">💾 Save Mapping</button>
                     <button onClick={importToLeads} className="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl">⬆️ Import to Leads</button>
                   </div>
                 </>
               )}
             </div>
           </div>
         </div>
       </div>
     );
   };
 

  /* ---------- Settings ---------- */
  const Settings = () => {
    const [tab, setTab] = useState('apis');
    const saveAll = () => { saveNow(); alert('✅ Settings saved.'); };
    const changePassword = async ()=>{
      const oldp = prompt('Enter current password:'); if (!oldp) return;
      const newp = prompt('Enter new password:'); if (!newp) return;
      const conf = prompt('Confirm new password:'); if (conf !== newp) { alert('Passwords do not match'); return; }
      const users = loadUsers();
      const idx = users.findIndex(x=>emailEq(x.email, me.email)); if (idx<0) return alert('User not found');
      const oldHash = await sha256(oldp);
      if (oldHash !== users[idx].passHash) return alert('Current password incorrect');
      users[idx] = { ...users[idx], passHash: await sha256(newp) };
      saveUsers(users);
      alert('✅ Password changed.');
    };

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <div className="flex gap-2 mb-4 flex-wrap">
            <button onClick={()=>setTab('apis')} className={`px-3 py-2 rounded ${tab==='apis'?'bg-blue-600 text-white':'bg-gray-100'}`}>API Keys</button>
            <button onClick={()=>setTab('routing')} className={`px-3 py-2 rounded ${tab==='routing'?'bg-blue-600 text-white':'bg-gray-100'}`}>AI Routing & Workers</button>
            <button onClick={()=>setTab('automation')} className={`px-3 py-2 rounded ${tab==='automation'?'bg-blue-600 text-white':'bg-gray-100'}`}>Automation</button>
            <button onClick={()=>setTab('account')} className={`px-3 py-2 rounded ${tab==='account'?'bg-blue-600 text-white':'bg-gray-100'}`}>Account</button>
            {me.isAdmin && <button onClick={()=>setTab('users')} className={`px-3 py-2 rounded ${tab==='users'?'bg-blue-600 text-white':'bg-gray-100'}`}>Users (Admin)</button>}
          </div>

          {tab==='apis' && (
            <>
              <h3 className="text-lg lg:text-xl font-bold mb-4">API Configuration</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {[
                  ['openai','OpenAI API Key','sk-...','For ad gen & voice'],
                  ['meta','Meta Access Token','EA...','For Facebook/Instagram campaigns'],
                  ['elevenlabs','ElevenLabs API Key','elevenlabs-...','For voice calling'],
                  ['twilio','Twilio Account SID','AC...','For SMS/phone services'],
                ].map(([key,label,ph,help])=>(
                  <div key={key}>
                    <label className="block font-medium mb-2">{label}</label>
                    <input type="password" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder={ph} value={apiKeys[key]} onChange={(e)=>setApiKeys(prev=>({...prev, [key]: e.target.value}))}/>
                    <p className="text-xs text-gray-500 mt-1">{help}</p>
                  </div>
                ))}
                <div>
                  <label className="block font-medium mb-2">Default Voice Provider (links to Voice tab)</label>
                  <select className="w-full p-3 border rounded-xl" value={voiceSettings.provider} onChange={(e)=>{ setVoiceSettings(prev=>({...prev, provider:e.target.value, voice:''})); }}>
                    <option value="elevenlabs">ElevenLabs</option>
                    <option value="openai">OpenAI Voice</option>
                    <option value="azure">Azure Speech</option>
                    <option value="google">Google Cloud Speech</option>
                  </select>
                </div>
                <div>
                  <label className="block font-medium mb-2">Default SMS Provider (links to SMS section)</label>
                  <select className="w-full p-3 border rounded-xl" value={smsSettings.provider} onChange={(e)=>{ setSmsSettings(prev=>({...prev, provider:e.target.value})); }}>
                    <option value="twilio">Twilio</option>
                    <option value="messagebird">MessageBird</option>
                    <option value="vonage">Vonage</option>
                  </select>
                </div>
                <div>
                  <label className="block font-medium mb-2">From Number (SMS)</label>
                  <input className="w-full p-3 border rounded-xl" placeholder="+1 555 111 0000" value={apiKeys.smsFrom} onChange={(e)=>setApiKeys(prev=>({...prev, smsFrom:e.target.value}))}/>
                </div>
                <div>
                  <label className="block font-medium mb-2">From Number (Voice)</label>
                  <input className="w-full p-3 border rounded-xl" placeholder="+1 555 222 0000" value={apiKeys.voiceFrom} onChange={(e)=>setApiKeys(prev=>({...prev, voiceFrom:e.target.value}))}/>
                </div>
              </div>
            </>
          )}

          {tab==='routing' && (
            <>
              <h3 className="text-lg lg:text-xl font-bold mb-4">Model Routing & Workers</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="space-y-4">
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <h4 className="font-semibold mb-2">Brains</h4>
                    {[
                      ['callsModel','Calls/SMS brain','gpt-5-mini'],
                      ['callsEscalationModel','Escalation model','gpt-5'],
                      ['smsModel','SMS brain','gpt-5-mini'],
                      ['adsDraftModel','Ads draft model','gpt-5-mini'],
                      ['adsPolishModel','Ads polish model','gpt-5'],
                      ['adsImageModel','Ad images model','gpt-image-3.5']
                    ].map(([field,label,def])=>(
                      <div key={field} className="mb-2">
                        <label className="block text-sm font-medium mb-1">{label}</label>
                        <input type="text" className="w-full p-2 border rounded" value={routing[field]} onChange={(e)=>setRouting(prev=>({...prev, [field]: e.target.value || def}))}/>
                      </div>
                    ))}
                    <p className="text-xs text-gray-600 mt-2">Realtime worker for calls/SMS; batch worker for ads. Kept isolated so calls never lag.</p>
                  </div>

                  <div className="bg-gray-50 p-4 rounded-xl">
                    <h4 className="font-semibold mb-2">Workers (limits)</h4>
                    <div className="mb-3">
                      <div className="font-medium mb-1">Realtime (calls/SMS)</div>
                      {['maxTokens','timeoutMs','rpm','tpm'].map(k=>(
                        <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                          <label className="text-sm text-gray-600">{k}</label>
                          <input type="number" className="p-2 border rounded" value={routing.realtimeWorker[k]} onChange={(e)=>setRouting(prev=>({...prev, realtimeWorker:{...prev.realtimeWorker, [k]: parseInt(e.target.value)||0}}))}/>
                        </div>
                      ))}
                    </div>
                    <div>
                      <div className="font-medium mb-1">Batch (ads copy/image)</div>
                      {['maxTokens','timeoutMs','rpm','tpm'].map(k=>(
                        <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                          <label className="text-sm text-gray-600">{k}</label>
                          <input type="number" className="p-2 border rounded" value={routing.batchWorker[k]} onChange={(e)=>setRouting(prev=>({...prev, batchWorker:{...prev.batchWorker, [k]: parseInt(e.target.value)||0}}))}/>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="space-y-4">
                  <div className="bg-gray-50 p-4 rounded-xl">
                    <h4 className="font-semibold mb-2">Spend Tracking Metadata</h4>
                    {[
                      ['call','call'],
                      ['sms','sms'],
                      ['adsCopy','ads-copy'],
                      ['adsImage','ads-image']
                    ].map(([key,def])=>(
                      <div key={key} className="mb-3">
                        <div className="text-sm font-medium mb-1">{key}</div>
                        <div className="grid grid-cols-3 gap-2 items-center">
                          <span className="text-xs text-gray-600 col-span-1">channel</span>
                          <input type="text" className="p-2 border rounded col-span-2" value={routing.metadata[key]?.channel || def} onChange={(e)=>setRouting(prev=>({...prev, metadata:{...prev.metadata, [key]: { ...prev.metadata[key], channel: e.target.value }}}))}/>
                        </div>
                      </div>
                    ))}
                    <p className="text-xs text-gray-600">Requests are tagged like <code className="inline">{'{channel:"call"|"sms"|"ads-copy"|"ads-image"}'}</code></p>
                  </div>
                </div>
              </div>
            </>
          )}

          {tab==='automation' && (
            <div className="space-y-4">
              <h3 className="text-lg lg:text-xl font-bold">Automation</h3>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Auto-start outreach when a Meta lead arrives</span>
                <div className={`toggle-switch ${automation.autoStartOnMeta ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, autoStartOnMeta: !prev.autoStartOnMeta}))}><div className="toggle-slider"></div></div>
              </label>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Immediate retry on No Answer</span>
                <div className={`toggle-switch ${automation.immediateRetryOnNoAnswer ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, immediateRetryOnNoAnswer: !prev.immediateRetryOnNoAnswer}))}><div className="toggle-slider"></div></div>
              </label>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Immediate retry after Voicemail</span>
                <div className={`toggle-switch ${automation.immediateRetryOnVoicemail ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, immediateRetryOnVoicemail: !prev.immediateRetryOnVoicemail}))}><div className="toggle-slider"></div></div>
              </label>
              <div className="text-xs text-gray-600">These work with Voice AI “immediate callback” settings.</div>
            </div>
          )}

          {tab==='account' && (
            <div className="space-y-4">
              <h3 className="text-lg lg:text-xl font-bold">Account</h3>
              <div className="p-4 bg-gray-50 rounded-xl">
                <div className="text-sm text-gray-700"><strong>Email:</strong> {me.email}</div>
                <div className="text-sm text-gray-700"><strong>Role:</strong> {me.isAdmin ? 'Admin' : 'User'}</div>
              </div>
              <div className="flex gap-2">
                <button onClick={changePassword} className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">Change Password</button>
                <button onClick={onLogout} className="px-4 py-2 bg-red-100 text-red-700 rounded-xl">Logout</button>
              </div>
            </div>
          )}

          {tab==='users' && me.isAdmin && (
            <UsersAdmin me={me} onImpersonate={(email)=>{
              saveSession({ email, isAdmin: loadUsers().find(u=>emailEq(u.email,email))?.isAdmin || false });
              onImpersonate(email);
            }}/>
          )}

          {(tab==='apis' || tab==='routing' || tab==='automation') && (
            <div className="mt-6">
              <button onClick={saveAll} className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">💾 Save</button>
            </div>
          )}
        </div>
      </div>
    );
  };

  /* ---------- Utility actions used above ---------- */
  const getLeadFollowUp = (lead) => {
    // placeholder for future per-lead overrides (already exists in a previous version)
    return { enabled: true, followUpDelay: smsSettings.followUpDelay, scripts: smsSettings.scripts };
  };
  const followUpLabel = (mins)=>{
    const n = Number(mins)||0;
    if (n < 120) return `${n} minutes`;
    if (n < 24*60) return `${Math.round(n/60)} hours`;
    if (n % (7*24*60) === 0) return `${n/(7*24*60)} week`;
    return `${Math.round(n/1440)} day(s)`;
  };
  const initiateContact = async (lead, method) => {
    try {
      const f = getLeadFollowUp(lead);
      await fetch('/api/ai-call', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          leadId: lead.id, phoneNumber: lead.phone, method,
          routing, metadata: method==='call'? routing.metadata.call : routing.metadata.sms,
          followUp: f
        })
      }).catch(()=>{});
      alert(`✅ ${method==='call'?'Call':'SMS'} initiated (sim).\nFollow-up: ${f.enabled ? followUpLabel(f.followUpDelay) : 'OFF'}`);
    } catch { alert(`❌ ${method==='call'?'Call':'SMS'} failed.`); }
  };

  /* ---------- Mount helpers ---------- */
  function openLeadEditor(lead){
    const onClose = ()=>{ setEditor(null); };
    const onSave = (updated)=>{ setLeads(prev => prev.map(l => l.id===updated.id ? updated : l)); };
    setEditor(<LeadEditorModal initialLead={lead} onClose={onClose} onSave={onSave}/>);
  }
  const [editor, setEditor] = useState(null);

  /* ---------- Render ---------- */
  const renderContent = () => {
    switch(activeTab) {
      case 'dashboard': return <Dashboard/>;
      case 'ad-creator': return <AdCreator/>;
      case 'leads': return <LeadManagement/>;
      case 'voice-ai': return <VoiceAI/>;
      case 'objections': return <ObjectionHandling/>;
      case 'campaigns': return <CampaignManager/>;
      case 'analytics': return <Analytics/>;
      case 'inbound': return <InboundCenter/>;
      case 'imports': return <Imports/>;
      case 'settings': return <Settings/>;
      case 'admin-users': return <UsersAdmin me={me} onImpersonate={(email)=>{ saveSession({ email, isAdmin: loadUsers().find(u=>emailEq(u.email,email))?.isAdmin || false }); onImpersonate(email); }}/>;
      default: return <Dashboard/>;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
      <div className="flex flex-col lg:flex-row">
        <MobileNav/>
        <Sidebar/>
        <div className="flex-1 p-4 lg:p-8">
          <div className="mb-6 lg:mb-8">
            <h1 className="text-2xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
              {activeTab==='dashboard' && 'Dashboard Overview'}
              {activeTab==='ad-creator' && 'Professional Ad Creator'}
              {activeTab==='leads' && 'Lead Management'}
              {activeTab==='voice-ai' && 'Voice AI System'}
              {activeTab==='objections' && 'Objection Handling'}
              {activeTab==='campaigns' && 'Campaign Manager'}
              {activeTab==='analytics' && 'Analytics & Reporting'}
              {activeTab==='inbound' && 'Inbound Center'}
              {activeTab==='imports' && 'Imports & Field Mapping'}
              {activeTab==='settings' && 'Settings & Configuration'}
              {activeTab==='admin-users' && 'Users (Admin)'}
            </h1>
            <p className="text-sm lg:text-base text-gray-600">Multi-tenant workspace • Logged in as {me.email}</p>
          </div>
          {renderContent()}
        </div>
      </div>
      {editor}
    </div>
  );
}

/* =========================
   APP WRAPPER
   ========================= */
function AppWrapper(){
  const [me, setMe] = useState(null);
  useEffect(()=>{ (async ()=>{ await ensureAdmin(); const sess = loadSession(); if (sess) setMe(sess); })(); },[]);
  if (!me) return <LoginView onLoggedIn={setMe}/>;
  const logout = ()=>{ clearSession(); setMe(null); };
  const impersonate = (email)=>{ const u = loadUsers().find(x=>emailEq(x.email,email)); if (!u) return; setMe({ email: u.email, isAdmin: !!u.isAdmin }); };
  return <LeadFlowApp me={me} onLogout={logout} onImpersonate={impersonate}/>;
}

/* =========================
   CSV PARSER
   ========================= */
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  const pushField=()=>{ row.push(field); field=''; };
  const raw = [];
  row=[];
  while(i<text.length){
    const c = text[i];
    if (c === '"'){
      if (inQuotes && text[i+1]==='"'){ field+='"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes){ pushField(); }
    else if ((c === '\n' || c === '\r') && !inQuotes){
      pushField();
      if (row.length>1 || (row.length===1 && row[0]!=='')) raw.push(row);
      row=[];
    } else { field+=c; }
    i++;
  }
  if (field.length>0 || row.length){ pushField(); if (row.length) raw.push(row); }
  if (!raw.length) return [];
  const headers = raw[0].map(h=>String(h||'').trim() || 'col_'+Math.random().toString(36).slice(2,7));
  for (let r=1; r<raw.length; r++){
    const obj = {};
    for (let c=0; c<headers.length; c++){ obj[headers[c]] = raw[r][c] ?? ''; }
    rows.push(obj);
  }
  return rows;
}

/* =========================
   MOUNT
   ========================= */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AppWrapper/>);
</script>
</body>
</html>
