<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeadFlow Pro — Multi-Tenant</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn .35s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
    .toggle-switch { position: relative; width: 48px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background .2s; }
    .toggle-switch.active { background: #667eea; }
    .toggle-slider { position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .2s; }
    .toggle-switch.active .toggle-slider { transform: translateX(24px); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .card { background: white; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    code.inline { background:#f9fafb; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useMemo } = React;

/* =========================
   PERSISTENCE / AUTH
   ========================= */
const STORAGE_USERS = 'lfp:users';
const STORAGE_SESSION = 'lfp:session';
const WORKSPACE_PREFIX = 'lfp:workspace:'; // + email

const ADMIN_EMAIL = 'Joshua.kollar@me.com';
const ADMIN_PLAIN = 'Allglorytogod12!';

async function sha256(text){
  try{
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  } catch { return btoa(unescape(encodeURIComponent(text))); }
}
function emailEq(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }

function loadUsers(){ try { return JSON.parse(localStorage.getItem(STORAGE_USERS)) || []; } catch { return []; } }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function loadSession(){ try { return JSON.parse(localStorage.getItem(STORAGE_SESSION)); } catch { return null; } }
function saveSession(sess){ localStorage.setItem(STORAGE_SESSION, JSON.stringify(sess)); }
function clearSession(){ localStorage.removeItem(STORAGE_SESSION); }
function wsKey(email){ return WORKSPACE_PREFIX + (email||'').trim().toLowerCase(); }
function loadWorkspace(email){ try{ return JSON.parse(localStorage.getItem(wsKey(email))) || null; } catch { return null; } }
function saveWorkspace(email, data){ localStorage.setItem(wsKey(email), JSON.stringify(data)); }

async function ensureAdmin(){
  let users = loadUsers();
  const hasAdmin = users.some(u => emailEq(u.email, ADMIN_EMAIL));
  if (!hasAdmin){
    const hash = await sha256(ADMIN_PLAIN);
    users.push({ email: ADMIN_EMAIL, passHash: hash, isAdmin: true, locked: false, createdAt: new Date().toISOString(), lastLogin: null });
    saveUsers(users);
    if (!loadWorkspace(ADMIN_EMAIL)){ saveWorkspace(ADMIN_EMAIL, seedWorkspace()); }
  }
}

/* =========================
   CATALOGS / CONSTANTS
   ========================= */
const VOICE_CATALOG = {
  elevenlabs: ['Alloy','Callum','Rachel','Adam','Domi'],
  openai:     ['Alloy','Verse','Sol','Breeze'],
  azure:      ['en-US-GuyNeural','en-US-JennyNeural','en-US-ChristopherNeural'],
  google:     ['en-US-Neural2-J','en-US-Standard-B','en-US-Wavenet-D']
};

const US_TZ = [
  { id: 'America/New_York', label: 'US/Eastern' },
  { id: 'America/Chicago', label: 'US/Central' },
  { id: 'America/Denver', label: 'US/Mountain' },
  { id: 'America/Los_Angeles', label: 'US/Pacific' },
  { id: 'America/Anchorage', label: 'US/Alaska' },
  { id: 'Pacific/Honolulu', label: 'US/Hawaii' }
];

// Markets with capitalized names + subs (added Debt Free under Insurance)
const MARKET_OPTIONS = {
  "Insurance":    ['Life','Term','Final Expense','Medicare','Business Liability','Health','Debt Free'],
  "Real Estate":  ['Buyer Leads','Seller Leads','Open House','Investors','Rentals'],
  "Solar":        ['Residential','Commercial'],
  "Home Services":['Roofing','HVAC','Plumbing','Landscaping','Windows'],
  "Legal":        ['Injury','Disability','Estate','Criminal Defense'],
  "Other":        ['Generic','Event','SaaS']
};

// Statuses: include extended pipeline
const STATUS_LABELS = [
  'New','Contacted','Qualified','Scheduled',
  'App Submitted','Pending','Approved','Paid','Declined'
];
const STATUS_ADVANCED = new Set(['App Submitted','Pending','Approved','Paid','Declined']);

// dashboard APV counts use leads with apv>0 (often Approved/Paid)

/* =========================
   PROMPT EXAMPLES (unchanged)
   ========================= */
const PROMPT_TEMPLATES = {
  "Insurance": {
    "Life": [
      { h:"Protect Your Family—Rates Most People Miss", c:"Quick 60-sec quote for {{CITY}} families. Lock in coverage before rates move again. No exam options available.", cta:"get-quote" },
      { h:"$250k Life Coverage from {{LOW_PRICE}}/mo*", c:"Compare top carriers in {{STATE}}. Licensed agent, no pushy sales. Reply YES for 2-question pre-qual.", cta:"learn-more" }
    ],
    "Term": [
      { h:"Term Life, No Guesswork", c:"Pick 10/20/30 year terms that fit your budget. See your best rate in under a minute.", cta:"get-quote" }
    ],
    "Final Expense": [
      { h:"Help Cover Final Costs—Fixed Rates", c:"Plans for 50–85 in {{STATE}}. No medical exam. See your options now—peace of mind for loved ones.", cta:"get-quote" }
    ],
    "Medicare": [
      { h:"Medicare Savings You Might Be Missing", c:"Local help in {{CITY}}. Check extra benefits in minutes. No obligation, just clarity.", cta:"learn-more" }
    ],
    "Business Liability":[
      { h:"Protect Your Business From The Unknown", c:"Instant COIs, flexible monthly plans. See what similar {{INDUSTRY}} pay in {{STATE}}.", cta:"get-quote" }
    ],
    "Health":[
      { h:"Lower Your Health Premium—Same Doctors", c:"Check ACA and private options fast. Many qualify for $0 plans. Find out in 60 seconds.", cta:"apply-now" }
    ],
    "Debt Free":[
      { h:"Erase High-APR Debt Faster", c:"Free plan for {{CITY}} families: consolidate + protect. See how much interest you can save.", cta:"learn-more" }
    ]
  },
  "Real Estate": {
    "Buyer Leads": [{ h:"New Listings in {{CITY}}—Before They Hit Zillow", c:"Free daily list of homes under {{PRICE}}. Tap for instant alerts.", cta:"learn-more" }],
    "Seller Leads": [{ h:"See What Your {{CITY}} Home Could Sell For", c:"No-obligation price in 60 secs. Real comps + AI trends.", cta:"learn-more" }],
    "Open House":  [{ h:"Open House This Weekend—VIP Early Access", c:"Skip the line, get agent notes + bonus photos. RSVP.", cta:"apply-now" }],
    "Investors":   [{ h:"Off-Market Deals in {{CITY}}", c:"Weekly cash-flowing properties with ARV & rent comps.", cta:"learn-more" }],
    "Rentals":     [{ h:"Hot Rentals, No Junk", c:"Hand-picked under {{PRICE}} in {{CITY}}. Text your must-haves.", cta:"call-now" }]
  },
  "Solar": {
    "Residential":[{ h:"Slash Your Power Bill—Home Solar in {{CITY}}", c:"Check incentives. $0 down options, 25-yr warranty.", cta:"learn-more" }],
    "Commercial":[{ h:"Lower Operating Costs with Commercial Solar", c:"ROI often under 5 yrs. Get a 10-min savings check.", cta:"apply-now" }]
  },
  "Home Services": {
    "Roofing":[{ h:"Storm Damage? Free Roof Check Today", c:"Local crew—photos, quote, insurance help. Limited slots.", cta:"call-now" }],
    "HVAC":[{ h:"A/C Not Keeping Up?", c:"Same-day service. Transparent pricing, 5-star techs.", cta:"call-now" }],
    "Plumbing":[{ h:"Emergency Plumber—We’re 20 Minutes Away", c:"No trip fee today. Text a pic for instant estimate.", cta:"call-now" }],
    "Landscaping":[{ h:"Curb Appeal, Done for You", c:"Weekly plans that fit your budget. Free design consult.", cta:"get-quote" }],
    "Windows":[{ h:"Energy Bill Too High?", c:"High-efficiency windows with seasonal discounts.", cta:"learn-more" }]
  },
  "Legal": {
    "Injury":[{ h:"Injured? Don’t Settle for Less", c:"Free case check. Pay nothing unless you win.", cta:"call-now" }],
    "Disability":[{ h:"Denied SSDI? Appeal Help", c:"We handle filings and deadlines. Free review.", cta:"learn-more" }],
    "Estate":[{ h:"Easy Wills & Trusts (Flat Fee)", c:"Attorney-drafted in days, not months.", cta:"apply-now" }],
    "Criminal Defense":[{ h:"Charged? Get a Plan by Tonight", c:"Urgent consults 24/7. Confidential.", cta:"call-now" }]
  },
  "Other": {
    "Generic":[{ h:"Get the Exact Thing You Need—Fast", c:"Tell us your goal; we’ll tailor the plan.", cta:"learn-more" }],
    "Event":[{ h:"Seats Are Going—Grab Yours", c:"Early registration bonus ends soon.", cta:"apply-now" }],
    "SaaS":[{ h:"Automate the Boring Stuff", c:"Teams cut busywork 40% with our app.", cta:"learn-more" }]
  }
};

/* =========================
   DEFAULT WORKSPACE
   ========================= */
function seedWorkspace(){
  return {
    apiKeys: { openai:'', meta:'', elevenlabs:'', twilio:'', smsFrom:'', voiceFrom:'' },
    routing: {
      callsModel: 'gpt-5-mini',
      callsEscalationModel: 'gpt-5',
      smsModel: 'gpt-5-mini',
      adsDraftModel: 'gpt-5-mini',
      adsPolishModel: 'gpt-5',
      adsImageModel: 'gpt-image-3.5',
      realtimeWorker: { maxTokens: 2000, timeoutMs: 8000, rpm: 120, tpm: 120000 },
      batchWorker:    { maxTokens: 6000, timeoutMs: 30000, rpm: 60,  tpm: 300000 },
      metadata: {
        call:     { channel: 'call' },
        sms:      { channel: 'sms' },
        adsCopy:  { channel: 'ads-copy' },
        adsImage: { channel: 'ads-image' },
      }
    },
    automation: {
      autoStartOnMeta: true,
      immediateRetryOnNoAnswer: true,
      immediateRetryOnVoicemail: false
    },
    voiceSettings: {
      provider: 'elevenlabs',
      voice: 'Alloy',
      style: 'professional',
      speed: 'normal',
      callAttempts: 2,
      callInterval: 30, // minutes; 1440 enabled in UI
      immediateCallbackOnNoAnswer: false,
      immediateCallbackOnVoicemail: false,
      voicemailBehavior: 'leave_message', // 'hangup'|'leave_message'
      voicemailScript: 'Sorry I missed you—this is LeadFlow Pro following up. I’ll text details, and you can call or text back anytime.',
      scripts: {
        generic: 'Hi, this is LeadFlow Pro about your request. Do you have a minute?',
        life: 'Hi, reaching out about your life insurance request. Do you have a minute now?',
        term: 'Hi, your term quote is ready—can I walk you through options?',
        finalExpense: 'Hi, following up on your final expense inquiry. Quick questions?',
        medicare: 'Hi there, calling about your Medicare coverage questions. Is now good?'
      },
      businessHours: { start:'09:00', end:'17:00' },
      workingDays: ['monday','tuesday','wednesday','thursday','friday'],
      timezone: 'America/Denver' // Mountain default
    },
    smsSettings: {
      provider: 'twilio',
      autoRespond: true,
      followUpDelay: 15, // minutes; UI includes 1-2 days & next week
      scripts: {
        day0: 'Hey {{name}}, it’s Josh. Got your request—2 quick questions for your quote. Got a minute?',
        day1: 'Been trying to reach you about your request. Want me to text a ballpark quote?',
        day3: 'Still here when you are—want coverage options that fit your budget?',
        day5: 'Final ping for now. Want me to send a 60-sec summary?'
      },
      scriptVariants: {
        noAnswer: 'Missed you, {{name}}. Try again shortly or later today?',
        voicemailDrop: 'Left a voicemail. Text works great if easier—what time can I call?'
      },
      businessHours: { start:'09:00', end:'17:00' }
    },
    data: {
      leads: [
        { id: 1, market:'Insurance', type:'Life', source:'Manual', name:'Alex Morgan', phone:'(555) 123-4567', email:'alex@example.com', status:'New', location:'ID', time:'Today 10:15 AM', notes:'Wants quick quote', isClient:false, callLogs:[] },
        { id: 2, market:'Insurance', type:'Term', source:'Manual', name:'Sam Taylor', phone:'(555) 987-6543', email:'sam@example.com', status:'Scheduled', location:'TX', time:'Today 2:30 PM', isClient:false, callLogs:[] },
        { id: 3, market:'Insurance', type:'Final Expense', source:'Manual', name:'Jordan Lee', phone:'', email:'', status:'Contacted', location:'AL', time:'Yesterday 4:05 PM', isClient:false, callLogs:[] }
      ],
      campaigns: [
        { id:'c1', name:'Insurance/Life - ID, OR', market:'Insurance', type:'Life', budget:100, status:'active', leads:24, costPerLead:12.45 }
      ],
      objections: [],
      analytics: {
        overview: { totalLeads: 3, totalCampaigns: 1, conversionRate: 34, avgCostPerLead: 14.12 },
        performance: { callAnswerRate: 41, smsResponseRate: 52, schedulingRate: 23, revenuePerLead: 186.4 }
      },
      inbound: [],
      imports: [],
      adLab: { variants: [], rotate: false }
    }
  };
}

/* =========================
   HELPERS
   ========================= */
function startOfWeek(d){ const x = new Date(d); const day = (x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function startOfMonth(d){ const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function startOfYear(d){ const x = new Date(d); x.setMonth(0,1); x.setHours(0,0,0,0); return x; }

/* =========================
   LOGIN
   ========================= */
function LoginView({onLoggedIn}){
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState('');

  const login = async (e) => {
    e?.preventDefault();
    setErr(''); setBusy(true);
    try{
      const users = loadUsers();
      const idx = users.findIndex(x=>emailEq(x.email, email));
      if (idx === -1) throw new Error('Invalid email or password');
      const u = users[idx];
      if (u.locked) throw new Error('Account locked');
      const hash = await sha256(password);
      if (hash !== u.passHash) throw new Error('Invalid email or password');
      const copy = [...users];
      copy[idx] = { ...u, lastLogin: new Date().toISOString() };
      saveUsers(copy);
      saveSession({ email: u.email, isAdmin: !!u.isAdmin });
      if (!loadWorkspace(u.email)) saveWorkspace(u.email, seedWorkspace());
      onLoggedIn({ email: u.email, isAdmin: !!u.isAdmin });
    } catch(ex){ setErr(ex.message || 'Login failed'); }
    finally { setBusy(false); }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6">
      <div className="card w-full max-w-md p-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white font-bold flex items-center justify-center">LF</div>
          <div>
            <div className="text-xl font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-500">Secure login</div>
          </div>
        </div>
        <form onSubmit={login} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input type="email" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@domain.com" required/>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input type="password" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={password} onChange={e=>setPassword(e.target.value)} placeholder="••••••••" required/>
          </div>
          {err && <div className="text-sm text-red-600">{err}</div>}
          <button disabled={busy} className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">{busy ? 'Signing in…' : 'Sign In'}</button>
        </form>
      </div>
    </div>
  );
}

/* =========================
   USERS ADMIN
   ========================= */
function UsersAdmin({ me, onImpersonate }){
  const [users, setUsers] = useState(loadUsers());
  const [form, setForm] = useState({ email:'', password:'', isAdmin:false });

  const addUser = async ()=>{
    if (!form.email || !form.password) { alert('Email and password required'); return; }
    let list = loadUsers();
    if (list.some(u=>emailEq(u.email, form.email))) { alert('User already exists'); return; }
    const hash = await sha256(form.password);
    const u = { email: form.email.trim(), passHash: hash, isAdmin: !!form.isAdmin, locked:false, createdAt: new Date().toISOString(), lastLogin:null };
    list.push(u); saveUsers(list); setUsers(list);
    if (!loadWorkspace(u.email)) saveWorkspace(u.email, seedWorkspace());
    setForm({ email:'', password:'', isAdmin:false });
    alert('✅ User added');
  };
  const toggleLock = (email)=>{
    let list = loadUsers().map(u=> emailEq(u.email, email) ? { ...u, locked: !u.locked } : u);
    saveUsers(list); setUsers(list);
  };
  const resetPassword = async (email)=>{
    const np = prompt('New password for '+email+':'); if (!np) return;
    const hash = await sha256(np);
    let list = loadUsers().map(u=> emailEq(u.email, email)? { ...u, passHash: hash } : u);
    saveUsers(list); setUsers(list);
    alert('✅ Password reset');
  };
  const toggleAdmin = (email)=>{
    if (emailEq(email, me.email)) { alert('You cannot change your own admin flag here.'); return; }
    let list = loadUsers().map(u=> emailEq(u.email, email)? { ...u, isAdmin: !u.isAdmin } : u);
    saveUsers(list); setUsers(list);
  };

  return (
    <div className="bg-white rounded-2xl p-6 shadow-lg">
      <h3 className="text-xl font-bold mb-4">👥 Users (Admin)</h3>

      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <input type="email" placeholder="user@email.com" className="p-3 border rounded-xl" value={form.email} onChange={e=>setForm(prev=>({...prev,email:e.target.value}))}/>
        <input type="text" placeholder="Temp password" className="p-3 border rounded-xl" value={form.password} onChange={e=>setForm(prev=>({...prev,password:e.target.value}))}/>
        <div className="flex items-center gap-2">
          <label className="text-sm">Admin?</label>
          <input type="checkbox" checked={form.isAdmin} onChange={e=>setForm(prev=>({...prev,isAdmin:e.target.checked}))}/>
          <button onClick={addUser} className="ml-auto px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">Add</button>
        </div>
      </div>

      <div className="overflow-auto border rounded-xl">
        <table className="min-w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-3 py-2 text-left">Email</th>
              <th className="px-3 py-2 text-left">Admin</th>
              <th className="px-3 py-2 text-left">Locked</th>
              <th className="px-3 py-2 text-left">Created</th>
              <th className="px-3 py-2 text-left">Last login</th>
              <th className="px-3 py-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {users.map(u=>(
              <tr key={u.email} className="border-t">
                <td className="px-3 py-2">{u.email}</td>
                <td className="px-3 py-2">{u.isAdmin ? 'Yes' : 'No'} {!emailEq(u.email, me.email) && <button onClick={()=>toggleAdmin(u.email)} className="ml-2 text-blue-600">toggle</button>}</td>
                <td className="px-3 py-2">{u.locked ? 'Locked' : 'Active'} <button onClick={()=>toggleLock(u.email)} className="ml-2 text-blue-600">{u.locked?'unlock':'lock'}</button></td>
                <td className="px-3 py-2">{new Date(u.createdAt).toLocaleString()}</td>
                <td className="px-3 py-2">{u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '—'}</td>
                <td className="px-3 py-2">
                  <button onClick={()=>resetPassword(u.email)} className="text-blue-600 mr-3">reset pwd</button>
                  {me.isAdmin && !emailEq(u.email, me.email) && <button onClick={()=>onImpersonate(u.email)} className="text-purple-600">impersonate</button>}
                </td>
              </tr>
            ))}
            {users.length===0 && <tr><td colSpan="6" className="px-3 py-3 text-center text-gray-500">No users</td></tr>}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* =========================
   APP
   ========================= */
function LeadFlowApp({ me, onLogout, onImpersonate }){
  const ws0 = loadWorkspace(me.email) || seedWorkspace();

  const [activeTab, setActiveTab] = useState('dashboard');
  const [showMobileMenu, setShowMobileMenu] = useState(false);

  const [apiKeys, setApiKeys] = useState(ws0.apiKeys);
  const [routing, setRouting] = useState(ws0.routing);
  const [automation, setAutomation] = useState(ws0.automation || { autoStartOnMeta:true, immediateRetryOnNoAnswer:true, immediateRetryOnVoicemail:false });
  const [voiceSettings, setVoiceSettings] = useState(ws0.voiceSettings);
  const [smsSettings, setSmsSettings] = useState(ws0.smsSettings);

  const [leads, _setLeads] = useState(ws0.data.leads || []);
  const [campaigns, setCampaigns] = useState(ws0.data.campaigns || []);
  const [objections, setObjections] = useState(ws0.data.objections || []);
  const [analyticsData, setAnalyticsData] = useState(ws0.data.analytics || null);
  const [inboundEvents, setInboundEvents] = useState(ws0.data.inbound || []);
  const [imports, setImports] = useState(ws0.data.imports || []);
  const [adLab, setAdLab] = useState(ws0.data.adLab || { variants:[], rotate:false });

  const saveNow = (next) => {
    saveWorkspace(me.email, {
      apiKeys, routing, automation, voiceSettings, smsSettings,
      data: {
        leads: next?.leads ?? leads,
        campaigns: next?.campaigns ?? campaigns,
        objections: next?.objections ?? objections,
        analytics: next?.analytics ?? analyticsData,
        inbound: next?.inbound ?? inboundEvents,
        imports: next?.imports ?? imports,
        adLab: next?.adLab ?? adLab
      }
    });
  };
  const setLeads = (fnOrArr) => { const v = typeof fnOrArr==='function'? fnOrArr(leads):fnOrArr; _setLeads(v); saveNow({leads:v}); };
  const setAdLabPersist = (updater) => { const v = typeof updater==='function' ? updater(adLab) : updater; setAdLab(v); saveNow({ adLab: v }); };

  /* ---------- Stats & APV ---------- */
  const computeAPVStats = (list)=>{
    const now = new Date();
    const w0 = startOfWeek(now), m0 = startOfMonth(now), y0 = startOfYear(now);
    let week=0, month=0, year=0;
    list.forEach(l=>{
      const apv = Number(l.apv||0);
      if (!apv) return;
      const dt = l.apvDate ? new Date(l.apvDate) : new Date();
      if (dt >= w0) week += apv;
      if (dt >= m0) month += apv;
      if (dt >= y0) year += apv;
    });
    return { week: Math.round(week*100)/100, month: Math.round(month*100)/100, year: Math.round(year*100)/100 };
  };

  const apvStats = computeAPVStats(leads);

  const [stats, setStats] = useState({
    totalLeads: analyticsData?.overview?.totalLeads ?? (leads?.length || 0),
    scheduledToday: (leads||[]).filter(l=>l.status==='Scheduled').length,
    adSpend: 2450,
    conversionRate: Math.round(analyticsData?.overview?.conversionRate ?? 34)
  });
  useEffect(()=>{
    setStats({
      totalLeads: leads.length,
      scheduledToday: leads.filter(l=>l.status==='Scheduled').length,
      adSpend: 2450,
      conversionRate: Math.round(analyticsData?.overview?.conversionRate ?? 34)
    });
  }, [leads, analyticsData]);

  /* ---------- Optional backend fetch (safe no-throw) ---------- */
  useEffect(()=>{
    Promise.allSettled([
      fetch('/api/leads').then(r=>r.json()),
      fetch('/api/campaigns').then(r=>r.json()),
      fetch('/api/objections').then(r=>r.json()),
      fetch('/api/analytics').then(r=>r.json())
    ]).then(([leadsRes, campRes, objRes, anaRes])=>{
      if (leadsRes.status==='fulfilled' && Array.isArray(leadsRes.value)) setLeads(leadsRes.value);
      if (campRes.status==='fulfilled' && Array.isArray(campRes.value)) { setCampaigns(campRes.value); saveNow({campaigns: campRes.value}); }
      if (objRes.status==='fulfilled' && Array.isArray(objRes.value)) { setObjections(objRes.value); saveNow({objections: objRes.value}); }
      if (anaRes.status==='fulfilled' && anaRes.value) { setAnalyticsData(anaRes.value); saveNow({analytics: anaRes.value}); }
    }).catch(()=>{});
    // eslint-disable-next-line
  },[]);

  /* ---------- Nav ---------- */
  const MobileNav = () => (
    <div className="lg:hidden bg-white shadow-lg p-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold">LF</div>
          <div>
            <div className="font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-600">{me.email}</div>
          </div>
        </div>
        <button onClick={()=>setShowMobileMenu(!showMobileMenu)} className="p-2 rounded-lg bg-gray-100">☰</button>
      </div>
      {showMobileMenu && (
        <div className="mt-4 space-y-2">
          {[
            { id:'dashboard', icon:'📊', label:'Dashboard' },
            { id:'ad-creator', icon:'🎯', label:'Ad Creator' },
            { id:'leads', icon:'👥', label:'Leads' },
            { id:'voice-ai', icon:'🎙️', label:'Voice AI' },
            { id:'objections', icon:'💬', label:'Objections' },
            { id:'campaigns', icon:'📈', label:'Campaigns' },
            { id:'analytics', icon:'📊', label:'Analytics' },
            { id:'inbound', icon:'📞', label:'Inbound Center' },
            { id:'imports', icon:'📂', label:'Imports' },
            { id:'settings', icon:'⚙️', label:'Settings' },
            ...(me.isAdmin ? [{ id:'admin-users', icon:'🛡️', label:'Users (Admin)' }] : []),
          ].map(({id,icon,label})=>(
            <button key={id} onClick={()=>{ setActiveTab(id); setShowMobileMenu(false); }}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab===id ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white' : 'hover:bg-blue-50 text-gray-700'}`}>
              <span className="text-xl">{icon}</span>{label}
            </button>
          ))}
          <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-600">🚪 Logout</button>
        </div>
      )}
    </div>
  );
  const Sidebar = () => (
    <div className="hidden lg:block w-80 bg-white bg-opacity-95 backdrop-blur-lg p-6 shadow-xl">
      <div className="flex items-center gap-3 mb-8 pb-4 border-b-2 border-gray-200">
        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">LF</div>
        <div>
          <div className="font-bold text-lg">LeadFlow Pro</div>
          <div className="text-xs text-gray-600">{me.email}</div>
        </div>
      </div>
      <nav className="space-y-2">
        {[
          { id:'dashboard', icon:'📊', label:'Dashboard' },
          { id:'ad-creator', icon:'🎯', label:'Ad Creator' },
          { id:'leads', icon:'👥', label:'Lead Management' },
          { id:'voice-ai', icon:'🎙️', label:'Voice AI System' },
          { id:'objections', icon:'💬', label:'Objection Handling' },
          { id:'campaigns', icon:'📈', label:'Campaign Manager' },
          { id:'analytics', icon:'📊', label:'Analytics' },
          { id:'inbound', icon:'📞', label:'Inbound Center' },
          { id:'imports', icon:'📂', label:'Imports & Mapping' },
          { id:'settings', icon:'⚙️', label:'Settings & Configuration' },
          ...(me.isAdmin ? [{ id:'admin-users', icon:'🛡️', label:'Users (Admin)' }] : []),
        ].map(({id,icon,label})=>(
          <button key={id} onClick={()=>setActiveTab(id)}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 ${activeTab===id ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' : 'hover:bg-blue-50 text-gray-700 hover:translate-x-1'}`}>
            <span className="text-xl">{icon}</span>{label}
          </button>
        ))}
        <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-red-50 text-red-600">
          <span className="text-xl">🚪</span>Logout
        </button>
      </nav>
    </div>
  );

   /* ---------- Dashboard (with Quick Actions + APV widgets) ---------- */
const Dashboard = () => {
  // helpers for date windows
  const now = new Date();
  const w0 = startOfWeek(now);
  const m0 = startOfMonth(now);
  const y0 = startOfYear(now);

  // parse lead.time like "Today 10:15 AM", "Yesterday 4:05 PM", or a normal date string
  const parseLeadTime = (t) => {
    const s = (t || '').trim();
    if (!s) return null;
    if (s.startsWith('Today')) return new Date();
    if (s.startsWith('Yesterday')) { const d = new Date(); d.setDate(d.getDate() - 1); return d; }
    const d = new Date(s);
    return isNaN(d.getTime()) ? null : d;
  };
  const leadDate = (l) => parseLeadTime(l.time);
  const isIn = (date, start) => !!date && date >= start;
  const isToday = (date) => !!date && date.toDateString() === now.toDateString();

  // === Metrics ===

  // 1) Leads (Open only: New, Contacted, Qualified)
  const totalOpenLeads = (leads || []).filter(l =>
    l && ['New','Contacted','Qualified'].includes(l.status)
  ).length;

  // 2) Paid counts (this week / this month)
  const paidThisWeek  = (leads || []).filter(l => l.status === 'Paid' && isIn(leadDate(l), w0)).length;
  const paidThisMonth = (leads || []).filter(l => l.status === 'Paid' && isIn(leadDate(l), m0)).length;

  // 3) Scheduled (today / this week / this month)
  const scheduledToday  = (leads || []).filter(l => l.status === 'Scheduled' && isToday(leadDate(l))).length;
  const scheduledWeek   = (leads || []).filter(l => l.status === 'Scheduled' && isIn(leadDate(l), w0)).length;
  const scheduledMonth  = (leads || []).filter(l => l.status === 'Scheduled' && isIn(leadDate(l), m0)).length;

  // 4) Ad Spend (This Week / Month / Year)
  // Uses active campaign daily budgets × days elapsed in each window (front-end estimate)
  const activeDailyBudget = (campaigns || [])
    .filter(c => (c.status || 'active') === 'active')
    .reduce((sum, c) => sum + (Number(c.budget) || 0), 0);
  const daysSince = (start) => Math.max(1, Math.floor((now - start) / (24*60*60*1000)) + 1);
  const adSpendWeek  = Math.round(activeDailyBudget * daysSince(w0));
  const adSpendMonth = Math.round(activeDailyBudget * daysSince(m0));
  const adSpendYear  = Math.round(activeDailyBudget * daysSince(y0));

  // 5) Conversion Rate (Paid / Created in window)
  const createdIn = (start) => (leads || []).filter(l => isIn(leadDate(l), start));
  const convPct = (start) => {
    const subset = createdIn(start);
    if (subset.length === 0) return 0;
    const paid = subset.filter(l => l.status === 'Paid').length;
    return Math.round((paid / subset.length) * 100);
  };
  const convWeek  = convPct(w0);
  const convMonth = convPct(m0);
  const convYear  = convPct(y0);

  const StatCard = ({ label, value, icon, gradient }) => (
    <div className={`bg-gradient-to-br ${gradient} text-white p-4 lg:p-6 rounded-2xl shadow-lg text-center`}>
      <div className="text-2xl mb-2">{icon}</div>
      <div className="text-2xl lg:text-3xl font-bold mb-1">{value}</div>
      <div className="text-xs lg:text-sm opacity-90">{label}</div>
    </div>
  );

  const Money = (n) => `$${new Intl.NumberFormat().format(n)}`;
  const Pct   = (n) => `${Number(n||0)}%`;

  return (
    <div className="space-y-6 fade-in">
      {/* 4 columns; each column stacks the section + sub-metrics */}
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
        {/* Column 1: Open + Paid */}
        <div className="space-y-4">
          <StatCard label="Total Open Leads" value={totalOpenLeads} icon="👥" gradient="from-blue-500 to-blue-600"/>
          <StatCard label="Total Leads Paid This Week" value={paidThisWeek} icon="✅" gradient="from-emerald-500 to-emerald-600"/>
          <StatCard label="Total Leads Paid This Month" value={paidThisMonth} icon="💵" gradient="from-emerald-600 to-emerald-700"/>
        </div>

        {/* Column 2: Scheduled */}
        <div className="space-y-4">
          <StatCard label="Scheduled Today" value={scheduledToday} icon="📅" gradient="from-purple-500 to-purple-600"/>
          <StatCard label="Scheduled This Week" value={scheduledWeek} icon="🗓️" gradient="from-purple-600 to-indigo-600"/>
          <StatCard label="Scheduled This Month" value={scheduledMonth} icon="🗃️" gradient="from-indigo-600 to-indigo-700"/>
        </div>

        {/* Column 3: Ad Spend */}
        <div className="space-y-4">
          <StatCard label="Ad Spend This Week" value={Money(adSpendWeek)} icon="💰" gradient="from-orange-500 to-orange-600"/>
          <StatCard label="Ad Spend This Month" value={Money(adSpendMonth)} icon="💳" gradient="from-orange-600 to-amber-600"/>
          <StatCard label="Ad Spend This Year" value={Money(adSpendYear)} icon="🏦" gradient="from-amber-600 to-yellow-600"/>
        </div>

        {/* Column 4: Conversion Rate */}
        <div className="space-y-4">
          <StatCard label="Conversion Rate This Week" value={Pct(convWeek)} icon="📈" gradient="from-teal-500 to-teal-600"/>
          <StatCard label="Conversion Rate This Month" value={Pct(convMonth)} icon="📊" gradient="from-teal-600 to-cyan-600"/>
          <StatCard label="Conversion Rate This Year" value={Pct(convYear)} icon="📌" gradient="from-cyan-600 to-sky-600"/>
        </div>
      </div>

      /* Keep your APV row (unchanged) */
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Week</div>
          <div className="text-2xl font-bold">${apvStats.week.toLocaleString()}</div>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Month</div>
          <div className="text-2xl font-bold">${apvStats.month.toLocaleString()}</div>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Year</div>
          <div className="text-2xl font-bold">${apvStats.year.toLocaleString()}</div>
        </div>
      </div>

     /* Recent Leads + Quick Actions (as before) */
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <h3 className="text-lg lg:text-xl font-bold mb-4">Recent Leads</h3>
          <div className="space-y-3">
            {leads.slice(0, 3).map(lead => (
              <button key={lead.id} onClick={()=>openLeadEditor(lead)} className="w-full text-left p-3 lg:p-4 border border-gray-200 rounded-xl hover:border-blue-300">
                <div className="flex justify-between items-start mb-2">
                  <div className="font-semibold text-sm lg:text-base">{lead.name}</div>
                  <span className={`px-2 lg:px-3 py-1 rounded-full text-xs font-medium ${
                    lead.status === 'New' ? 'bg-blue-100 text-blue-800' :
                    lead.status === 'Contacted' ? 'bg-orange-100 text-orange-800' :
                    lead.status === 'Scheduled' ? 'bg-purple-100 text-purple-800' :
                    lead.status === 'Paid' ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>{lead.status}</span>
                </div>
                <div className="text-xs lg:text-sm text-gray-600">
                  {lead.market}/{lead.type} • {lead.location||'—'} • {lead.time||'—'}
                </div>
              </button>
            ))}
            {leads.length===0 && <div className="text-gray-500">No leads yet.</div>}
          </div>
        </div>

        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <h3 className="text-lg lg:text-xl font-bold mb-4">Quick Actions</h3>
          <div className="space-y-3">
            <button onClick={()=>setActiveTab('ad-creator')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
              🎯 Create New Ad Campaign
            </button>
            <button onClick={()=>setActiveTab('leads')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
              👥 Manage Leads
            </button>
            <button onClick={()=>setActiveTab('voice-ai')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
              🎙️ Test Voice AI System
            </button>
          </div>
        </div>
      </div>
    </div>
  );
};/* ---------- Ad Creator (market/sub) ---------- */
const AdCreator = () => {
  const [adForm, setAdForm] = useState({
    market: '',
    subType: '',
    targetLocations: '',
    minAge: '',
    maxAge: '',
    dailyBudget: '',
    headline: '',
    copy: '',
    cta: 'learn-more',
    genPrompt: ''
  });

  // Persisted variants/rotation (uses your existing adLab + setAdLabPersist)
  const [localVariants, setLocalVariants] = useState(adLab.variants || []);
  const [rotate, setRotate] = useState(adLab.rotate || false);

  // Creative library + selection + preview
  const [assets, setAssets] = useState([]);
  const [selectedAssetIds, setSelectedAssetIds] = useState([]);
  const [previewAd, setPreviewAd] = useState(null); // Live ad preview
  const [isTestingAd, setIsTestingAd] = useState(false);

  const [err, setErr] = useState('');
  const [busy, setBusy] = useState({ text: false, upload: false, genImg: false, genVid: false });

  // Reset sub-type when market changes
  useEffect(() => { 
    setAdForm(prev => ({ ...prev, subType: '' })); 
  }, [adForm.market]);

  // Load existing creative library
  useEffect(() => {
    let stop = false;
    (async () => {
      try {
        const r = await fetch('/api/creative/list').catch(() => null);
        if (!r || stop) return;
        const j = await r.json();
        const list = Array.isArray(j) ? j : (j.assets || []);
        if (!stop && list?.length) setAssets(list);
      } catch (error) {
        console.log('Creative library will load when backend ready');
      }
    })();
    return () => { stop = true; };
  }, []);

  // Auto-generate preview when form changes
  useEffect(() => {
    if (adForm.headline && adForm.copy) {
      const selectedAssets = assets.filter(a => selectedAssetIds.includes(a.id));
      const primaryAsset = selectedAssets[0];
      
      setPreviewAd({
        headline: adForm.headline,
        copy: adForm.copy,
        cta: adForm.cta,
        asset: primaryAsset,
        market: adForm.market,
        subType: adForm.subType,
        targeting: {
          locations: adForm.targetLocations,
          ageMin: adForm.minAge,
          ageMax: adForm.maxAge
        },
        budget: adForm.dailyBudget
      });
    } else {
      setPreviewAd(null);
    }
  }, [adForm, selectedAssetIds, assets]);

  // Templates (from PROMPT_TEMPLATES)
  const currentTemplates = (PROMPT_TEMPLATES[adForm.market] || {})[adForm.subType] || [];
  
  const applyTemplate = (tpl) => {
    if (!tpl) return;
    setAdForm(prev => ({
      ...prev,
      headline: tpl.h.replace('{{CITY}}', 'your area').replace('{{STATE}}', 'your state').replace('{{LOW_PRICE}}', '15'),
      copy: tpl.c.replace('{{CITY}}', 'your area').replace('{{STATE}}', 'your state').replace('{{PRICE}}', '500k').replace('{{INDUSTRY}}', 'your industry'),
      cta: tpl.cta || prev.cta
    }));
  };

  /* === AI GENERATION (Single Prompt → Text + Images + Video) === */
  async function generateFromPrompt() {
    if (!adForm.genPrompt.trim()) { 
      alert('Enter a prompt first.'); 
      return; 
    }
    
    setBusy({ text: true, genImg: true, genVid: true, upload: false }); 
    setErr('');
    
    try {
      const body = { 
        prompt: adForm.genPrompt, 
        market: adForm.market, 
        subType: adForm.subType || undefined,
        generateText: true,
        generateImages: true,
        generateVideo: true,
        imageCount: 6
      };
      
      // Try real backend first
      const r = await fetch('/api/generate-complete-ad', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(body) 
      });
      
      if (r.ok) {
        const j = await r.json();
        
        // Update text content
        if (j.text) {
          setAdForm(prev => ({
            ...prev,
            headline: j.text.headline || prev.headline,
            copy: j.text.copy || prev.copy,
            cta: j.text.cta || prev.cta
          }));
        }
        
        // Add generated assets
        if (j.assets && j.assets.length) {
          setAssets(prev => [...j.assets, ...prev]);
        }
        
      } else {
        throw new Error('Backend not ready');
      }
    } catch (error) { 
      console.log('Backend not ready, using simulation');
      
      // Simulate AI generation
      setTimeout(() => {
        // Generate text
        setAdForm(prev => ({
          ...prev,
          headline: `${adForm.market} Solution: ${adForm.genPrompt.substring(0, 30)}...`,
          copy: `Transform your ${adForm.market.toLowerCase()} results with our proven system. This ad copy is AI-generated based on: "${adForm.genPrompt}"`,
          cta: 'learn-more'
        }));
        
        // Generate demo assets
        const newAssets = [
          { id: Date.now(), url: `https://via.placeholder.com/600x400/4F46E5/white?text=AI+Generated+Image`, type: 'image', prompt: adForm.genPrompt },
          { id: Date.now() + 1, url: `https://via.placeholder.com/600x400/7C3AED/white?text=AI+Generated+Video`, type: 'video', prompt: adForm.genPrompt },
          { id: Date.now() + 2, url: `https://via.placeholder.com/600x400/10B981/white?text=Variation+1`, type: 'image', prompt: adForm.genPrompt }
        ];
        setAssets(prev => [...newAssets, ...prev]);
        
        setBusy({ text: false, genImg: false, genVid: false, upload: false });
      }, 3000);
      return;
    }
    
    setBusy({ text: false, genImg: false, genVid: false, upload: false });
  }

  /* === Individual generation functions (kept for backwards compatibility) === */
  async function generateTextFromPrompt() {
    if (!adForm.genPrompt.trim()) { alert('Enter a prompt first.'); return; }
    setBusy(b => ({ ...b, text: true })); setErr('');
    
    try {
      const body = { prompt: adForm.genPrompt, market: adForm.market, subType: adForm.subType || undefined };
      const r = await fetch('/api/generate-ad', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
      
      if (r.ok) {
        const j = await r.json();
        setAdForm(prev => ({
          ...prev,
          headline: j.headline || prev.headline,
          copy: j.copy || prev.copy,
          cta: j.cta || prev.cta
        }));
      } else {
        throw new Error('Backend not ready');
      }
    } catch { 
      // Fallback simulation
      setTimeout(() => {
        setAdForm(prev => ({
          ...prev,
          headline: `AI: ${adForm.genPrompt.substring(0, 40)}...`,
          copy: `Generated copy for ${adForm.market}: ${adForm.genPrompt}`,
          cta: 'learn-more'
        }));
        setBusy(b => ({ ...b, text: false }));
      }, 2000);
      return;
    }
    setBusy(b => ({ ...b, text: false }));
  }

  async function generateImages(extraPrompt) {
    const prompt = (extraPrompt ?? adForm.genPrompt || '').trim();
    if (!prompt) { alert('Enter a prompt first.'); return; }
    setBusy(b => ({ ...b, genImg: true })); setErr('');
    
    try {
      const r = await fetch('/api/creative/generate', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, count: 6, market: adForm.market, subType: adForm.subType || undefined })
      });
      
      if (r.ok) {
        const j = await r.json();
        const gen = Array.isArray(j) ? j : (j.assets || []);
        if (gen.length) setAssets(prev => [...gen, ...prev]);
      } else {
        throw new Error('Backend not ready');
      }
    } catch { 
      setTimeout(() => {
        const newImages = Array.from({ length: 3 }, (_, i) => ({
          id: Date.now() + i,
          url: `https://via.placeholder.com/400x300/4F46E5/white?text=Generated+${i + 1}`,
          type: 'image'
        }));
        setAssets(prev => [...newImages, ...prev]);
        setBusy(b => ({ ...b, genImg: false }));
      }, 2000);
      return;
    }
    setBusy(b => ({ ...b, genImg: false }));
  }

  async function generateVideo(extraPrompt) {
    const prompt = (extraPrompt ?? adForm.genPrompt || '').trim();
    if (!prompt) { alert('Enter a prompt first.'); return; }
    setBusy(b => ({ ...b, genVid: true })); setErr('');
    
    try {
      const r = await fetch('/api/creative/generate-video', {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt, market: adForm.market, subType: adForm.subType || undefined })
      });
      
      if (r.ok) {
        const j = await r.json();
        const vids = Array.isArray(j) ? j : (j.assets || []);
        if (vids.length) setAssets(prev => [...vids, ...prev]);
      } else {
        throw new Error('Backend not ready');
      }
    } catch { 
      setTimeout(() => {
        const newVideo = { 
          id: Date.now(), 
          url: `https://via.placeholder.com/400x300/7C3AED/white?text=AI+Video`, 
          type: 'video' 
        };
        setAssets(prev => [newVideo, ...prev]);
        setBusy(b => ({ ...b, genVid: false }));
      }, 3000);
      return;
    }
    setBusy(b => ({ ...b, genVid: false }));
  }

  /* === Upload (images/videos + manual ads) === */
  async function onUploadFiles(fileList) {
    const files = Array.from(fileList || []);
    if (!files.length) return;
    setBusy(b => ({ ...b, upload: true })); setErr('');
    
    try {
      const fd = new FormData();
      files.forEach(f => fd.append('files', f));
      const r = await fetch('/api/creative/upload', { method: 'POST', body: fd });
      
      if (r.ok) {
        const j = await r.json();
        const newAssets = Array.isArray(j) ? j : (j.assets || []);
        if (newAssets.length) setAssets(prev => [...newAssets, ...prev]);
      } else {
        throw new Error('Backend not ready');
      }
    } catch { 
      // Simulate upload with local URLs
      const uploadedAssets = files.map((file, index) => ({
        id: Date.now() + index,
        url: URL.createObjectURL(file),
        type: file.type.startsWith('video/') ? 'video' : 'image',
        uploaded: true
      }));
      setAssets(prev => [...uploadedAssets, ...prev]);
    }
    setBusy(b => ({ ...b, upload: false }));
  }

  /* === Test Ad Function === */
  async function testAd() {
    if (!previewAd) {
      alert('Complete the ad content first to test');
      return;
    }
    
    setIsTestingAd(true);
    
    try {
      const r = await fetch('/api/test-ad', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          ad: previewAd,
          testType: 'preview', // Can be 'preview', 'a-b-test', etc.
          market: adForm.market,
          targeting: previewAd.targeting
        })
      });
      
      if (r.ok) {
        const result = await r.json();
        alert(`✅ Ad test successful!\nExpected CTR: ${result.expectedCTR}%\nReach estimate: ${result.reachEstimate}`);
      } else {
        throw new Error('Backend not ready');
      }
    } catch {
      // Simulate test results
      setTimeout(() => {
        const mockResults = {
          expectedCTR: (Math.random() * 3 + 1).toFixed(2),
          reachEstimate: Math.floor(Math.random() * 10000 + 5000),
          score: Math.floor(Math.random() * 30 + 70)
        };
        alert(`🧪 Ad Test Results (Simulated):\nExpected CTR: ${mockResults.expectedCTR}%\nReach Estimate: ${mockResults.reachEstimate.toLocaleString()}\nQuality Score: ${mockResults.score}/100`);
        setIsTestingAd(false);
      }, 2000);
      return;
    }
    
    setIsTestingAd(false);
  }

  /* === Variants (persist via adLab) === */
  function addVariantFromCurrent() {
    if (!adForm.headline || !adForm.copy) { 
      alert('Set headline and copy first'); 
      return; 
    }
    const v = { 
      id: Date.now(), 
      headline: adForm.headline, 
      copy: adForm.copy, 
      cta: adForm.cta, 
      impressions: 0, 
      clicks: 0,
      assets: selectedAssetIds
    };
    const next = [v, ...localVariants];
    setLocalVariants(next);
    setAdLabPersist({ ...adLab, variants: next, rotate });
  }
  
  function deleteVariant(id) {
    const next = localVariants.filter(v => v.id !== id);
    setLocalVariants(next);
    setAdLabPersist({ ...adLab, variants: next, rotate });
  }
  
  function toggleRotate() {
    const nv = !rotate;
    setRotate(nv);
    setAdLabPersist({ ...adLab, rotate: nv, variants: localVariants });
  }

  /* === Select creatives for campaign === */
  function toggleSelectAsset(id) {
    setSelectedAssetIds(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id]);
  }

  /* === Launch (attaches selected creatives) === */
  async function launchCampaign() {
    if (!adForm.market || !adForm.headline || !adForm.copy || !adForm.targetLocations || !adForm.subType) {
      alert('Select a market and fill headline, copy, locations, and sub-type'); 
      return;
    }
    
    try {
      const body = {
        name: `${adForm.market}/${adForm.subType} - ${adForm.targetLocations}`,
        market: adForm.market, 
        type: adForm.subType,
        budget: parseInt(adForm.dailyBudget) || 100,
        adContent: { 
          headline: adForm.headline, 
          copy: adForm.copy, 
          cta: adForm.cta 
        },
        targeting: {
          locations: adForm.targetLocations.split(',').map(s => s.trim()).filter(Boolean),
          ageMin: parseInt(adForm.minAge) || 25, 
          ageMax: parseInt(adForm.maxAge) || 65
        },
        creative: { assetIds: selectedAssetIds },
        preview: previewAd,
        routing,
        metadata: routing.metadata.adsCopy
      };
      
      const r = await fetch('/api/launch-campaign', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(body) 
      });
      
      if (r.ok) {
        const result = await r.json();
        const newCamp = { 
          id: result.campaignId || 'c' + Date.now(), 
          name: body.name, 
          market: body.market, 
          type: body.type, 
          budget: body.budget, 
          status: 'active', 
          leads: 0, 
          costPerLead: 0,
          preview: previewAd
        };
        setCampaigns(prev => [newCamp, ...prev]); 
        saveNow({ campaigns: [newCamp, ...campaigns] });
        alert('🚀 Campaign launched successfully!');
      } else {
        throw new Error('Backend not ready');
      }
    } catch { 
      // Simulate launch
      const newCamp = { 
        id: 'c' + Date.now(), 
        name: `${adForm.market}/${adForm.subType} - ${adForm.targetLocations}`,
        market: adForm.market, 
        type: adForm.subType, 
        budget: parseInt(adForm.dailyBudget) || 100, 
        status: 'active', 
        leads: 0, 
        costPerLead: 0,
        preview: previewAd
      };
      setCampaigns(prev => [newCamp, ...prev]); 
      saveNow({ campaigns: [newCamp, ...campaigns] });
      alert('🚀 Campaign launched (simulated).');
    }
  }

  const Money = (n) => `$${new Intl.NumberFormat().format(Number(n || 0))}`;
  const isGenerating = busy.text || busy.genImg || busy.genVid;

  return (
    <div className="space-y-6 fade-in">
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-4 lg:gap-6">
        {/* Left Column: Category & Targeting */}
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <h3 className="text-lg lg:text-xl font-bold mb-4">Category & Targeting</h3>
          <div className="space-y-4">
            <div className="grid grid-cols-1 gap-3">
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Market</label>
                <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                        value={adForm.market}
                        onChange={(e) => setAdForm(prev => ({ ...prev, market: e.target.value, subType: '' }))}>
                  <option value="">Choose…</option>
                  {Object.keys(MARKET_OPTIONS).map(m => <option key={m} value={m}>{m}</option>)}
                </select>
              </div>
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Sub-Type</label>
                <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                        value={adForm.subType}
                        onChange={(e) => setAdForm(prev => ({ ...prev, subType: e.target.value }))}>
                  <option value="">Choose…</option>
                  {(MARKET_OPTIONS[adForm.market] || []).map(s => <option key={s} value={s}>{s}</option>)}
                </select>
              </div>
            </div>

            <div>
              <label className="block font-medium mb-2 text-sm lg:text-base">Target Locations</label>
              <input type="text" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                     placeholder="FL, TX, CA"
                     value={adForm.targetLocations}
                     onChange={(e) => setAdForm(prev => ({ ...prev, targetLocations: e.target.value }))} />
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Min Age</label>
                <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                       placeholder="25"
                       value={adForm.minAge}
                       onChange={(e) => setAdForm(prev => ({ ...prev, minAge: e.target.value }))} />
              </div>
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Max Age</label>
                <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                       placeholder="65"
                       value={adForm.maxAge}
                       onChange={(e) => setAdForm(prev => ({ ...prev, maxAge: e.target.value }))} />
              </div>
            </div>

            <div>
              <label className="block font-medium mb-2 text-sm lg:text-base">Daily Budget ($)</label>
              <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                     placeholder="150"
                     value={adForm.dailyBudget}
                     onChange={(e) => setAdForm(prev => ({ ...prev, dailyBudget: e.target.value }))} />
              <p className="text-xs text-gray-500 mt-1">Estimated budget: <strong>{Money(adForm.dailyBudget || 0)}/day</strong></p>
            </div>
          </div>
        </div>

        {/* Middle Column: AI Generation & Content */}
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <h3 className="text-lg lg:text-xl font-bold mb-4">AI Generation</h3>

          <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-xl mb-4 border border-blue-200">
            <div className="text-sm font-semibold mb-2 text-blue-800">🚀 Single Prompt → Complete Ad</div>
            <textarea className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 h-20 resize-none"
                      placeholder="Describe your offer, audience, vibe… AI will generate copy, images, and video!"
                      value={adForm.genPrompt}
                      onChange={(e) => setAdForm(prev => ({ ...prev, genPrompt: e.target.value }))} />
            
            <div className="flex gap-2 mt-3">
              <button onClick={generateFromPrompt}
                      className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold disabled:opacity-60 hover:shadow-lg transition-all"
                      disabled={isGenerating}>
                {isGenerating ? '⚡ Generating Complete Ad...' : '🎯 Generate Complete Ad'}
              </button>
            </div>
          </div>

          {/* Individual Generation (Legacy Support) */}
          <div className="bg-gray-50 p-3 rounded-xl mb-4">
            <div className="text-sm font-medium mb-2 text-gray-700">Or generate individually:</div>
            <div className="flex flex-wrap gap-2">
              <button onClick={generateTextFromPrompt}
                      className="px-3 py-2 bg-blue-100 text-blue-700 rounded-lg text-sm disabled:opacity-60"
                      disabled={busy.text}>
                {busy.text ? 'Generating…' : '📝 Text Only'}
              </button>
              <button onClick={() => generateImages()}
                      className="px-3 py-2 bg-green-100 text-green-700 rounded-lg text-sm disabled:opacity-60"
                      disabled={busy.genImg}>
                {busy.genImg ? 'Generating…' : '🖼️ Images Only'}
              </button>
              <button onClick={() => generateVideo()}
                      className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg text-sm disabled:opacity-60"
                      disabled={busy.genVid}>
                {busy.genVid ? 'Generating…' : '🎬 Video Only'}
              </button>
            </div>
          </div>

          {/* Templates */}
          {currentTemplates.length > 0 && (
            <div className="bg-gray-50 p-3 rounded-xl mb-4">
              <div className="text-xs text-gray-600 mb-2">Quick start templates:</div>
              <div className="flex flex-wrap gap-2">
                {currentTemplates.map((tpl, i) => (
                  <button key={i} onClick={() => applyTemplate(tpl)} 
                          className="px-3 py-2 text-xs bg-white border rounded-lg hover:bg-blue-50">
                    "{tpl.h.substring(0, 25)}..."
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Manual Content */}
          <div className="space-y-4">
            <div>
              <label className="block font-medium mb-2 text-sm lg:text-base">Headline</label>
              <input type="text" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                     placeholder="Your compelling headline…"
                     value={adForm.headline}
                     onChange={(e) => setAdForm(prev => ({ ...prev, headline: e.target.value }))} />
            </div>
            <div>
              <label className="block font-medium mb-2 text-sm lg:text-base">Ad Copy</label>
              <textarea className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 h-24 resize-none"
                        placeholder="Write your ad copy here…"
                        value={adForm.copy}
                        onChange={(e) => setAdForm(prev => ({ ...prev, copy: e.target.value }))} />
            </div>
            <div>
              <label className="block font-medium mb-2 text-sm lg:text-base">Call-to-Action</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500"
                      value={adForm.cta}
                      onChange={(e) => setAdForm(prev => ({ ...prev, cta: e.target.value }))}>
                <option value="learn-more">Learn More</option>
                <option value="get-quote">Get Free Quote</option>
                <option value="call-now">Call Now</option>
                <option value="apply-now">Apply Now</option>
              </select>
            </div>

            {/* Upload */}
            <div className="border-2 border-dashed border-gray-300 rounded-xl p-4 text-center">
              <label className="cursor-pointer">
                <div className="text-gray-600 mb-2">📁 Upload Manual Assets</div>
                <div className="text-sm text-gray-500">Drop images/videos or click to browse</div>
                <input type="file" accept="image/*,video/*" multiple className="hidden" 
                       onChange={(e) => onUploadFiles(e.target.files)} />
              </label>
            </div>

            {err && <div className="text-sm text-red-600">{err}</div>}
          </div>
        </div>

        {/* Right Column: Live Preview */}
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg lg:text-xl font-bold">Live Preview</h3>
            {previewAd && (
              <button onClick={testAd}
                      className="px-3 py-2 bg-orange-100 text-orange-700 rounded-lg text-sm hover:bg-orange-200 disabled:opacity-60"
                      disabled={isTestingAd}>
                {isTestingAd ? '🧪 Testing...' : '🧪 Test Ad'}
              </button>
            )}
          </div>
          
          {previewAd ? (
            <div className="border rounded-xl overflow-hidden">
              {/* Ad Preview Frame */}
              <div className="bg-gray-100 p-3 border-b">
                <div className="text-xs text-gray-600">📱 Preview: Facebook/Instagram Feed</div>
              </div>
              
              <div className="p-4">
                {/* Asset Preview */}
                {previewAd.asset && (
                  <div className="mb-3 rounded-lg overflow-hidden">
                    {previewAd.asset.type === 'video' ? (
                      <video src={previewAd.asset.url} className="w-full h-48 object-cover" controls />
                    ) : (
                      <img src={previewAd.asset.url} className="w-full h-48 object-cover" alt="Ad visual" />
                    )}
                  </div>
                )}
                
                {/* Ad Content */}
                <div className="space-y-2">
                  <div className="font-bold text-lg">{previewAd.headline}</div>
                  <div className="text-gray-700 text-sm leading-relaxed">{previewAd.copy}</div>
                  
                  {/* CTA Button */}
                  <div className="mt-3">
                    <button className="w-full px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition-all">
                      {previewAd.cta.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                    </button>
                  </div>
                  
                  {/* Ad Info */}
                  <div className="mt-3 pt-3 border-t text-xs text-gray-500">
                    <div>Target: {previewAd.targeting.locations || 'All locations'}</div>
                    <div>Age: {previewAd.targeting.ageMin || 25}-{previewAd.targeting.ageMax || 65}</div>
                    <div>Budget: {Money(previewAd.budget || 0)}/day</div>
                  </div>
                </div>
              </div>
            </div>
          ) : (
            <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center text-gray-500">
              <div className="text-4xl mb-2">📱</div>
              <div className="font-medium mb-1">Live Ad Preview</div>
              <div className="text-sm">Add headline and copy to see preview</div>
            </div>
          )}
        </div>
      </div>

      {/* Creative Library with Selection */}
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg lg:text-xl font-bold">Creative Library</h3>
          <div className="text-sm text-gray-600">{selectedAssetIds.length} selected • {assets.length} total</div>
        </div>
        
        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3">
          {assets.map(a => (
            <button key={a.id}
                    onClick={() => toggleSelectAsset(a.id)}
                    className={`relative border rounded-xl overflow-hidden transition-all ${
                      selectedAssetIds.includes(a.id) 
                        ? 'ring-2 ring-purple-500 border-purple-300 shadow-lg' 
                        : 'border-gray-200 hover:border-blue-300 hover:shadow-md'
                    }`}>
              {a.type === 'video' ? (
                <video src={a.url} className="w-full h-24 object-cover" />
              ) : (
                <img src={a.url} className="w-full h-24 object-cover" alt="creative" />
              )}
              
              {/* Selection Indicator */}
              <div className={`absolute top-1 right-1 w-4 h-4 rounded-full border ${
                selectedAssetIds.includes(a.id) 
                  ? 'bg-purple-600 border-purple-600' 
                  : 'bg-white border-gray-400'
              }`}>
                {selectedAssetIds.includes(a.id) && (
                  <div className="text-white text-xs flex items-center justify-center h-full">✓</div>
                )}
              </div>
              
              {/* Asset Type Badge */}
              <div className="absolute bottom-1 left-1 px-1 py-0.5 bg-black bg-opacity-75 text-white text-xs rounded">
                {a.type === 'video' ? '🎬' : '🖼️'}
              </div>
              
              {/* Upload Badge */}
              {a.uploaded && (
                <div className="absolute top-1 left-1 px-1 py-0.5 bg-green-600 text-white text-xs rounded">
                  Uploaded
                </div>
              )}
            </button>
          ))}
          
          {assets.length === 0 && (
            <div className="col-span-full text-center py-8 text-gray-500">
              <div className="text-4xl mb-2">🎨</div>
              <div className="font-medium mb-1">No assets yet</div>
              <div className="text-sm">Generate or upload to get started</div>
            </div>
          )}
        </div>
      </div>

      {/* Ad Variants & Rotation */}
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg lg:text-xl font-bold">Ad Variants & A/B Testing</h3>
          <div className="flex items-center gap-4">
            <label className="flex items-center gap-2 text-sm">
              <span>Auto-rotate variants</span>
              <input type="checkbox" checked={rotate} onChange={toggleRotate} />
            </label>
            <button onClick={addVariantFromCurrent}
                    className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-all">
              ➕ Save as Variant
            </button>
          </div>
        </div>
        
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-4">
          {localVariants.map(v => (
            <div key={v.id} className="border rounded-xl p-4 hover:border-blue-300 transition-all">
              <div className="font-semibold mb-2 text-blue-600">{v.headline}</div>
              <div className="text-sm text-gray-700 mb-3 line-clamp-3">{v.copy}</div>
              
              <div className="flex items-center justify-between text-xs text-gray-500 mb-3">
                <span>CTA: {v.cta}</span>
                <span>{v.assets?.length || 0} assets</span>
              </div>
              
              {/* Variant Performance (simulated) */}
              <div className="bg-gray-50 p-2 rounded text-xs mb-3">
                <div className="flex justify-between">
                  <span>Impressions:</span>
                  <span>{v.impressions.toLocaleString()}</span>
                </div>
                <div className="flex justify-between">
                  <span>Clicks:</span>
                  <span>{v.clicks.toLocaleString()}</span>
                </div>
                <div className="flex justify-between font-medium">
                  <span>CTR:</span>
                  <span>{v.impressions > 0 ? ((v.clicks / v.impressions) * 100).toFixed(2) : 0}%</span>
                </div>
              </div>
              
              <div className="flex gap-2">
                <button onClick={() => {
                  setAdForm(prev => ({
                    ...prev,
                    headline: v.headline,
                    copy: v.copy,
                    cta: v.cta
                  }));
                  if (v.assets) setSelectedAssetIds(v.assets);
                }}
                        className="flex-1 px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">
                  Load
                </button>
                <button onClick={() => deleteVariant(v.id)} 
                        className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-sm hover:bg-gray-200">
                  Delete
                </button>
              </div>
            </div>
          ))}
          
          {localVariants.length === 0 && (
            <div className="col-span-full text-center py-6 text-gray-500">
              <div className="text-2xl mb-2">🔄</div>
              <div className="font-medium mb-1">No variants yet</div>
              <div className="text-sm">Create different versions to A/B test performance</div>
            </div>
          )}
        </div>
      </div>

      {/* Campaign Actions */}
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <div className="flex flex-col sm:flex-row gap-4 items-start sm:items-center justify-between">
          <div>
            <h3 className="text-lg font-bold">Ready to Launch?</h3>
            <p className="text-sm text-gray-600">Your ad will be added to Campaign Manager for tracking</p>
          </div>
          
          <div className="flex gap-3">
            {previewAd && (
              <button onClick={testAd}
                      className="px-6 py-3 bg-orange-500 text-white rounded-xl font-semibold hover:bg-orange-600 disabled:opacity-60 transition-all"
                      disabled={isTestingAd}>
                {isTestingAd ? '🧪 Testing Ad...' : '🧪 Test Ad Performance'}
              </button>
            )}
            
            <button onClick={launchCampaign}
                    className="px-6 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">
              🚀 Launch Campaign
            </button>
          </div>
        </div>
        
        {/* Launch Requirements Checklist */}
        <div className="mt-4 p-3 bg-gray-50 rounded-xl">
          <div className="text-sm font-medium mb-2">Launch Checklist:</div>
          <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 text-xs">
            <div className={`flex items-center gap-1 ${adForm.market ? 'text-green-600' : 'text-gray-500'}`}>
              {adForm.market ? '✅' : '⏳'} Market Selected
            </div>
            <div className={`flex items-center gap-1 ${adForm.headline && adForm.copy ? 'text-green-600' : 'text-gray-500'}`}>
              {adForm.headline && adForm.copy ? '✅' : '⏳'} Ad Content
            </div>
            <div className={`flex items-center gap-1 ${selectedAssetIds.length > 0 ? 'text-green-600' : 'text-gray-500'}`}>
              {selectedAssetIds.length > 0 ? '✅' : '⏳'} Creative Assets
            </div>
            <div className={`flex items-center gap-1 ${adForm.targetLocations ? 'text-green-600' : 'text-gray-500'}`}>
              {adForm.targetLocations ? '✅' : '⏳'} Target Locations
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
/* ---------- End of AdCreator component ---------- */

/* ---------- Leads (click to edit + advanced statuses + notes + recordings) ---------- */
const LeadManagement = () => {
  const [searchTerm, setSearchTerm] = useState('');
  const [filterMarket, setFilterMarket] = useState('');
  const [filterType, setFilterType] = useState('');
  const [filterStatus, setFilterStatus] = useState('');
  const [showImportModal, setShowImportModal] = useState(false);
  const [showTestModal, setShowTestModal] = useState(false);
  const [showAddLead, setShowAddLead] = useState(false);

  const [newLead, setNewLead] = useState({ 
    market: 'Insurance', 
    type: 'Life', 
    source: 'Manual', 
    name: '', 
    phone: '', 
    email: '', 
    location: '', 
    status: 'New', 
    notes: '',
    healthConditions: '' // NEW: Health conditions field
  });

  const filteredLeads = leads.filter(lead => {
    const term = searchTerm.toLowerCase();
    const matchesSearch = (lead.name || '').toLowerCase().includes(term) || 
                         (lead.phone || '').includes(searchTerm) || 
                         (lead.email || '').toLowerCase().includes(term);
    const matchesMarket = !filterMarket || lead.market === filterMarket;
    const matchesType = !filterType || (lead.type || '').toLowerCase() === filterType.toLowerCase();
    const matchesStatus = !filterStatus || lead.status === filterStatus;
    return matchesSearch && matchesMarket && matchesType && matchesStatus;
  });

  const handleFileUpload = async (event, type) => {
    const file = event.target.files[0]; 
    if (!file) return;
    
    if (type === 'csv') {
      const text = await file.text();
      const rows = parseCSV(text).slice(0, 200);
      const imp = { 
        id: Date.now(), 
        filename: file.name, 
        createdAt: new Date().toISOString(), 
        rows, 
        mapped: {}, 
        dropPlaceholders: true 
      };
      const next = [imp, ...imports];
      setImports(next); 
      saveNow({ imports: next });
      alert(`✅ CSV loaded (${rows.length} preview rows). Go to Imports to map.`);
      setShowImportModal(false); 
      setActiveTab('imports');
    } else {
      alert('🔍 PDF scanning simulated (connect OCR later).');
      const imp = { 
        id: Date.now(), 
        filename: file.name, 
        createdAt: new Date().toISOString(), 
        rows: [], 
        mapped: {}, 
        dropPlaceholders: true 
      };
      const next = [imp, ...imports];
      setImports(next); 
      saveNow({ imports: next });
      setShowImportModal(false); 
      setActiveTab('imports');
    }
  };

  const saveNewLead = async () => {
    if (!newLead.name || !newLead.phone) { 
      alert('Name and phone are required'); 
      return; 
    }
    
    const created = { 
      ...newLead, 
      id: Date.now(), 
      time: new Date().toLocaleString(), 
      callLogs: [], 
      isClient: false 
    };
    
    try { 
      await fetch('/api/leads', { 
        method: 'POST', 
        headers: { 'Content-Type': 'application/json' }, 
        body: JSON.stringify(created) 
      }).catch(() => {}); 
    } catch {}
    
    setLeads(prev => [created, ...prev]);
    setShowAddLead(false);
    setNewLead({ 
      market: 'Insurance', 
      type: 'Life', 
      source: 'Manual', 
      name: '', 
      phone: '', 
      email: '', 
      location: '', 
      status: 'New', 
      notes: '',
      healthConditions: ''
    });

    // Auto-start outreach if Meta and automation enabled
    if (created.source === 'Meta' && automation.autoStartOnMeta) {
      alert('⚡ Auto-start outreach: calling now (sim).');
      try { 
        await fetch('/api/ai-call', { 
          method: 'POST', 
          headers: { 'Content-Type': 'application/json' }, 
          body: JSON.stringify({ 
            leadId: created.id, 
            phoneNumber: created.phone, 
            method: 'call', 
            routing, 
            metadata: routing.metadata.call 
          }) 
        }).catch(() => {}); 
      } catch {}
    }
  };

  const deleteLead = async (leadId) => {
    if (!confirm('Delete this lead?')) return;
    try { 
      await fetch(`/api/leads/${leadId}`, { method: 'DELETE' }).catch(() => {}); 
    } catch {}
    setLeads(prev => prev.filter(l => l.id !== leadId));
  };

  return (
    <div className="space-y-6 fade-in">
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <h3 className="text-lg lg:text-xl font-bold">Lead Pipeline</h3>
          <div className="flex flex-wrap gap-2">
            <button onClick={() => setShowAddLead(true)} 
                    className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl hover:bg-purple-200 transition-all text-sm">
              ➕ Add Lead
            </button>

            <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'csv')} className="hidden" id="csv-upload-direct" />
            <label htmlFor="csv-upload-direct" 
                   className="px-3 py-2 bg-green-100 text-green-700 rounded-xl hover:bg-green-200 transition-all text-sm cursor-pointer">
              📊 Upload CSV
            </label>

            <input type="file" accept=".pdf" onChange={(e) => handleFileUpload(e, 'pdf')} className="hidden" id="pdf-upload-direct" />
            <label htmlFor="pdf-upload-direct" 
                   className="px-3 py-2 bg-red-100 text-red-700 rounded-xl hover:bg-red-200 transition-all text-sm cursor-pointer">
              📄 Scan PDF → CSV
            </label>

            <button onClick={() => setShowImportModal(true)} 
                    className="px-3 py-2 bg-blue-100 text-blue-700 rounded-xl hover:bg-blue-200 transition-all text-sm">
              📋 Import Options
            </button>
            <button onClick={() => setShowTestModal(true)} 
                    className="px-3 py-2 bg-amber-100 text-amber-700 rounded-xl hover:bg-amber-200 transition-all text-sm">
              🧪 Test System
            </button>
          </div>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
          <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={filterMarket} 
                  onChange={(e) => setFilterMarket(e.target.value)}>
            <option value="">All Markets</option>
            {Object.keys(MARKET_OPTIONS).map(m => <option key={m} value={m}>{m}</option>)}
          </select>
          <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={filterType} 
                  onChange={(e) => setFilterType(e.target.value)}>
            <option value="">All Sub-Types</option>
            {Object.values(MARKET_OPTIONS).flat().map(t => <option key={t} value={t}>{t}</option>)}
          </select>
          <input type="text" 
                 className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                 placeholder="Search leads…" 
                 value={searchTerm} 
                 onChange={(e) => setSearchTerm(e.target.value)} />
          <select className="p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={filterStatus} 
                  onChange={(e) => setFilterStatus(e.target.value)}>
            <option value="">All Status</option>
            {STATUS_LABELS.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
        </div>

        <div className="space-y-4">
          {filteredLeads.map(lead => (
            <div key={lead.id} className="p-4 border border-gray-200 rounded-xl hover:border-blue-300 transition-all">
              <div className="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
                <div>
                  <button onClick={() => openLeadEditor(lead)} 
                          className="font-semibold text-lg text-left hover:underline">
                    {lead.name}
                  </button>
                  <div className="text-sm text-gray-600">
                    {lead.phone || '—'} • {lead.email || '—'}
                  </div>
                  {/* NEW: Show health conditions if present */}
                  {lead.healthConditions && (
                    <div className="text-xs text-orange-600 mt-1">
                      🏥 Health: {lead.healthConditions}
                    </div>
                  )}
                </div>
                <div className="flex items-center gap-2">
                  <span className={`badge ${
                    lead.status === 'New' ? 'bg-blue-100 text-blue-800' :
                    lead.status === 'Contacted' ? 'bg-orange-100 text-orange-800' :
                    lead.status === 'Scheduled' ? 'bg-purple-100 text-purple-800' :
                    lead.status === 'Paid' ? 'bg-green-100 text-green-800' :
                    'bg-gray-100 text-gray-800'
                  }`}>
                    {lead.status}
                  </span>
                  {lead.isClient && (
                    <span className="badge bg-green-50 text-green-700 border border-green-200">
                      Client
                    </span>
                  )}
                  <button onClick={() => openLeadEditor(lead)} 
                          className="px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded hover:bg-blue-200">
                    ✏️ Edit
                  </button>
                  <button onClick={() => { if (confirm('Delete this lead?')) deleteLead(lead.id); }} 
                          className="px-2 py-1 text-sm bg-gray-100 text-gray-700 rounded hover:bg-gray-200">
                    🗑️
                  </button>
                </div>
              </div>
              <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                <div className="text-sm text-gray-600">
                  {lead.market}/{lead.type} • {lead.location || '—'} • {lead.time || '—'}
                </div>
                <div className="flex flex-wrap gap-2">
                  <button onClick={() => initiateContact(lead, 'call')} 
                          className="px-3 py-1 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-all text-sm">
                    📞 AI Call
                  </button>
                  <button onClick={() => initiateContact(lead, 'sms')} 
                          className="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200 transition-all text-sm">
                    💬 AI SMS
                  </button>
                  <button className="px-3 py-1 bg-purple-100 text-purple-700 rounded-lg hover:bg-purple-200 transition-all text-sm">
                    📅 Schedule
                  </button>
                </div>
              </div>
              {lead.apv ? (
                <div className="mt-2 text-xs text-gray-700">
                  APV: <strong>${Number(lead.apv).toLocaleString()}</strong> 
                  {lead.carrier ? ` • Carrier: ${lead.carrier}` : ''}
                </div>
              ) : null}
            </div>
          ))}
          {filteredLeads.length === 0 && (
            <div className="text-center py-8 text-gray-500">No leads found</div>
          )}
        </div>
      </div>

      {/* Import Modal - Keep existing */}
      {showImportModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-6 max-w-md w-full">
            <h3 className="text-xl font-bold mb-4">Import Leads</h3>
            <div className="space-y-4">
              <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                <div className="text-2xl mb-2">📄</div>
                <h4 className="font-semibold mb-2">Upload PDF</h4>
                <p className="text-sm text-gray-600 mb-3">Front-end sim. Connect OCR later.</p>
                <input type="file" accept=".pdf" onChange={(e) => handleFileUpload(e, 'pdf')} className="hidden" id="pdf-upload" />
                <label htmlFor="pdf-upload" className="px-4 py-2 bg-red-100 text-red-700 rounded-lg cursor-pointer hover:bg-red-200 transition-all">
                  Choose PDF File
                </label>
              </div>
              <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                <div className="text-2xl mb-2">📊</div>
                <h4 className="font-semibold mb-2">Upload CSV</h4>
                <p className="text-sm text-gray-600 mb-3">Preview first 200 rows.</p>
                <input type="file" accept=".csv" onChange={(e) => handleFileUpload(e, 'csv')} className="hidden" id="csv-upload" />
                <label htmlFor="csv-upload" className="px-4 py-2 bg-green-100 text-green-700 rounded-lg cursor-pointer hover:bg-green-200 transition-all">
                  Choose CSV File
                </label>
              </div>
            </div>
            <div className="flex gap-3 mt-6">
              <button onClick={() => setShowImportModal(false)} 
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">
                Close
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Test Modal - Keep existing */}
      {showTestModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-2xl p-6 max-w-md w-full">
            <h3 className="text-xl font-bold mb-4">🧪 Test Complete System</h3>
            <p className="text-gray-600 mb-4">Simulates voice, SMS, objections, scoring, and calendar.</p>
            <div className="bg-yellow-50 p-4 rounded-xl mb-4">
              <ul className="text-sm text-yellow-700 space-y-1">
                <li>• AI voice call simulation</li>
                <li>• SMS backup message</li>
                <li>• Objection handling test</li>
                <li>• Lead scoring verification</li>
                <li>• Calendar integration check</li>
              </ul>
            </div>
            <div className="flex gap-3">
              <button onClick={() => setShowTestModal(false)} 
                      className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">
                Close
              </button>
              <button onClick={() => { alert('✅ All checks passed (sim).'); setShowTestModal(false); }} 
                      className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
                Run
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Add Lead Modal */}
      {showAddLead && (
        <LeadEditorModal
          initialLead={{ ...newLead, id: 'new' }}
          onClose={() => setShowAddLead(false)}
          onSave={(lead) => {
            const isNew = lead.id === 'new';
            if (isNew) {
              const created = { 
                ...lead, 
                id: Date.now(), 
                time: new Date().toLocaleString(), 
                callLogs: lead.callLogs || [], 
                isClient: lead.status === 'Paid' 
              };
              setLeads(prev => [created, ...prev]);
              setShowAddLead(false);
              // Auto outreach if source Meta
              if (created.source === 'Meta' && automation.autoStartOnMeta) {
                alert('⚡ Auto-start outreach: calling now (sim).');
              }
            } else {
              setLeads(prev => prev.map(l => l.id === lead.id ? lead : l));
            }
          }}
        />
      )}
    </div>
  );
};

/* ---------- Lead Editor Modal (enhanced with health conditions + debt naming) ---------- */
  function LeadEditorModal({ initialLead, onClose, onSave }) {
    const [lead, setLead] = useState(() => ({
      id: initialLead.id,
      market: initialLead.market || 'Insurance',
      type: initialLead.type || '',
      source: initialLead.source || 'Manual',
      name: initialLead.name || '',
      phone: initialLead.phone || '',
      email: initialLead.email || '',
      location: initialLead.location || '',
      status: initialLead.status || 'New',
      notes: initialLead.notes || '',
      apv: initialLead.apv || '',
      apvDate: initialLead.apvDate || null,
      carrier: initialLead.carrier || '',
      isClient: !!initialLead.isClient,
      debt: initialLead.debt || { creditCards:[], mortgages:[], cars:[], others:[] },
      callLogs: initialLead.callLogs || [],
      time: initialLead.time || new Date().toLocaleString()
    }));
    const [tab, setTab] = useState('profile');

    const isInsurance = lead.market === 'Insurance';
    const showAPVSection = isInsurance && STATUS_ADVANCED.has(lead.status);

    const addDebtRow = (key)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: [ ...(prev.debt[key]||[]), { amount:'', apr:'', label:'' } ] } }));
    const updateDebtRow = (key, idx, field, value)=> {
      setLead(prev=>{
        const arr = [...(prev.debt[key]||[])];
        arr[idx] = { ...arr[idx], [field]: value };
        return { ...prev, debt: { ...prev.debt, [key]: arr } };
      });
    };
    const removeDebtRow = (key, idx)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: (prev.debt[key]||[]).filter((_,i)=>i!==idx) } }));

    const addCallLog = ()=> setLead(prev=>({ ...prev, callLogs: [{ id: Date.now(), date: new Date().toLocaleString(), direction:'outbound', result:'no_answer', recordingUrl:'', transcript:'' }, ...(prev.callLogs||[]) ] }));
    const updateCallLog = (id, field, value)=> setLead(prev=>({ ...prev, callLogs: prev.callLogs.map(c => c.id===id ? { ...c, [field]: value } : c) }));
    const onUploadRecording = (id, file)=>{
      if (!file) return;
      const url = URL.createObjectURL(file);
      updateCallLog(id, 'recordingUrl', url);
    };

    const saveLead = ()=>{
      // Paid => becomes a Client
      const isClient = lead.status === 'Paid';
      const apvDate = showAPVSection && lead.apv && !lead.apvDate ? new Date().toISOString() : lead.apvDate;
      onSave({ ...lead, isClient, apvDate });
      onClose();
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl p-6 max-w-4xl w-full">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-xl font-bold">Lead — {lead.name || 'New'}</h3>
            <button onClick={onClose} className="px-3 py-1 rounded bg-gray-100">Close</button>
          </div>

          <div className="flex gap-2 flex-wrap mb-4">
            {['profile','status','debt','notes','calls'].map(t=>(
              <button key={t} onClick={()=>setTab(t)} className={`px-3 py-2 rounded ${tab===t ? 'bg-blue-600 text-white':'bg-gray-100'}`}>
                {t==='profile'?'Profile':t==='status'?'Status & APV':t==='debt'?'Debt Worksheet':t==='notes'?'Notes':'Calls'}
              </button>
            ))}
          </div>

          {/* PROFILE */}
          {tab==='profile' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Market</label>
                <select className="w-full p-3 border rounded-xl" value={lead.market} onChange={(e)=>setLead(prev=>({...prev, market:e.target.value, type:''}))}>
                  {Object.keys(MARKET_OPTIONS).map(m=><option key={m} value={m}>{m}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Sub-Type</label>
                <select className="w-full p-3 border rounded-xl" value={lead.type} onChange={(e)=>setLead(prev=>({...prev, type:e.target.value}))}>
                  <option value="">Choose…</option>
                  {(MARKET_OPTIONS[lead.market]||[]).map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Source</label>
                <select className="w-full p-3 border rounded-xl" value={lead.source} onChange={(e)=>setLead(prev=>({...prev, source:e.target.value}))}>
                  {['Manual','Meta','Website','Other'].map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Status</label>
                <select className="w-full p-3 border rounded-xl" value={lead.status} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                  {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-1">Name</label>
                <input className="w-full p-3 border rounded-xl" value={lead.name} onChange={(e)=>setLead(prev=>({...prev, name:e.target.value}))}/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Phone</label>
                <input className="w-full p-3 border rounded-xl" value={lead.phone} onChange={(e)=>setLead(prev=>({...prev, phone:e.target.value}))}/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Email</label>
                <input className="w-full p-3 border rounded-xl" value={lead.email} onChange={(e)=>setLead(prev=>({...prev, email:e.target.value}))}/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Location</label>
                <input className="w-full p-3 border rounded-xl" value={lead.location} onChange={(e)=>setLead(prev=>({...prev, location:e.target.value}))}/>
              </div>

              {/* Conditional APV/Carrier quick note */}
              {showAPVSection && (
                <div className="md:col-span-2 bg-blue-50 border border-blue-200 p-3 rounded-xl text-sm">
                  Status enables APV + Carrier fields in “Status & APV” tab.
                </div>
              )}
            </div>
          )}

          {/* STATUS + APV */}
          {tab==='status' && (
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Status</label>
                  <select className="w-full p-3 border rounded-xl" value={lead.status} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                    {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Carrier (Insurance)</label>
                  <input className="w-full p-3 border rounded-xl" value={lead.carrier || ''} onChange={(e)=>setLead(prev=>({...prev, carrier:e.target.value}))} disabled={!showAPVSection}/>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">APV ($)</label>
                  <input type="number" className="w-full p-3 border rounded-xl" value={lead.apv || ''} onChange={(e)=>setLead(prev=>({...prev, apv:e.target.value}))} disabled={!showAPVSection}/>
                </div>
              </div>
              <div className="text-xs text-gray-600">Tip: When status changes to <strong>Paid</strong>, this lead is marked as a <strong>Client</strong>.</div>
            </div>
          )}

          {/* DEBT WORKSHEET (only for Insurance/Debt Free) */}
          {tab==='debt' && lead.market==='Insurance' && lead.type==='Debt Free' && (
            <div className="space-y-4">
              {[
                ['creditCards','Credit Cards'],
                ['mortgages','Mortgage'],
                ['cars','Car Loans'],
                ['others','Other Debts']
              ].map(([key,label])=>(
                <div key={key} className="bg-gray-50 p-4 rounded-xl">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-semibold">{label}</h4>
                    <button onClick={()=>addDebtRow(key)} className="px-2 py-1 bg-white border rounded">➕ Add</button>
                  </div>
                  <div className="space-y-2">
                    {(lead.debt[key]||[]).map((row,idx)=>(
                      <div key={idx} className="grid grid-cols-1 md:grid-cols-4 gap-2">
                        {key==='others' && (
                          <input placeholder="Label (e.g., Personal Loan)" className="p-2 border rounded" value={row.label||''} onChange={(e)=>updateDebtRow(key, idx, 'label', e.target.value)}/>
                        )}
                        <input placeholder="Amount" type="number" className="p-2 border rounded" value={row.amount||''} onChange={(e)=>updateDebtRow(key, idx, 'amount', e.target.value)}/>
                        <input placeholder="APR %" type="number" className="p-2 border rounded" value={row.apr||''} onChange={(e)=>updateDebtRow(key, idx, 'apr', e.target.value)}/>
                        <button onClick={()=>removeDebtRow(key, idx)} className="px-2 py-1 bg-gray-100 rounded">Remove</button>
                      </div>
                    ))}
                    {(lead.debt[key]||[]).length===0 && <div className="text-sm text-gray-500">No entries. Click Add.</div>}
                  </div>
                </div>
              ))}
            </div>
          )}
          {tab==='debt' && !(lead.market==='Insurance' && lead.type==='Debt Free') && (
            <div className="text-gray-500">Debt worksheet is available when sub-type is <strong>Debt Free</strong> under Insurance.</div>
          )}

          {/* NOTES */}
          {tab==='notes' && (
            <div>
              <label className="block text-sm font-medium mb-1">Notes</label>
              <textarea className="w-full p-3 border rounded-xl h-40" value={lead.notes} onChange={(e)=>setLead(prev=>({...prev, notes:e.target.value}))}/>
            </div>
          )}

          {/* CALLS */}
          {tab==='calls' && (
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <h4 className="font-semibold">Call Logs</h4>
                <button onClick={addCallLog} className="px-3 py-2 bg-gray-100 rounded">➕ Add Log</button>
              </div>
              {lead.callLogs.map(log=>(
                <div key={log.id} className="p-3 border rounded-xl">
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <input className="p-2 border rounded" value={log.date} onChange={(e)=>updateCallLog(log.id,'date',e.target.value)}/>
                    <select className="p-2 border rounded" value={log.direction} onChange={(e)=>updateCallLog(log.id,'direction',e.target.value)}>
                      <option value="outbound">Outbound</option>
                      <option value="inbound">Inbound</option>
                    </select>
                    <select className="p-2 border rounded" value={log.result} onChange={(e)=>updateCallLog(log.id,'result',e.target.value)}>
                      <option value="answered">Answered</option>
                      <option value="no_answer">No Answer</option>
                      <option value="voicemail">Voicemail</option>
                      <option value="call_back">Call Back</option>
                    </select>
                    <label className="p-2 border rounded flex items-center justify-between">
                      <span>Recording</span>
                      <input type="file" accept="audio/*" onChange={(e)=>onUploadRecording(log.id, e.target.files[0])}/>
                    </label>
                  </div>
                  {log.recordingUrl && <audio controls src={log.recordingUrl} className="mt-2 w-full"></audio>}
                  <div className="mt-2">
                    <label className="block text-sm font-medium mb-1">Transcript</label>
                    <textarea className="w-full p-2 border rounded h-24" value={log.transcript} onChange={(e)=>updateCallLog(log.id,'transcript',e.target.value)}/>
                  </div>
                </div>
              ))}
              {lead.callLogs.length===0 && <div className="text-sm text-gray-500">No call logs.</div>}
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button onClick={saveLead} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:shadow-lg">Save</button>
            <button onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50">Cancel</button>
          </div>
        </div>
      </div>
    );
  }

/* ---------- Voice + SMS (enhanced with recordings + simplified callbacks) ---------- */
const VoiceAI = () => {
  const [local, setLocal] = useState(voiceSettings);
  
  useEffect(() => { 
    setLocal(voiceSettings); 
  }, [voiceSettings]);
  
  const voices = VOICE_CATALOG[local.provider] || [];
  
  const saveVoiceSettings = () => { 
    setVoiceSettings(local); 
    saveNow(); 
    alert('✅ Voice settings saved.'); 
  };

  return (
    <div className="space-y-6 fade-in">
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <h3 className="text-xl font-bold mb-4">🎙️ Voice AI Configuration</h3>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-4">
            <div>
              <label className="block font-medium mb-2">Voice Provider</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                      value={local.provider} 
                      onChange={(e) => setLocal(prev => ({ ...prev, provider: e.target.value, voice: '' }))}>
                <option value="elevenlabs">ElevenLabs</option>
                <option value="openai">OpenAI Voice</option>
                <option value="azure">Azure Speech</option>
                <option value="google">Google Cloud Speech</option>
              </select>
            </div>
            
            <div>
              <label className="block font-medium mb-2">Voice</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                      value={local.voice} 
                      onChange={(e) => setLocal(prev => ({ ...prev, voice: e.target.value }))}>
                <option value="">Select…</option>
                {voices.map(v => <option key={v} value={v}>{v}</option>)}
              </select>
            </div>
            
            <div>
              <label className="block font-medium mb-2">Style</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                      value={local.style} 
                      onChange={(e) => setLocal(prev => ({ ...prev, style: e.target.value }))}>
                <option value="professional">Professional</option>
                <option value="friendly">Friendly</option>
                <option value="authoritative">Authoritative</option>
                <option value="conversational">Conversational</option>
              </select>
            </div>
            
            <div>
              <label className="block font-medium mb-2">Response Speed</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                      value={local.speed} 
                      onChange={(e) => setLocal(prev => ({ ...prev, speed: e.target.value }))}>
                <option value="fast">Fast (0.5–1s)</option>
                <option value="normal">Normal (1–2s)</option>
                <option value="thoughtful">Thoughtful (2–3s)</option>
              </select>
            </div>
            
            <div>
              <label className="block font-medium mb-2">Time Between Calls</label>
              <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                      value={local.callInterval} 
                      onChange={(e) => setLocal(prev => ({ ...prev, callInterval: parseInt(e.target.value) }))}>
                <option value="15">15 minutes</option>
                <option value="30">30 minutes</option>
                <option value="60">1 hour</option>
                <option value="120">2 hours</option>
                <option value="240">4 hours</option>
                <option value="1440">1 day</option>
              </select>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block font-medium mb-2">Time Zone</label>
                <select className="w-full p-3 border rounded-xl" 
                        value={local.timezone} 
                        onChange={(e) => setLocal(prev => ({ ...prev, timezone: e.target.value }))}>
                  {US_TZ.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                </select>
              </div>
              <div>
                <label className="block font-medium mb-2">Business Hours</label>
                <div className="flex gap-2">
                  <input type="time" 
                         className="flex-1 p-2 border rounded-xl" 
                         value={local.businessHours?.start || '09:00'}
                         onChange={(e) => setLocal(prev => ({ 
                           ...prev, 
                           businessHours: { ...prev.businessHours, start: e.target.value } 
                         }))} />
                  <input type="time" 
                         className="flex-1 p-2 border rounded-xl" 
                         value={local.businessHours?.end || '17:00'}
                         onChange={(e) => setLocal(prev => ({ 
                           ...prev, 
                           businessHours: { ...prev.businessHours, end: e.target.value } 
                         }))} />
                </div>
              </div>
            </div>
          </div>

          <div className="space-y-4">
            {/* SIMPLIFIED: Combined callback settings */}
            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl">
              <h4 className="font-semibold mb-3 text-blue-800">📞 Immediate Callback Settings</h4>
              
              <div className="space-y-3">
                <label className="flex items-center justify-between p-3 bg-white rounded-xl border">
                  <div>
                    <span className="font-medium text-sm">Enable Immediate Callbacks</span>
                    <p className="text-xs text-gray-600">For both no-answer and voicemail</p>
                  </div>
                  <div className={`toggle-switch ${local.immediateCallbacks ? 'active' : ''}`} 
                       onClick={() => setLocal(prev => ({ ...prev, immediateCallbacks: !prev.immediateCallbacks }))}>
                    <div className="toggle-slider"></div>
                  </div>
                </label>

                {local.immediateCallbacks && (
                  <>
                    <div>
                      <label className="block font-medium mb-2 text-sm">Callback Attempts</label>
                      <select className="w-full p-3 border rounded-xl" 
                              value={local.callbackAttempts || 2}
                              onChange={(e) => setLocal(prev => ({ ...prev, callbackAttempts: parseInt(e.target.value) }))}>
                        <option value="1">1 time</option>
                        <option value="2">2 times</option>
                        <option value="3">3 times</option>
                      </select>
                    </div>

                    <label className="flex items-center justify-between p-3 bg-white rounded-xl border">
                      <div>
                        <span className="font-medium text-sm">Leave Voicemail</span>
                        <p className="text-xs text-gray-600">On final callback attempt only</p>
                      </div>
                      <div className={`toggle-switch ${local.leaveVoicemail ? 'active' : ''}`} 
                           onClick={() => setLocal(prev => ({ ...prev, leaveVoicemail: !prev.leaveVoicemail }))}>
                        <div className="toggle-slider"></div>
                      </div>
                    </label>

                    <label className="flex items-center justify-between p-3 bg-white rounded-xl border">
                      <div>
                        <span className="font-medium text-sm">Send SMS After Final Attempt</span>
                        <p className="text-xs text-gray-600">Only after all callbacks are complete</p>
                      </div>
                      <div className={`toggle-switch ${local.sendSMSAfterCallbacks ? 'active' : ''}`} 
                           onClick={() => setLocal(prev => ({ ...prev, sendSMSAfterCallbacks: !prev.sendSMSAfterCallbacks }))}>
                        <div className="toggle-slider"></div>
                      </div>
                    </label>
                  </>
                )}
              </div>
            </div>

            {/* NEW: Call Recording & Transcription */}
            <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
              <h4 className="font-semibold mb-3 text-green-800">🎙️ Recording & Transcription</h4>
              
              <div className="space-y-3">
                <label className="flex items-center justify-between p-3 bg-white rounded-xl border">
                  <div>
                    <span className="font-medium text-sm">Record All Calls</span>
                    <p className="text-xs text-gray-600">Automatically record conversations</p>
                  </div>
                  <div className={`toggle-switch ${local.recordCalls ? 'active' : ''}`} 
                       onClick={() => setLocal(prev => ({ ...prev, recordCalls: !prev.recordCalls }))}>
                    <div className="toggle-slider"></div>
                  </div>
                </label>

                <label className="flex items-center justify-between p-3 bg-white rounded-xl border">
                  <div>
                    <span className="font-medium text-sm">Auto-Transcribe</span>
                    <p className="text-xs text-gray-600">Convert speech to text automatically</p>
                  </div>
                  <div className={`toggle-switch ${local.autoTranscribe ? 'active' : ''}`}

  /* ---------- Objections ---------- */
  const ObjectionHandling = () => {
    const [newObjection, setNewObjection] = useState({ objection:'', response:'' });
    const addObjection = () => {
      if (!newObjection.objection || !newObjection.response) { alert('Fill both fields'); return; }
      const obj = { id: Date.now(), ...newObjection };
      setObjections(prev=>[...prev, obj]); saveNow({ objections: [...objections, obj] });
      setNewObjection({ objection:'', response:'' });
      alert('✅ Objection added.');
    };
    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h2 className="text-2xl font-bold mb-4">💬 Objection Handling</h2>
          <div className="bg-gray-50 p-4 rounded-xl mb-6">
            <h4 className="font-semibold mb-3">Add New Objection</h4>
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium mb-1">Common Objection</label>
                <input type="text" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="e.g., I can't afford it right now" value={newObjection.objection} onChange={(e)=>setNewObjection(prev=>({...prev, objection:e.target.value}))}/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">AI Response</label>
                <textarea className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 h-24 resize-none" placeholder="Write a helpful, empathetic response..." value={newObjection.response} onChange={(e)=>setNewObjection(prev=>({...prev, response:e.target.value}))}/>
              </div>
              <button onClick={addObjection} className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl hover:shadow-lg transition-all">➕ Add Objection</button>
            </div>
          </div>

          <div className="space-y-3">
            <h4 className="font-semibold">Current Objections ({objections.length})</h4>
            {objections.map(obj=>(
              <div key={obj.id} className="p-4 border border-gray-200 rounded-xl">
                <div className="font-semibold text-red-600 mb-2">"{obj.objection}"</div>
                <div className="text-sm text-gray-700 bg-green-50 p-3 rounded-lg"><strong>Response:</strong> {obj.response}</div>
              </div>
            ))}
            {objections.length===0 && <div className="text-center py-6 text-gray-500">No objections yet.</div>}
          </div>
        </div>
      </div>
    );
  };

  /* ---------- Campaigns (deletable) ---------- */
  const CampaignManager = () => {
    const deleteCampaign = (id)=>{
      if (!confirm('Delete this campaign?')) return;
      const next = campaigns.filter(c=>c.id!==id);
      setCampaigns(next); saveNow({ campaigns: next });
    };
    return (
      <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
        <h2 className="text-2xl font-bold mb-4">📈 Campaign Manager</h2>
        <div className="space-y-4">
          {campaigns.map(c=>(
            <div key={c.id} className="p-4 border border-gray-200 rounded-xl">
              <div className="flex justify-between items-start">
                <div>
                  <div className="font-semibold">{c.name}</div>
                  <div className="text-sm text-gray-600">{c.market}/{c.type} • ${c.budget}/day</div>
                </div>
                <div className="flex items-center gap-2">
                  <span className={`badge ${c.status==='active'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}`}>{c.status}</span>
                  <button onClick={()=>deleteCampaign(c.id)} className="px-2 py-1 bg-gray-100 rounded text-sm">🗑️</button>
                </div>
              </div>
              <div className="mt-2 text-sm">{c.leads} leads • ${c.costPerLead} CPL</div>
            </div>
          ))}
          {campaigns.length===0 && <div className="text-gray-500">No campaigns yet.</div>}
        </div>
      </div>
    );
  };

/* ---------- Analytics (enhanced with week/month/year breakdown) ---------- */
const Analytics = () => {
  const [timeframe, setTimeframe] = useState('week'); // week, month, year
  
  // Helper functions for date calculations
  const now = new Date();
  const getDateRange = (period) => {
    const end = new Date(now);
    const start = new Date(now);
    
    switch(period) {
      case 'week':
        start.setDate(now.getDate() - 7);
        break;
      case 'month':
        start.setDate(now.getDate() - 30);
        break;
      case 'year':
        start.setDate(now.getDate() - 365);
        break;
      default:
        start.setDate(now.getDate() - 7);
    }
    
    return { start, end };
  };

  // Filter data by timeframe
  const filterByTimeframe = (items, dateField = 'time') => {
    const { start, end } = getDateRange(timeframe);
    return items.filter(item => {
      const itemDate = new Date(item[dateField] || item.createdAt || item.time || Date.now());
      return itemDate >= start && itemDate <= end;
    });
  };

  // Calculate metrics for current timeframe
  const filteredLeads = filterByTimeframe(leads);
  const filteredCampaigns = filterByTimeframe(campaigns, 'createdAt');
  
  const metrics = {
    // Lead Metrics
    totalLeads: filteredLeads.length,
    newLeads: filteredLeads.filter(l => l.status === 'New').length,
    contactedLeads: filteredLeads.filter(l => l.status === 'Contacted').length,
    qualifiedLeads: filteredLeads.filter(l => l.status === 'Qualified').length,
    scheduledLeads: filteredLeads.filter(l => l.status === 'Scheduled').length,
    paidLeads: filteredLeads.filter(l => l.status === 'Paid').length,
    
    // Conversion Metrics
    contactRate: filteredLeads.length > 0 ? ((filteredLeads.filter(l => ['Contacted', 'Qualified', 'Scheduled', 'Paid'].includes(l.status)).length / filteredLeads.length) * 100).toFixed(1) : 0,
    qualificationRate: filteredLeads.length > 0 ? ((filteredLeads.filter(l => ['Qualified', 'Scheduled', 'Paid'].includes(l.status)).length / filteredLeads.length) * 100).toFixed(1) : 0,
    schedulingRate: filteredLeads.length > 0 ? ((filteredLeads.filter(l => ['Scheduled', 'Paid'].includes(l.status)).length / filteredLeads.length) * 100).toFixed(1) : 0,
    conversionRate: filteredLeads.length > 0 ? ((filteredLeads.filter(l => l.status === 'Paid').length / filteredLeads.length) * 100).toFixed(1) : 0,
    
    // Revenue Metrics
    totalRevenue: filteredLeads.reduce((sum, l) => sum + (Number(l.apv) || 0), 0),
    avgDealSize: filteredLeads.filter(l => l.apv).length > 0 ? (filteredLeads.reduce((sum, l) => sum + (Number(l.apv) || 0), 0) / filteredLeads.filter(l => l.apv).length).toFixed(0) : 0,
    
    // Campaign Metrics
    activeCampaigns: campaigns.filter(c => c.status === 'active').length,
    totalAdSpend: filteredCampaigns.reduce((sum, c) => sum + (Number(c.budget) || 0) * 30, 0), // Estimate monthly spend
    avgCostPerLead: filteredLeads.length > 0 ? (filteredCampaigns.reduce((sum, c) => sum + (Number(c.budget) || 0) * 30, 0) / filteredLeads.length).toFixed(2) : 0,
    
    // Communication Metrics
    totalCallLogs: filteredLeads.reduce((sum, l) => sum + (l.callLogs?.length || 0), 0),
    answeredCalls: filteredLeads.reduce((sum, l) => sum + (l.callLogs?.filter(log => log.result === 'answered').length || 0), 0),
    voicemails: filteredLeads.reduce((sum, l) => sum + (l.callLogs?.filter(log => log.result === 'voicemail').length || 0), 0),
    
    // Health Metrics (for insurance leads)
    leadsWithHealthConditions: filteredLeads.filter(l => l.healthConditions && l.healthConditions.trim()).length,
    
    // Debt Free Metrics (for debt free leads)
    debtFreeLeads: filteredLeads.filter(l => l.market === 'Insurance' && l.type === 'Debt Free').length,
    totalDebtTracked: filteredLeads.reduce((sum, l) => {
      if (l.debt) {
        return sum + Object.values(l.debt).flat().reduce((debtSum, item) => debtSum + (Number(item.amount) || 0), 0);
      }
      return sum;
    }, 0)
  };

  // Calculate call metrics
  const callAnswerRate = metrics.totalCallLogs > 0 ? ((metrics.answeredCalls / metrics.totalCallLogs) * 100).toFixed(1) : 0;
  const voicemailRate = metrics.totalCallLogs > 0 ? ((metrics.voicemails / metrics.totalCallLogs) * 100).toFixed(1) : 0;

  const Money = (n) => `$${new Intl.NumberFormat().format(Number(n || 0))}`;
  const Percent = (n) => `${n}%`;

  return (
    <div className="space-y-6 fade-in">
      {/* Header with Timeframe Selector */}
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
          <div>
            <h2 className="text-2xl font-bold mb-2">📊 Analytics & Reporting</h2>
            <p className="text-gray-600">Performance insights for the selected timeframe</p>
          </div>
          
          <div className="flex gap-2">
            {[
              { key: 'week', label: 'This Week' },
              { key: 'month', label: 'Last 30 Days' },
              { key: 'year', label: 'Last Year' }
            ].map(period => (
              <button key={period.key}
                      onClick={() => setTimeframe(period.key)}
                      className={`px-4 py-2 rounded-xl font-medium transition-all ${
                        timeframe === period.key 
                          ? 'bg-blue-600 text-white shadow-lg' 
                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                      }`}>
                {period.label}
              </button>
            ))}
          </div>
        </div>

        {/* Key Performance Indicators */}
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div className="text-center p-4 bg-blue-50 rounded-xl border border-blue-200">
            <div className="text-3xl font-bold text-blue-600">{metrics.totalLeads}</div>
            <div className="text-sm text-blue-800">Total Leads</div>
            <div className="text-xs text-blue-600 mt-1">↗ {metrics.newLeads} new</div>
          </div>
          
          <div className="text-center p-4 bg-green-50 rounded-xl border border-green-200">
            <div className="text-3xl font-bold text-green-600">{Money(metrics.totalRevenue)}</div>
            <div className="text-sm text-green-800">Total Revenue</div>
            <div className="text-xs text-green-600 mt-1">{Money(metrics.avgDealSize)} avg deal</div>
          </div>
          
          <div className="text-center p-4 bg-purple-50 rounded-xl border border-purple-200">
            <div className="text-3xl font-bold text-purple-600">{Percent(metrics.conversionRate)}</div>
            <div className="text-sm text-purple-800">Conversion Rate</div>
            <div className="text-xs text-purple-600 mt-1">{metrics.paidLeads} conversions</div>
          </div>
          
          <div className="text-center p-4 bg-orange-50 rounded-xl border border-orange-200">
            <div className="text-3xl font-bold text-orange-600">{Money(metrics.avgCostPerLead)}</div>
            <div className="text-sm text-orange-800">Cost Per Lead</div>
            <div className="text-xs text-orange-600 mt-1">{Money(metrics.totalAdSpend)} total spend</div>
          </div>
        </div>
      </div>

      {/* Lead Pipeline Analytics */}
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <h3 className="text-xl font-bold mb-4">🎯 Lead Pipeline Performance</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
          {[
            { label: 'New', value: metrics.newLeads, color: 'bg-blue-100 text-blue-800', icon: '📥' },
            { label: 'Contacted', value: metrics.contactedLeads, color: 'bg-yellow-100 text-yellow-800', icon: '📞' },
            { label: 'Qualified', value: metrics.qualifiedLeads, color: 'bg-indigo-100 text-indigo-800', icon: '✅' },
            { label: 'Scheduled', value: metrics.scheduledLeads, color: 'bg-purple-100 text-purple-800', icon: '📅' },
            { label: 'Paid', value: metrics.paidLeads, color: 'bg-green-100 text-green-800', icon: '💰' }
          ].map(stage => (
            <div key={stage.label} className="text-center p-4 border rounded-xl">
              <div className="text-2xl mb-2">{stage.icon}</div>
              <div className="text-2xl font-bold">{stage.value}</div>
              <div className={`inline-block px-2 py-1 rounded-full text-xs font-medium mt-1 ${stage.color}`}>
                {stage.label}
              </div>
            </div>
          ))}
        </div>

        {/* Conversion Rates */}
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="bg-gray-50 p-4 rounded-xl text-center">
            <div className="text-lg font-bold">{Percent(metrics.contactRate)}</div>
            <div className="text-sm text-gray-600">Contact Rate</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-xl text-center">
            <div className="text-lg font-bold">{Percent(metrics.qualificationRate)}</div>
            <div className="text-sm text-gray-600">Qualification Rate</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-xl text-center">
            <div className="text-lg font-bold">{Percent(metrics.schedulingRate)}</div>
            <div className="text-sm text-gray-600">Scheduling Rate</div>
          </div>
          <div className="bg-gray-50 p-4 rounded-xl text-center">
            <div className="text-lg font-bold">{Percent(metrics.conversionRate)}</div>
            <div className="text-sm text-gray-600">Final Conversion</div>
          </div>
        </div>
      </div>

      {/* Communication Analytics */}
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <h3 className="text-xl font-bold mb-4">📞 Communication Performance</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
          <div className="text-center p-4 bg-green-50 rounded-xl">
            <div className="text-2xl font-bold text-green-600">{metrics.totalCallLogs}</div>
            <div className="text-sm text-green-800">Total Calls Made</div>
          </div>
          
          <div className="text-center p-4 bg-blue-50 rounded-xl">
            <div className="text-2xl font-bold text-blue-600">{metrics.answeredCalls}</div>
            <div className="text-sm text-blue-800">Calls Answered</div>
            <div className="text-xs text-blue-600 mt-1">{callAnswerRate}% answer rate</div>
          </div>
          
          <div className="text-center p-4 bg-orange-50 rounded-xl">
            <div className="text-2xl font-bold text-orange-600">{metrics.voicemails}</div>
            <div className="text-sm text-orange-800">Voicemails Left</div>
            <div className="text-xs text-orange-600 mt-1">{voicemailRate}% voicemail rate</div>
          </div>
          
          <div className="text-center p-4 bg-purple-50 rounded-xl">
            <div className="text-2xl font-bold text-purple-600">{metrics.activeCampaigns}</div>
            <div className="text-sm text-purple-800">Active Campaigns</div>
          </div>
        </div>
      </div>

      {/* Market-Specific Analytics */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Insurance-Specific Metrics */}
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h3 className="text-xl font-bold mb-4">🏥 Insurance Analytics</h3>
          
          <div className="space-y-4">
            <div className="flex justify-between items-center p-3 bg-blue-50 rounded-xl">
              <span className="font-medium">Leads with Health Conditions</span>
              <span className="font-bold text-blue-600">{metrics.leadsWithHealthConditions}</span>
            </div>
            
            <div className="flex justify-between items-center p-3 bg-green-50 rounded-xl">
              <span className="font-medium">Debt Free Leads</span>
              <span className="font-bold text-green-600">{metrics.debtFreeLeads}</span>
            </div>
            
            <div className="flex justify-between items-center p-3 bg-purple-50 rounded-xl">
              <span className="font-medium">Total Debt Tracked</span>
              <span className="font-bold text-purple-600">{Money(metrics.totalDebtTracked)}</span>
            </div>

            {/* Insurance sub-type breakdown */}
            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-3">Insurance Type Breakdown</h4>
              {Object.keys(MARKET_OPTIONS.Insurance || {}).map(subType => {
                const count = filteredLeads.filter(l => l.market === 'Insurance' && l.type === subType).length;
                const revenue = filteredLeads.filter(l => l.market === 'Insurance' && l.type === subType).reduce((sum, l) => sum + (Number(l.apv) || 0), 0);
                
                return count > 0 ? (
                  <div key={subType} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                    <span className="text-sm">{subType}</span>
                    <div className="text-right">
                      <div className="font-medium">{count} leads</div>
                      <div className="text-xs text-gray-600">{Money(revenue)}</div>
                    </div>
                  </div>
                ) : null;
              })}
            </div>
          </div>
        </div>

        {/* Revenue Analytics */}
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h3 className="text-xl font-bold mb-4">💰 Revenue Analytics</h3>
          
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div className="text-center p-4 bg-green-50 rounded-xl">
                <div className="text-2xl font-bold text-green-600">{Money(metrics.totalRevenue)}</div>
                <div className="text-sm text-green-800">Total Revenue</div>
              </div>
              
              <div className="text-center p-4 bg-blue-50 rounded-xl">
                <div className="text-2xl font-bold text-blue-600">{Money(metrics.avgDealSize)}</div>
                <div className="text-sm text-blue-800">Avg Deal Size</div>
              </div>
            </div>

            {/* Revenue by Market */}
            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-3">Revenue by Market</h4>
              {Object.keys(MARKET_OPTIONS).map(market => {
                const revenue = filteredLeads.filter(l => l.market === market).reduce((sum, l) => sum + (Number(l.apv) || 0), 0);
                const deals = filteredLeads.filter(l => l.market === market && l.apv).length;
                
                return revenue > 0 ? (
                  <div key={market} className="flex justify-between items-center py-2 border-b border-gray-200 last:border-b-0">
                    <span className="text-sm font-medium">{market}</span

  /* ---------- Inbound Center (unchanged core) ---------- */
  const InboundCenter = () => {
    const [autoMatchUnknown, setAutoMatchUnknown] = useState(true);
    const [testing, setTesting] = useState(false);

    const matchLeadByPhone = (num) => {
      const clean = (num||'').replace(/\D/g,'');
      return leads.find(l => (l.phone||'').replace(/\D/g,'') === clean);
    };

    const handleInbound = async (evt) => {
      let matched = matchLeadByPhone(evt.from);
      let askName = false;
      if (!matched && autoMatchUnknown) {
        const nameMatch = (evt.text||'').match(/\b(I'm|I am|This is)\s+([A-Z][a-zA-Z]+)\b/);
        if (nameMatch) matched = leads.find(l=> (l.name||'').toLowerCase().includes(nameMatch[2].toLowerCase()));
        if (!matched) askName = true;
      }
      const record = { id: Date.now(), ...evt, time: new Date().toLocaleString(), matchedLeadId: matched?.id, status:'received', askName };
      setInboundEvents(prev => [record, ...prev]); saveNow({ inbound: [record, ...inboundEvents] });
      try { await fetch('/api/inbound', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ event: record, routing, metadata: evt.type==='call'? routing.metadata.call : routing.metadata.sms }) }).catch(()=>{}); } catch {}
    };

    useEffect(()=>{
      let stop=false;
      (async ()=>{
        if (testing) {
          await new Promise(r=>setTimeout(r, 1000));
          if (!stop) handleInbound({ type:'sms', from:'+1 (555) 333-1212', to:'+1 (555) 111-0000', text:'Hey this is Chris, calling back about the quote' });
        }
      })();
      return ()=>{ stop=true; };
    },[testing]);

    const copy = async (text)=>{ try{ await navigator.clipboard.writeText(text); alert('Copied'); } catch{} };
    const webhookBase = window.location.origin || 'https://your-server.com';

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h3 className="text-xl font-bold mb-4">📞 Inbound Center</h3>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              <div className="bg-gray-50 p-4 rounded-xl">
                <h4 className="font-semibold mb-2">Webhooks (configure at Twilio/Vonage)</h4>
                <div className="text-sm">
                  <div className="flex items-center justify-between mb-2"><span>Inbound Call URL</span><button onClick={()=>copy(`${webhookBase}/webhooks/inbound/call`)} className="text-blue-600 text-sm">Copy</button></div>
                  <code className="inline block mb-2">{webhookBase}/webhooks/inbound/call</code>
                </div>
                <div className="text-sm">
                  <div className="flex items-center justify-between mb-2"><span>Inbound SMS URL</span><button onClick={()=>copy(`${webhookBase}/webhooks/inbound/sms`)} className="text-blue-600 text-sm">Copy</button></div>
                  <code className="inline block">{webhookBase}/webhooks/inbound/sms</code>
                </div>
              </div>
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div>
                  <div className="font-medium">Auto-match unknown callers</div>
                  <div className="text-xs text-gray-600">Try number/name; otherwise ask their name</div>
                </div>
                <div className={`toggle-switch ${autoMatchUnknown ? 'active' : ''}`} onClick={()=>setAutoMatchUnknown(!autoMatchUnknown)}><div className="toggle-slider"></div></div>
              </div>
              <button onClick={()=>setTesting(v=>!v)} className="w-full p-3 bg-gradient-to-r from-orange-500 to-red-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">{testing ? '⏹️ Stop Simulated Inbound' : '▶️ Simulate Inbound'}</button>
            </div>

            <div className="space-y-3">
              <h4 className="font-semibold">Recent Inbound</h4>
              {inboundEvents.map(evt=>(
                <div key={evt.id} className="p-3 border rounded-xl">
                  <div className="flex justify-between">
                    <div className="font-semibold">{evt.type==='call'?'📞 Call':'💬 SMS'} from {evt.from || 'unknown'}</div>
                    <span className="text-xs text-gray-500">{evt.time}</span>
                  </div>
                  {evt.text && <div className="text-sm text-gray-700 mt-1">“{evt.text}”</div>}
                  <div className="text-xs text-gray-600 mt-1">Matched lead: {evt.matchedLeadId ? `#${evt.matchedLeadId}` : (evt.askName ? 'ask for name' : 'not found')}</div>
                </div>
              ))}
              {inboundEvents.length===0 && <div className="text-gray-500 text-sm">No inbound yet.</div>}
            </div>
          </div>
        </div>
      </div>
    );
  };

 /* ---------- Imports (enhanced with line-by-line transfer) ---------- */
const Imports = () => {
  const [selectedImport, setSelectedImport] = useState(imports[0] || null);
  const [importsFilterPlaceholders, setImportsFilterPlaceholders] = useState(true);
  const [currentMapping, setCurrentMapping] = useState({ 
    name: '', phone: '', email: '', type: '', market: '', location: '', time: '', source: '', 
    healthConditions: '', custom1: '', custom2: '' 
  });
  const [transferInProgress, setTransferInProgress] = useState(false);
  const [transferResults, setTransferResults] = useState(null);

  useEffect(() => { 
    if (!selectedImport && imports.length) setSelectedImport(imports[0]); 
  }, [imports, selectedImport]);

  const rows0 = selectedImport?.rows || [];
  const headers = Object.keys(rows0[0] || {});
  
  const filteredRows = useMemo(() => {
    const rows = rows0;
    if (!importsFilterPlaceholders) return rows.slice(0, 200);
    
    // Filter blank lines and placeholder data
    return rows.filter(r => {
      // Skip completely blank rows
      const hasData = Object.values(r).some(val => val && val.toString().trim());
      if (!hasData) return false;
      
      // Skip placeholder rows
      const values = Object.values(r).join(' ').toLowerCase();
      return !values.includes('example') && !values.includes('(555)') && !values.includes('test@');
    }).slice(0, 200);
  }, [rows0, importsFilterPlaceholders]);

  const saveMapping = () => {
    if (!selectedImport) return;
    const updated = imports.map(i => i.id === selectedImport.id ? { 
      ...i, 
      mapped: currentMapping, 
      dropPlaceholders: importsFilterPlaceholders 
    } : i);
    setImports(updated); 
    saveNow({ imports: updated });
    alert('✅ Mapping saved.');
  };

  // NEW: Line-by-line transfer to leads
  const transferToLeads = async () => {
    if (!selectedImport || filteredRows.length === 0) {
      alert('No data to transfer');
      return;
    }

    setTransferInProgress(true);
    setTransferResults(null);

    try {
      const results = {
        processed: 0,
        created: 0,
        skipped: 0,
        errors: [],
        leads: []
      };

      // Process each row individually
      for (let i = 0; i < filteredRows.length; i++) {
        const row = filteredRows[i];
        results.processed++;

        try {
          // Check for required fields
          const name = row[currentMapping.name] || '';
          const phone = row[currentMapping.phone] || '';
          
          if (!name.trim() && !phone.trim()) {
            results.skipped++;
            continue;
          }

          // Create lead object
          const newLead = {
            id: Date.now() + i,
            name: name.trim() || 'Unknown',
            phone: phone.trim() || '',
            email: (row[currentMapping.email] || '').trim(),
            market: row[currentMapping.market] || 'Insurance',
            type: row[currentMapping.type] || 'Life',
            source: row[currentMapping.source] || 'Import',
            location: (row[currentMapping.location] || '').trim(),
            time: row[currentMapping.time] || new Date().toLocaleString(),
            status: 'New',
            healthConditions: (row[currentMapping.healthConditions] || '').trim(), // NEW
            notes: `Imported from ${selectedImport.filename}`,
            isClient: false,
            callLogs: [],
            debt: { creditCards: [], mortgages: [], cars: [], others: [] }
          };

          // Try to save to backend
          try {
            await fetch('/api/leads', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(newLead)
            }).catch(() => {
              // Backend not ready, continue with local storage
            });
          } catch (error) {
            console.log('Backend not ready, saving locally');
          }

          results.leads.push(newLead);
          results.created++;

          // Small delay to prevent overwhelming the system
          if (i % 10 === 0) {
            await new Promise(resolve => setTimeout(resolve, 100));
          }

        } catch (error) {
          results.errors.push(`Row ${i + 1}: ${error.message}`);
        }
      }

      // Update leads state
      setLeads(prev => [...results.leads, ...prev]);
      setTransferResults(results);

      alert(`✅ Transfer complete!\n` +
            `Processed: ${results.processed} rows\n` +
            `Created: ${results.created} leads\n` +
            `Skipped: ${results.skipped} rows\n` +
            `Errors: ${results.errors.length}`);

    } catch (error) {
      alert(`❌ Transfer failed: ${error.message}`);
    } finally {
      setTransferInProgress(false);
    }
  };

  const deleteImport = () => {
    if (!selectedImport) return;
    if (!confirm('Delete this import file from the list?')) return;
    const updated = imports.filter(i => i.id !== selectedImport.id);
    setImports(updated); 
    saveNow({ imports: updated });
    setSelectedImport(updated[0] || null);
  };

  return (
    <div className="space-y-6 fade-in">
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <h3 className="text-xl font-bold mb-4">📂 Imports & Field Mapping</h3>
        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <div className="space-y-3">
            <h4 className="font-semibold">Import Files</h4>
            {imports.map(imp => (
              <button key={imp.id} 
                      onClick={() => { 
                        setSelectedImport(imp); 
                        setCurrentMapping(imp.mapped || currentMapping); 
                      }}
                      className={`w-full text-left p-3 border rounded-xl hover:border-blue-300 transition-all ${
                        selectedImport?.id === imp.id ? 'border-blue-400 bg-blue-50' : ''
                      }`}>
                <div className="font-medium">{imp.filename}</div>
                <div className="text-xs text-gray-600">
                  {new Date(imp.createdAt).toLocaleString()}
                </div>
                <div className="text-xs text-blue-600 mt-1">
                  {(imp.rows || []).length} total rows
                </div>
              </button>
            ))}
            {imports.length === 0 && (
              <div className="text-sm text-gray-500">
                No imports yet. Use "Upload CSV" to get started.
              </div>
            )}
          </div>

          <div className="lg:col-span-2 space-y-4">
            {!selectedImport && (
              <div className="text-gray-500">Select an import to view rows and map fields.</div>
            )}

            {selectedImport && (
              <>
                <div className="flex items-center justify-between">
                  <div className="font-semibold">{selectedImport.filename}</div>
                  <div className="flex gap-2">
                    <label className="flex items-center gap-2 text-sm">
                      <input type="checkbox" 
                             checked={importsFilterPlaceholders} 
                             onChange={(e) => setImportsFilterPlaceholders(e.target.checked)} />
                      Filter blank lines & placeholders
                    </label>
                    <button onClick={deleteImport} 
                            className="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">
                      Delete
                    </button>
                  </div>
                </div>

                {/* Data Preview */}
                <div className="bg-gray-50 p-4 rounded-xl">
                  <div className="flex justify-between items-center mb-3">
                    <h4 className="font-semibold">Data Preview</h4>
                    <div className="text-sm text-gray-600">
                      Showing {filteredRows.length} of {rows0.length} rows
                    </div>
                  </div>
                  
                  <div className="overflow-auto border rounded-xl max-h-64">
                    <table className="min-w-full text-sm">
                      <thead className="bg-gray-100 sticky top-0">
                        <tr>
                          {headers.map(h => (
                            <th key={h} className="px-3 py-2 text-left font-medium text-gray-700">
                              {h}
                            </th>
                          ))}
                        </tr>
                      </thead>
                      <tbody>
                        {filteredRows.slice(0, 10).map((row, idx) => (
                          <tr key={idx} className="border-t">
                            {headers.map(h => (
                              <td key={h} className="px-3 py-2 max-w-32 truncate">
                                {row[h]}
                              </td>
                            ))}
                          </tr>
                        ))}
                        {filteredRows.length === 0 && (
                          <tr>
                            <td className="px-3 py-6 text-center text-gray-500" colSpan="999">
                              No valid rows found. Check filter settings.
                            </td>
                          </tr>
                        )}
                      </tbody>
                    </table>
                  </div>
                </div>

                {/* Field Mapping */}
                <div className="bg-blue-50 p-4 rounded-xl border border-blue-200">
                  <h4 className="font-semibold mb-3 text-blue-800">🔗 Field Mapping</h4>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                    {[
                      ['name', 'Lead Name'], ['phone', 'Phone Number'], ['email', 'Email Address'],
                      ['market', 'Market'], ['type', 'Sub-Type'], ['location', 'Location'], 
                      ['time', 'Date/Time'], ['source', 'Lead Source'],
                      ['healthConditions', 'Health Conditions'], ['custom1', 'Custom Field 1'], ['custom2', 'Custom Field 2']
                    ].map(([field, label]) => (
                      <div key={field}>
                        <label className="block text-sm font-medium mb-1">{label}</label>
                        <select className="w-full p-2 border rounded text-sm" 
                                value={currentMapping[field] || ''} 
                                onChange={(e) => setCurrentMapping(prev => ({ 
                                  ...prev, 
                                  [field]: e.target.value 
                                }))}>
                          <option value="">Skip Field</option>
                          {headers.map(h => <option key={h} value={h}>{h}</option>)}
                        </select>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Transfer Actions */}
                <div className="flex gap-3">
                  <button onClick={saveMapping} 
                          className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">
                    💾 Save Mapping
                  </button>
                  
                  <button onClick={transferToLeads}
                          disabled={transferInProgress || filteredRows.length === 0}
                          className="px-4 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl disabled:opacity-50">
                    {transferInProgress ? '⏳ Transferring...' : '⬆️ Transfer to Leads'}
                  </button>

                  <div className="text-sm text-gray-600 flex items-center">
                    Will transfer {filteredRows.length} rows as new leads
                  </div>
                </div>

                {/* Transfer Results */}
                {transferResults && (
                  <div className="bg-green-50 border border-green-200 p-4 rounded-xl">
                    <h4 className="font-semibold text-green-800 mb-2">Transfer Results</h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                      <div>
                        <div className="font-medium">Processed</div>
                        <div className="text-green-600">{transferResults.processed}</div>
                      </div>
                      <div>
                        <div className="font-medium">Created</div>
                        <div className="text-green-600">{transferResults.created}</div>
                      </div>
                      <div>
                        <div className="font-medium">Skipped</div>
                        <div className="text-orange-600">{transferResults.skipped}</div>
                      </div>
                      <div>
                        <div className="font-medium">Errors</div>
                        <div className="text-red-600">{transferResults.errors.length}</div>
                      </div>
                    </div>
                    
                    {transferResults.errors.length > 0 && (
                      <div className="mt-3">
                        <div className="font-medium text-red-800 mb-2">Errors:</div>
                        <div className="text-xs text-red-700 max-h-20 overflow-y-auto">
                          {transferResults.errors.map((error, idx) => (
                            <div key={idx}>{error}</div>
                          ))}
                        </div>
                      </div>
                    )}
                  </div>
                )}
              </>
            )}
          </div>
        </div>
      </div>
    </div>
  );
};
/* ---------- End of Imports ---------- */

/* ---------- Settings (enhanced with dynamic API labels) ---------- */
const Settings = () => {
  const [tab, setTab] = useState('apis');
  const [apiLabels, setApiLabels] = useState({
    openai: 'OpenAI API Key',
    meta: 'Meta Access Token', 
    elevenlabs: 'ElevenLabs API Key',
    twilio: 'Twilio Account SID',
    smsFrom: 'SMS From Number',
    voiceFrom: 'Voice From Number'
  });

  const saveAll = () => { 
    saveNow(); 
    alert('✅ Settings saved.'); 
  };
  
  const changePassword = async () => {
    const oldp = prompt('Enter current password:'); 
    if (!oldp) return;
    const newp = prompt('Enter new password:'); 
    if (!newp) return;
    const conf = prompt('Confirm new password:'); 
    if (conf !== newp) { 
      alert('Passwords do not match'); 
      return; 
    }
    
    const users = loadUsers();
    const idx = users.findIndex(x => emailEq(x.email, me.email)); 
    if (idx < 0) return alert('User not found');
    
    const oldHash = await sha256(oldp);
    if (oldHash !== users[idx].passHash) return alert('Current password incorrect');
    
    users[idx] = { ...users[idx], passHash: await sha256(newp) };
    saveUsers(users);
    alert('✅ Password changed.');
  };

  return (
    <div className="space-y-6 fade-in">
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <div className="flex gap-2 mb-4 flex-wrap">
          <button onClick={() => setTab('apis')} 
                  className={`px-3 py-2 rounded ${tab === 'apis' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
            API Keys
          </button>
          <button onClick={() => setTab('routing')} 
                  className={`px-3 py-2 rounded ${tab === 'routing' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
            AI Routing & Workers
          </button>
          <button onClick={() => setTab('automation')} 
                  className={`px-3 py-2 rounded ${tab === 'automation' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
            Automation
          </button>
          <button onClick={() => setTab('account')} 
                  className={`px-3 py-2 rounded ${tab === 'account' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
            Account
          </button>
          {me.isAdmin && (
            <button onClick={() => setTab('users')} 
                    className={`px-3 py-2 rounded ${tab === 'users' ? 'bg-blue-600 text-white' : 'bg-gray-100'}`}>
              Users (Admin)
            </button>
          )}
        </div>

        {tab === 'apis' && (
          <>
            <h3 className="text-lg lg:text-xl font-bold mb-4">API Configuration</h3>
            
            {/* Dynamic Label Editor */}
            <div className="bg-blue-50 border border-blue-200 p-4 rounded-xl mb-6">
              <h4 className="font-semibold mb-3 text-blue-800">🏷️ Customize API Labels</h4>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {Object.entries(apiLabels).map(([key, label]) => (
                  <div key={key}>
                    <label className="block text-sm font-medium mb-1">
                      {key} Label
                    </label>
                    <input className="w-full p-2 border rounded-xl text-sm" 
                           value={label}
                           onChange={(e) => setApiLabels(prev => ({ 
                             ...prev, 
                             [key]: e.target.value 
                           }))}
                           placeholder={`Label for ${key}`} />
                  </div>
                ))}
              </div>
              <p className="text-xs text-blue-600 mt-2">
                Customize these labels to match your current providers
              </p>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* API Keys with Dynamic Labels */}
              {[
                ['openai', 'sk-...', 'For ad generation & voice AI'],
                ['meta', 'EA...', 'For Facebook/Instagram campaigns'],
                ['elevenlabs', 'elevenlabs-...', 'For voice calling services'],
                ['twilio', 'AC...', 'For SMS/phone services']
              ].map(([key, placeholder, help]) => (
                <div key={key}>
                  <label className="block font-medium mb-2">{apiLabels[key]}</label>
                  <input type="password" 
                         className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" 
                         placeholder={placeholder} 
                         value={apiKeys[key]} 
                         onChange={(e) => setApiKeys(prev => ({ ...prev, [key]: e.target.value }))} />
                  <p className="text-xs text-gray-500 mt-1">{help}</p>
                </div>
              ))}

              {/* Phone Numbers */}
              <div>
                <label className="block font-medium mb-2">{apiLabels.smsFrom}</label>
                <input className="w-full p-3 border rounded-xl" 
                       placeholder="+1 555 111 0000" 
                       value={apiKeys.smsFrom} 
                       onChange={(e) => setApiKeys(prev => ({ ...prev, smsFrom: e.target.value }))} />
              </div>
              
              <div>
                <label className="block font-medium mb-2">{apiLabels.voiceFrom}</label>
                <input className="w-full p-3 border rounded-xl" 
                       placeholder="+1 555 222 0000" 
                       value={apiKeys.voiceFrom} 
                       onChange={(e) => setApiKeys(prev => ({ ...prev, voiceFrom: e.target.value }))} />
              </div>

              {/* Provider Defaults - Only show if needed */}
              <div>
                <label className="block font-medium mb-2">Default Voice Provider</label>
                <select className="w-full p-3 border rounded-xl" 
                        value={voiceSettings.provider} 
                        onChange={(e) => { 
                          setVoiceSettings(prev => ({ ...prev, provider: e.target.value, voice: '' })); 
                        }}>
                  <option value="elevenlabs">ElevenLabs</option>
                  <option value="openai">OpenAI Voice</option>
                  <option value="azure">Azure Speech</option>
                  <option value="google">Google Cloud Speech</option>
                </select>
              </div>
              
              <div>
                <label className="block font-medium mb-2">Default SMS Provider</label>
                <select className="w-full p-3 border rounded-xl" 
                        value={smsSettings.provider} 
                        onChange={(e) => { 
                          setSmsSettings(prev => ({ ...prev, provider: e.target.value })); 
                        }}>
                  <option value="twilio">Twilio</option>
                  <option value="messagebird">MessageBird</option>
                  <option value="vonage">Vonage</option>
                </select>
              </div>
            </div>
          </>
        )}

        {tab === 'routing' && (
          <>
            <h3 className="text-lg lg:text-xl font-bold mb-4">AI Model Routing & Workers</h3>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="space-y-4">
                <div className="bg-gray-50 p-4 rounded-xl">
                  <h4 className="font-semibold mb-2">AI Models</h4>
                  {[
                    ['callsModel', 'Calls/SMS brain', 'gpt-5-mini'],
                    ['callsEscalationModel', 'Escalation model', 'gpt-5'],
                    ['smsModel', 'SMS brain', 'gpt-5-mini'],
                    ['adsDraftModel', 'Ads draft model', 'gpt-5-mini'],
                    ['adsPolishModel', 'Ads polish model', 'gpt-5'],
                    ['adsImageModel', 'Ad images model', 'gpt-image-3.5']
                  ].map(([field, label, def]) => (
                    <div key={field} className="mb-2">
                      <label className="block text-sm font-medium mb-1">{label}</label>
                      <input type="text" 
                             className="w-full p-2 border rounded" 
                             value={routing[field]} 
                             onChange={(e) => setRouting(prev => ({ 
                               ...prev, 
                               [field]: e.target.value || def 
                             }))} />
                    </div>
                  ))}
                  <p className="text-xs text-gray-600 mt-2">
                    Realtime worker for calls/SMS; batch worker for ads. Isolated for performance.
                  </p>
                </div>

                <div className="bg-gray-50 p-4 rounded-xl">
                  <h4 className="font-semibold mb-2">Worker Limits</h4>
                  <div className="mb-3">
                    <div className="font-medium mb-1">Realtime (calls/SMS)</div>
                    {['maxTokens', 'timeoutMs', 'rpm', 'tpm'].map(k => (
                      <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                        <label className="text-sm text-gray-600">{k}</label>
                        <input type="number" 
                               className="p-2 border rounded" 
                               value={routing.realtimeWorker[k]} 
                               onChange={(e) => setRouting(prev => ({ 
                                 ...prev, 
                                 realtimeWorker: { 
                                   ...prev.realtimeWorker, 
                                   [k]: parseInt(e.target.value) || 0 
                                 } 
                               }))} />
                      </div>
                    ))}
                  </div>
                  
                  <div>
                    <div className="font-medium mb-1">Batch (ads copy/image)</div>
                    {['maxTokens', 'timeoutMs', 'rpm', 'tpm'].map(k => (
                      <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                        <label className="text-sm text-gray-600">{k}</label>
                        <input type="number" 
                               className="p-2 border rounded" 
                               value={routing.batchWorker[k]} 
                               onChange={(e) => setRouting(prev => ({ 
                                 ...prev, 
                                 batchWorker: { 
                                   ...prev.batchWorker, 
                                   [k]: parseInt(e.target.value) || 0 
                                 } 
                               }))} />
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="space-y-4">
                <div className="bg-gray-50 p-4 rounded-xl">
                  <h4 className="font-semibold mb-2">Usage Tracking Metadata</h4>
                  {[
                    ['call', 'call'],
                    ['sms', 'sms'],
                    ['adsCopy', 'ads-copy'],
                    ['adsImage', 'ads-image']
                  ].map(([key, def]) => (
                    <div key={key} className="mb-3">
                      <div className="text-sm font-medium mb-1">{key}</div>
                      <div className="grid grid-cols-3 gap-2 items-center">
                        <span className="text-xs text-gray-600 col-span-1">channel</span>
                        <input type="text" 
                               className="p-2 border rounded col-span-2" 
                               value={routing.metadata[key]?.channel || def} 
                               onChange={(e) => setRouting(prev => ({ 
                                 ...prev, 
                                 metadata: { 
                                   ...prev.metadata, 
                                   [key]: { 
                                     ...prev.metadata[key], 
                                     channel: e.target.value 
                                   } 
                                 } 
                               }))} />
                      </div>
                    </div>
                  ))}
                  <p className="text-xs text-gray-600">
                    Requests tagged as: <code className="inline bg-white px-1 rounded">
                      {'{channel:"call"|"sms"|"ads-copy"|"ads-image"}'}
                    </code>
                  </p>
                </div>
              </div>
            </div>
          </>
        )}

        {tab === 'automation' && (
          <div className="space-y-4">
            <h3 className="text-lg lg:text-xl font-bold">Automation Rules</h3>
            
            <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <span>Auto-start outreach when a Meta lead arrives</span>
              <div className={`toggle-switch ${automation.autoStartOnMeta ? 'active' : ''}`} 
                   onClick={() => setAutomation(prev => ({ 
                     ...prev, 
                     autoStartOnMeta: !prev.autoStartOnMeta 
                   }))}>
                <div className="toggle-slider"></div>
              </div>
            </label>
            
            <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <span>Immediate retry on No Answer</span>
              <div className={`toggle-switch ${automation.immediateRetryOnNoAnswer ? 'active' : ''}`} 
                   onClick={() => setAutomation(prev => ({ 
                     ...prev, 
                     immediateRetryOnNoAnswer: !prev.immediateRetryOnNoAnswer 
                   }))}>
                <div className="toggle-slider"></div>
              </div>
            </label>
            
            <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
              <span>Immediate retry after Voicemail</span>
              <div className={`toggle-switch ${automation.immediateRetryOnVoicemail ? 'active' : ''}`} 
                   onClick={() => setAutomation(prev => ({ 
                     ...prev, 
                     immediateRetryOnVoicemail: !prev.immediateRetryOnVoicemail 
                   }))}>
                <div className="toggle-slider"></div>
              </div>
            </label>
            
            <div className="text-xs text-gray-600">
              These work with Voice AI "immediate callback" settings.
            </div>
          </div>
        )}

        {tab === 'account' && (
          <div className="space-y-4">
            <h3 className="text-lg lg:text-xl font-bold">Account Management</h3>
            
            <div className="p-4 bg-gray-50 rounded-xl">
              <div className="text-sm text-gray-700">
                <strong>Email:</strong> {me.email}
              </div>
              <div className="text-sm text-gray-700">
                <strong>Role:</strong> {me.isAdmin ? 'Administrator' : 'User'}
              </div>
              <div className="text-sm text-gray-700">
                <strong>Last Login:</strong> {new Date().toLocaleString()}
              </div>
            </div>
            
            <div className="flex gap-2">
              <button onClick={changePassword} 
                      className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">
                Change Password
              </button>
              <button onClick={onLogout} 
                      className="px-4 py-2 bg-red-100 text-red-700 rounded-xl hover:bg-red-200">
                Logout
              </button>
            </div>
          </div>
        )}

        {tab === 'users' && me.isAdmin && (
          <UsersAdmin me={me} onImpersonate={(email) => {
            saveSession({ 
              email, 
              isAdmin: loadUsers().find(u => emailEq(u.email, email))?.isAdmin || false 
            });
            onImpersonate(email);
          }} />
        )}

        {(tab === 'apis' || tab === 'routing' || tab === 'automation') && (
          <div className="mt-6">
            <button onClick={saveAll} 
                    className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">
              💾 Save All Settings
            </button>
          </div>
        )}
      </div>
    </div>
  );
};
/* ---------- End of Settings ---------- */

  /* ---------- Utility actions used above ---------- */
  const getLeadFollowUp = (lead) => {
    // placeholder for future per-lead overrides (already exists in a previous version)
    return { enabled: true, followUpDelay: smsSettings.followUpDelay, scripts: smsSettings.scripts };
  };
  const followUpLabel = (mins)=>{
    const n = Number(mins)||0;
    if (n < 120) return `${n} minutes`;
    if (n < 24*60) return `${Math.round(n/60)} hours`;
    if (n % (7*24*60) === 0) return `${n/(7*24*60)} week`;
    return `${Math.round(n/1440)} day(s)`;
  };
  const initiateContact = async (lead, method) => {
    try {
      const f = getLeadFollowUp(lead);
      await fetch('/api/ai-call', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({
          leadId: lead.id, phoneNumber: lead.phone, method,
          routing, metadata: method==='call'? routing.metadata.call : routing.metadata.sms,
          followUp: f
        })
      }).catch(()=>{});
      alert(`✅ ${method==='call'?'Call':'SMS'} initiated (sim).\nFollow-up: ${f.enabled ? followUpLabel(f.followUpDelay) : 'OFF'}`);
    } catch { alert(`❌ ${method==='call'?'Call':'SMS'} failed.`); }
  };

  /* ---------- Mount helpers ---------- */
  function openLeadEditor(lead){
    const onClose = ()=>{ setEditor(null); };
    const onSave = (updated)=>{ setLeads(prev => prev.map(l => l.id===updated.id ? updated : l)); };
    setEditor(<LeadEditorModal initialLead={lead} onClose={onClose} onSave={onSave}/>);
  }
  const [editor, setEditor] = useState(null);

  /* ---------- Render ---------- */
  const renderContent = () => {
    switch(activeTab) {
      case 'dashboard': return <Dashboard/>;
      case 'ad-creator': return <AdCreator/>;
      case 'leads': return <LeadManagement/>;
      case 'voice-ai': return <VoiceAI/>;
      case 'objections': return <ObjectionHandling/>;
      case 'campaigns': return <CampaignManager/>;
      case 'analytics': return <Analytics/>;
      case 'inbound': return <InboundCenter/>;
      case 'imports': return <Imports/>;
      case 'settings': return <Settings/>;
      case 'admin-users': return <UsersAdmin me={me} onImpersonate={(email)=>{ saveSession({ email, isAdmin: loadUsers().find(u=>emailEq(u.email,email))?.isAdmin || false }); onImpersonate(email); }}/>;
      default: return <Dashboard/>;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
      <div className="flex flex-col lg:flex-row">
        <MobileNav/>
        <Sidebar/>
        <div className="flex-1 p-4 lg:p-8">
          <div className="mb-6 lg:mb-8">
            <h1 className="text-2xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
              {activeTab==='dashboard' && 'Dashboard Overview'}
              {activeTab==='ad-creator' && 'Professional Ad Creator'}
              {activeTab==='leads' && 'Lead Management'}
              {activeTab==='voice-ai' && 'Voice AI System'}
              {activeTab==='objections' && 'Objection Handling'}
              {activeTab==='campaigns' && 'Campaign Manager'}
              {activeTab==='analytics' && 'Analytics & Reporting'}
              {activeTab==='inbound' && 'Inbound Center'}
              {activeTab==='imports' && 'Imports & Field Mapping'}
              {activeTab==='settings' && 'Settings & Configuration'}
              {activeTab==='admin-users' && 'Users (Admin)'}
            </h1>
            <p className="text-sm lg:text-base text-gray-600">Multi-tenant workspace • Logged in as {me.email}</p>
          </div>
          {renderContent()}
        </div>
      </div>
      {editor}
    </div>
  );
}

/* =========================
   APP WRAPPER
   ========================= */
function AppWrapper(){
  const [me, setMe] = useState(null);
  useEffect(()=>{ (async ()=>{ await ensureAdmin(); const sess = loadSession(); if (sess) setMe(sess); })(); },[]);
  if (!me) return <LoginView onLoggedIn={setMe}/>;
  const logout = ()=>{ clearSession(); setMe(null); };
  const impersonate = (email)=>{ const u = loadUsers().find(x=>emailEq(x.email,email)); if (!u) return; setMe({ email: u.email, isAdmin: !!u.isAdmin }); };
  return <LeadFlowApp me={me} onLogout={logout} onImpersonate={impersonate}/>;
}

/* =========================
   CSV PARSER
   ========================= */
function parseCSV(text){
  const rows = [];
  let i=0, field='', row=[], inQuotes=false;
  const pushField=()=>{ row.push(field); field=''; };
  const raw = [];
  row=[];
  while(i<text.length){
    const c = text[i];
    if (c === '"'){
      if (inQuotes && text[i+1]==='"'){ field+='"'; i++; }
      else inQuotes = !inQuotes;
    } else if (c === ',' && !inQuotes){ pushField(); }
    else if ((c === '\n' || c === '\r') && !inQuotes){
      pushField();
      if (row.length>1 || (row.length===1 && row[0]!=='')) raw.push(row);
      row=[];
    } else { field+=c; }
    i++;
  }
  if (field.length>0 || row.length){ pushField(); if (row.length) raw.push(row); }
  if (!raw.length) return [];
  const headers = raw[0].map(h=>String(h||'').trim() || 'col_'+Math.random().toString(36).slice(2,7));
  for (let r=1; r<raw.length; r++){
    const obj = {};
    for (let c=0; c<headers.length; c++){ obj[headers[c]] = raw[r][c] ?? ''; }
    rows.push(obj);
  }
  return rows;
}

/* =========================
   MOUNT
   ========================= */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<AppWrapper/>);
</script>
</body>
</html>
