<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LeadFlow Pro — Multi-Tenant</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .fade-in { animation: fadeIn .35s ease-in; }
    @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform: translateY(0);} }
    .toggle-switch { position: relative; width: 48px; height: 24px; background: #ccc; border-radius: 12px; cursor: pointer; transition: background .2s; }
    .toggle-switch.active { background: #667eea; }
    .toggle-slider { position:absolute; top:2px; left:2px; width:20px; height:20px; background:#fff; border-radius:50%; transition: transform .2s; }
    .toggle-switch.active .toggle-slider { transform: translateX(24px); }
    .badge { padding: 2px 8px; border-radius: 999px; font-size: 12px; }
    .card { background: white; border-radius: 16px; box-shadow: 0 10px 20px rgba(0,0,0,.06); }
    code.inline { background:#f9fafb; padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; }
  </style>
</head>
<body>
<div id="root"></div>

<!-- IMPORTANT: add Babel presets so the browser compiles JSX reliably -->
<script type="text/babel" data-presets="env,react">
/* =========================
   SMALL ERROR BOUNDARY (so blank pages become readable errors)
   ========================= */
class ErrorBoundary extends React.Component {
  constructor(props){ super(props); this.state = { error: null, info: null }; }
  componentDidCatch(error, info){ this.setState({ error, info }); }
  render(){
    if (this.state.error){
      return (
        <div className="min-h-screen p-6 bg-red-50 text-red-900">
          <div className="max-w-3xl mx-auto">
            <h1 className="text-2xl font-bold mb-2">Something broke in the UI</h1>
            <pre className="p-3 bg-white rounded border overflow-auto">{String(this.state.error)}</pre>
            {this.state.info && <pre className="mt-3 p-3 bg-white rounded border overflow-auto">{this.state.info.componentStack}</pre>}
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

const { useState, useEffect, useMemo } = React;

/* =========================
   PERSISTENCE / AUTH
   ========================= */
const STORAGE_USERS = 'lfp:users';
const STORAGE_SESSION = 'lfp:session';
const WORKSPACE_PREFIX = 'lfp:workspace:'; // + email

const ADMIN_EMAIL = 'Joshua.kollar@me.com';
const ADMIN_PLAIN = 'Allglorytogod12!';

async function sha256(text){
  try{
    const enc = new TextEncoder();
    const buf = await crypto.subtle.digest('SHA-256', enc.encode(text));
    return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
  } catch { return btoa(unescape(encodeURIComponent(text))); }
}
function emailEq(a,b){ return (a||'').trim().toLowerCase() === (b||'').trim().toLowerCase(); }
function loadUsers(){ try { return JSON.parse(localStorage.getItem(STORAGE_USERS)) || []; } catch { return []; } }
function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
function loadSession(){ try { return JSON.parse(localStorage.getItem(STORAGE_SESSION)); } catch { return null; } }
function saveSession(sess){ localStorage.setItem(STORAGE_SESSION, JSON.stringify(sess)); }
function clearSession(){ localStorage.removeItem(STORAGE_SESSION); }
function wsKey(email){ return WORKSPACE_PREFIX + (email||'').trim().toLowerCase(); }
function loadWorkspace(email){ try{ return JSON.parse(localStorage.getItem(wsKey(email))) || null; } catch { return null; } }
function saveWorkspace(email, data){ localStorage.setItem(wsKey(email), JSON.stringify(data)); }
async function ensureAdmin(){
  let users = loadUsers();
  const hasAdmin = users.some(u => emailEq(u.email, ADMIN_EMAIL));
  if (!hasAdmin){
    const hash = await sha256(ADMIN_PLAIN);
    users.push({ email: ADMIN_EMAIL, passHash: hash, isAdmin: true, locked: false, createdAt: new Date().toISOString(), lastLogin: null });
    saveUsers(users);
    if (!loadWorkspace(ADMIN_EMAIL)){ saveWorkspace(ADMIN_EMAIL, seedWorkspace()); }
  }
}

/* =========================
   CATALOGS / CONSTANTS
   ========================= */
const VOICE_CATALOG = {
  elevenlabs: ['Alloy','Callum','Rachel','Adam','Domi'],
  openai:     ['Alloy','Verse','Sol','Breeze'],
  azure:      ['en-US-GuyNeural','en-US-JennyNeural','en-US-ChristopherNeural'],
  google:     ['en-US-Neural2-J','en-US-Standard-B','en-US-Wavenet-D']
};

const US_TZ = [
  { id: 'America/New_York', label: 'US/Eastern' },
  { id: 'America/Chicago', label: 'US/Central' },
  { id: 'America/Denver', label: 'US/Mountain' },
  { id: 'America/Los_Angeles', label: 'US/Pacific' },
  { id: 'America/Anchorage', label: 'US/Alaska' },
  { id: 'Pacific/Honolulu', label: 'US/Hawaii' }
];

// Markets with subs (includes Debt Free; Real Estate added; names capped)
const MARKET_OPTIONS = {
  "Insurance":    ['Life','Term','Final Expense','Medicare','Business Liability','Health','Debt Free'],
  "Real Estate":  ['Buyer Leads','Seller Leads','Open House','Investors','Rentals'],
  "Solar":        ['Residential','Commercial'],
  "Home Services":['Roofing','HVAC','Plumbing','Landscaping','Windows'],
  "Legal":        ['Injury','Disability','Estate','Criminal Defense'],
  "Other":        ['Generic','Event','SaaS']
};

const STATUS_LABELS = [
  'New','Contacted','Qualified','Scheduled',
  'App Submitted','Pending','Approved','Paid','Declined'
];
const STATUS_ADVANCED = new Set(['App Submitted','Pending','Approved','Paid','Declined']);

/* =========================
   PROMPT EXAMPLES (short)
   ========================= */
const PROMPT_TEMPLATES = {
  "Insurance": { "Life": [{ h:"Protect Your Family—Rates Most People Miss", c:"Quick 60-sec quote for {{CITY}} families. Lock in coverage before rates move again.", cta:"get-quote" }] },
  "Real Estate": { "Buyer Leads": [{ h:"New Listings in {{CITY}}—Before They Hit Zillow", c:"Free daily list under {{PRICE}}. Tap for alerts.", cta:"learn-more" }] }
};

/* =========================
   DEFAULT WORKSPACE
   ========================= */
function seedWorkspace(){
  return {
    apiSelection: { // centralized provider selection (no text boxes here)
      voiceProvider: 'elevenlabs',
      smsProvider: 'twilio'
    },
    routing: {
      callsModel: 'gpt-5-mini',
      callsEscalationModel: 'gpt-5',
      smsModel: 'gpt-5-mini',
      adsDraftModel: 'gpt-5-mini',
      adsPolishModel: 'gpt-5',
      adsImageModel: 'gpt-image-3.5',
      realtimeWorker: { maxTokens: 2000, timeoutMs: 8000, rpm: 120, tpm: 120000 },
      batchWorker:    { maxTokens: 6000, timeoutMs: 30000, rpm: 60,  tpm: 300000 },
      metadata: {
        call:     { channel: 'call' },
        sms:      { channel: 'sms' },
        adsCopy:  { channel: 'ads-copy' },
        adsImage: { channel: 'ads-image' },
      }
    },
    automation: {
      autoStartOnMeta: true,
      immediateRetryOnNoAnswer: true,
      immediateRetryOnVoicemail: false
    },
    voiceSettings: {
      provider: 'elevenlabs', // mirrored from apiSelection
      voice: 'Alloy',
      style: 'professional',
      speed: 'normal',
      callAttempts: 2,
      immediateAttempts: 1,
      callInterval: 30, // minutes; 1440=1 day
      immediateCallbackOnNoAnswer: false,
      immediateCallbackOnVoicemail: false,
      voicemailBehavior: 'leave_message',
      voicemailScript: 'Sorry I missed you—this is LeadFlow Pro. I’ll text details as well.',
      scripts: { generic: 'Hi, this is LeadFlow Pro about your request. Do you have a minute?' },
      businessHours: { start:'09:00', end:'17:00' },
      workingDays: ['monday','tuesday','wednesday','thursday','friday'],
      timezone: 'America/Denver'
    },
    smsSettings: {
      provider: 'twilio', // mirrored from apiSelection
      autoRespond: true,
      followUpDelay: 15,
      scripts: { day0:'Hey {{name}}, it’s Josh — got your request. 2 quick questions?', day1:'Been trying to reach you — want a ballpark quote?', day3:'Still here when you are.', day5:'Final ping for now — want a 60-sec summary?' },
      scriptVariants: { noAnswer:'Missed you, {{name}}.', voicemailDrop:'Left a voicemail — text works great if easier.' },
      businessHours: { start:'09:00', end:'17:00' }
    },
    data: {
      leads: [],
      campaigns: [],
      objections: [],
      analytics: {
        overview: { totalLeads: 0, totalCampaigns: 0, conversionRate: 0, avgCostPerLead: 0 },
        performance: { callAnswerRate: 0, smsResponseRate: 0, schedulingRate: 0, revenuePerLead: 0 }
      },
      inbound: [],
      imports: [],
      adLab: { variants: [], images: [], rotate: false }
    }
  };
}

/* =========================
   HELPERS
   ========================= */
function startOfWeek(d){ const x = new Date(d); const day = (x.getDay()+6)%7; x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x; }
function startOfMonth(d){ const x = new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x; }
function startOfYear(d){ const x = new Date(d); x.setMonth(0,1); x.setHours(0,0,0,0); return x; }

/* =========================
   LOGIN
   ========================= */
function LoginView({onLoggedIn}){
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [busy, setBusy] = useState(false);
  const [err, setErr] = useState('');

  const login = async (e) => {
    e?.preventDefault();
    setErr(''); setBusy(true);
    try{
      const users = loadUsers();
      const idx = users.findIndex(x=>emailEq(x.email, email));
      if (idx === -1) throw new Error('Invalid email or password');
      const u = users[idx];
      if (u.locked) throw new Error('Account locked');
      const hash = await sha256(password);
      if (hash !== u.passHash) throw new Error('Invalid email or password');
      const copy = [...users];
      copy[idx] = { ...u, lastLogin: new Date().toISOString() };
      saveUsers(copy);
      saveSession({ email: u.email, isAdmin: !!u.isAdmin });
      if (!loadWorkspace(u.email)) saveWorkspace(u.email, seedWorkspace());
      onLoggedIn({ email: u.email, isAdmin: !!u.isAdmin });
    } catch(ex){ setErr(ex.message || 'Login failed'); }
    finally { setBusy(false); }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50 p-6">
      <div className="card w-full max-w-md p-8">
        <div className="flex items-center gap-3 mb-6">
          <div className="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-purple-600 text-white font-bold flex items-center justify-center">LF</div>
          <div>
            <div className="text-xl font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-500">Secure login</div>
          </div>
        </div>
        <form onSubmit={login} className="space-y-4">
          <div>
            <label className="block text-sm font-medium mb-1">Email</label>
            <input type="email" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={email} onChange={e=>setEmail(e.target.value)} placeholder="you@domain.com" required/>
          </div>
          <div>
            <label className="block text-sm font-medium mb-1">Password</label>
            <input type="password" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={password} onChange={e=>setPassword(e.target.value)} placeholder="••••••••" required/>
          </div>
          {err && <div className="text-sm text-red-600">{err}</div>}
          <button disabled={busy} className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">{busy ? 'Signing in…' : 'Sign In'}</button>
        </form>
      </div>
    </div>
  );
}

/* =========================
   USERS ADMIN (unchanged)
   ========================= */
function UsersAdmin({ me, onImpersonate }){
  const [users, setUsers] = useState(loadUsers());
  const [form, setForm] = useState({ email:'', password:'', isAdmin:false });

  const addUser = async ()=>{
    if (!form.email || !form.password) { alert('Email and password required'); return; }
    let list = loadUsers();
    if (list.some(u=>emailEq(u.email, form.email))) { alert('User already exists'); return; }
    const hash = await sha256(form.password);
    const u = { email: form.email.trim(), passHash: hash, isAdmin: !!form.isAdmin, locked:false, createdAt: new Date().toISOString(), lastLogin:null };
    list.push(u); saveUsers(list); setUsers(list);
    if (!loadWorkspace(u.email)) saveWorkspace(u.email, seedWorkspace());
    setForm({ email:'', password:'', isAdmin:false });
    alert('✅ User added');
  };
  const toggleLock = (email)=>{
    let list = loadUsers().map(u=> emailEq(u.email, email) ? { ...u, locked: !u.locked } : u);
    saveUsers(list); setUsers(list);
  };
  const resetPassword = async (email)=>{
    const np = prompt('New password for '+email+':'); if (!np) return;
    const hash = await sha256(np);
    let list = loadUsers().map(u=> emailEq(u.email, email)? { ...u, passHash: hash } : u);
    saveUsers(list); setUsers(list);
    alert('✅ Password reset');
  };
  const toggleAdmin = (email)=>{
    if (emailEq(email, me.email)) { alert('You cannot change your own admin flag here.'); return; }
    let list = loadUsers().map(u=> emailEq(u.email, email)? { ...u, isAdmin: !u.isAdmin } : u);
    saveUsers(list); setUsers(list);
  };

  return (
    <div className="bg-white rounded-2xl p-6 shadow-lg">
      <h3 className="text-xl font-bold mb-4">👥 Users (Admin)</h3>
      <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
        <input type="email" placeholder="user@email.com" className="p-3 border rounded-xl" value={form.email} onChange={e=>setForm(prev=>({...prev,email:e.target.value}))}/>
        <input type="text" placeholder="Temp password" className="p-3 border rounded-xl" value={form.password} onChange={e=>setForm(prev=>({...prev,password:e.target.value}))}/>
        <div className="flex items-center gap-2">
          <label className="text-sm">Admin?</label>
          <input type="checkbox" checked={form.isAdmin} onChange={e=>setForm(prev=>({...prev,isAdmin:e.target.checked}))}/>
          <button onClick={addUser} className="ml-auto px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">Add</button>
        </div>
      </div>
      <div className="overflow-auto border rounded-xl">
        <table className="min-w-full text-sm">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-3 py-2 text-left">Email</th>
              <th className="px-3 py-2 text-left">Admin</th>
              <th className="px-3 py-2 text-left">Locked</th>
              <th className="px-3 py-2 text-left">Created</th>
              <th className="px-3 py-2 text-left">Last login</th>
              <th className="px-3 py-2 text-left">Actions</th>
            </tr>
          </thead>
          <tbody>
            {users.map(u=>(
              <tr key={u.email} className="border-t">
                <td className="px-3 py-2">{u.email}</td>
                <td className="px-3 py-2">{u.isAdmin ? 'Yes' : 'No'} {!emailEq(u.email, me.email) && <button onClick={()=>toggleAdmin(u.email)} className="ml-2 text-blue-600">toggle</button>}</td>
                <td className="px-3 py-2">{u.locked ? 'Locked' : 'Active'} <button onClick={()=>toggleLock(u.email)} className="ml-2 text-blue-600">{u.locked?'unlock':'lock'}</button></td>
                <td className="px-3 py-2">{new Date(u.createdAt).toLocaleString()}</td>
                <td className="px-3 py-2">{u.lastLogin ? new Date(u.lastLogin).toLocaleString() : '—'}</td>
                <td className="px-3 py-2">
                  <button onClick={()=>resetPassword(u.email)} className="text-blue-600 mr-3">reset pwd</button>
                  {me.isAdmin && !emailEq(u.email, me.email) && <button onClick={()=>onImpersonate(u.email)} className="text-purple-600">impersonate</button>}
                </td>
              </tr>
            ))}
            {users.length===0 && <tr><td colSpan="6" className="px-3 py-3 text-center text-gray-500">No users</td></tr>}
          </tbody>
        </table>
      </div>
    </div>
  );
}

/* =========================
   APP
   ========================= */
function LeadFlowApp({ me, onLogout, onImpersonate }){
  const ws0 = loadWorkspace(me.email) || seedWorkspace();

  const [activeTab, setActiveTab] = useState('dashboard');
  const [showMobileMenu, setShowMobileMenu] = useState(false);

  // CENTRAL selections
  const [apiSelection, setApiSelection] = useState(ws0.apiSelection);
  const [routing, setRouting] = useState(ws0.routing);
  const [automation, setAutomation] = useState(ws0.automation || { autoStartOnMeta:true, immediateRetryOnNoAnswer:true, immediateRetryOnVoicemail:false });

  // these mirror apiSelection provider
  const [voiceSettings, setVoiceSettings] = useState({ ...ws0.voiceSettings, provider: ws0.apiSelection.voiceProvider });
  const [smsSettings, setSmsSettings] = useState({ ...ws0.smsSettings, provider: ws0.apiSelection.smsProvider });

  // data
  const [leads, _setLeads] = useState(ws0.data.leads || []);
  const [campaigns, setCampaigns] = useState(ws0.data.campaigns || []);
  const [objections, setObjections] = useState(ws0.data.objections || []);
  const [analyticsData, setAnalyticsData] = useState(ws0.data.analytics || null);
  const [inboundEvents, setInboundEvents] = useState(ws0.data.inbound || []);
  const [imports, setImports] = useState(ws0.data.imports || []);
  const [adLab, setAdLab] = useState(ws0.data.adLab || { variants:[], images:[], rotate:false });

  const saveNow = (next) => {
    // always mirror providers to voice/sms settings
    const mirroredVoice = { ...voiceSettings, provider: apiSelection.voiceProvider };
    const mirroredSms   = { ...smsSettings, provider: apiSelection.smsProvider };
    saveWorkspace(me.email, {
      apiSelection,
      routing,
      automation,
      voiceSettings: mirroredVoice,
      smsSettings: mirroredSms,
      data: {
        leads: next?.leads ?? leads,
        campaigns: next?.campaigns ?? campaigns,
        objections: next?.objections ?? objections,
        analytics: next?.analytics ?? analyticsData,
        inbound: next?.inbound ?? inboundEvents,
        imports: next?.imports ?? imports,
        adLab: next?.adLab ?? adLab
      }
    });
  };
  const setLeads = (fnOrArr) => { const v = typeof fnOrArr==='function'? fnOrArr(leads):fnOrArr; _setLeads(v); saveNow({leads:v}); };
  const setAdLabPersist = (updater) => { const v = typeof updater==='function' ? updater(adLab) : updater; setAdLab(v); saveNow({ adLab: v }); };

  /* ---------- Stats & APV ---------- */
  const computeAPVStats = (list)=>{
    const now = new Date();
    const w0 = startOfWeek(now), m0 = startOfMonth(now), y0 = startOfYear(now);
    let week=0, month=0, year=0;
    list.forEach(l=>{
      const apv = Number(l.apv||0);
      if (!apv) return;
      const dt = l.apvDate ? new Date(l.apvDate) : new Date();
      if (dt >= w0) week += apv;
      if (dt >= m0) month += apv;
      if (dt >= y0) year += apv;
    });
    return { week: Math.round(week*100)/100, month: Math.round(month*100)/100, year: Math.round(year*100)/100 };
  };
  const apvStats = computeAPVStats(leads);

  const [stats, setStats] = useState({
    totalLeads: analyticsData?.overview?.totalLeads ?? (leads?.length || 0),
    scheduledToday: (leads||[]).filter(l=>l.status==='Scheduled').length,
    adSpend: 2450,
    conversionRate: Math.round(analyticsData?.overview?.conversionRate ?? 34)
  });
  useEffect(()=>{
    setStats({
      totalLeads: leads.length,
      scheduledToday: leads.filter(l=>l.status==='Scheduled').length,
      adSpend: 2450,
      conversionRate: Math.round(analyticsData?.overview?.conversionRate ?? 34)
    });
  }, [leads, analyticsData]);

  /* ---------- Optional backend fetch (safe no-throw) ---------- */
  useEffect(()=>{
    Promise.allSettled([
      fetch('/api/leads').then(r=>r.json()),
      fetch('/api/campaigns').then(r=>r.json()),
      fetch('/api/objections').then(r=>r.json()),
      fetch('/api/analytics').then(r=>r.json())
    ]).then(([leadsRes, campRes, objRes, anaRes])=>{
      if (leadsRes.status==='fulfilled' && Array.isArray(leadsRes.value)) setLeads(leadsRes.value);
      if (campRes.status==='fulfilled' && Array.isArray(campRes.value)) { setCampaigns(campRes.value); saveNow({campaigns: campRes.value}); }
      if (objRes.status==='fulfilled' && Array.isArray(objRes.value)) { setObjections(objRes.value); saveNow({objections: objRes.value}); }
      if (anaRes.status==='fulfilled' && anaRes.value) { setAnalyticsData(anaRes.value); saveNow({analytics: anaRes.value}); }
    }).catch(()=>{});
    // eslint-disable-next-line
  },[]);

  /* ---------- Nav ---------- */
  const MobileNav = () => (
    <div className="lg:hidden bg-white shadow-lg p-4">
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-3">
          <div className="w-10 h-10 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold">LF</div>
          <div>
            <div className="font-bold">LeadFlow Pro</div>
            <div className="text-xs text-gray-600">{me.email}</div>
          </div>
        </div>
        <button onClick={()=>setShowMobileMenu(!showMobileMenu)} className="p-2 rounded-lg bg-gray-100">☰</button>
      </div>
      {showMobileMenu && (
        <div className="mt-4 space-y-2">
          {[
            { id:'dashboard', icon:'📊', label:'Dashboard' },
            { id:'ad-creator', icon:'🎯', label:'Ad Creator' },
            { id:'leads', icon:'👥', label:'Leads' },
            { id:'voice-ai', icon:'🎙️', label:'Voice AI' },
            { id:'objections', icon:'💬', label:'Objections' },
            { id:'campaigns', icon:'📈', label:'Campaigns' },
            { id:'analytics', icon:'📊', label:'Analytics' },
            { id:'inbound', icon:'📞', label:'Inbound Center' },
            { id:'imports', icon:'📂', label:'Imports' },
            { id:'settings', icon:'⚙️', label:'Settings' },
            ...(me.isAdmin ? [{ id:'admin-users', icon:'🛡️', label:'Users (Admin)' }] : []),
          ].map(({id,icon,label})=>(
            <button key={id} onClick={()=>{ setActiveTab(id); setShowMobileMenu(false); }}
              className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${activeTab===id ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white' : 'hover:bg-blue-50 text-gray-700'}`}>
              <span className="text-xl">{icon}</span>{label}
            </button>
          ))}
          <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl hover:bg-red-50 text-red-600">🚪 Logout</button>
        </div>
      )}
    </div>
  );
  const Sidebar = () => (
    <div className="hidden lg:block w-80 bg-white bg-opacity-95 backdrop-blur-lg p-6 shadow-xl">
      <div className="flex items-center gap-3 mb-8 pb-4 border-b-2 border-gray-200">
        <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-purple-600 rounded-xl flex items-center justify-center text-white font-bold text-xl">LF</div>
        <div>
          <div className="font-bold text-lg">LeadFlow Pro</div>
          <div className="text-xs text-gray-600">{me.email}</div>
        </div>
      </div>
      <nav className="space-y-2">
        {[
          { id:'dashboard', icon:'📊', label:'Dashboard' },
          { id:'ad-creator', icon:'🎯', label:'Ad Creator' },
          { id:'leads', icon:'👥', label:'Lead Management' },
          { id:'voice-ai', icon:'🎙️', label:'Voice AI System' },
          { id:'objections', icon:'💬', label:'Objection Handling' },
          { id:'campaigns', icon:'📈', label:'Campaign Manager' },
          { id:'analytics', icon:'📊', label:'Analytics' },
          { id:'inbound', icon:'📞', label:'Inbound Center' },
          { id:'imports', icon:'📂', label:'Imports & Mapping' },
          { id:'settings', icon:'⚙️', label:'Settings & Configuration' },
          ...(me.isAdmin ? [{ id:'admin-users', icon:'🛡️', label:'Users (Admin)' }] : []),
        ].map(({id,icon,label})=>(
          <button key={id} onClick={()=>setActiveTab(id)}
            className={`w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 ${activeTab===id ? 'bg-gradient-to-r from-blue-500 to-purple-600 text-white shadow-lg' : 'hover:bg-blue-50 text-gray-700 hover:translate-x-1'}`}>
            <span className="text-xl">{icon}</span>{label}
          </button>
        ))}
        <button onClick={onLogout} className="w-full flex items-center gap-3 px-4 py-3 rounded-xl transition-all duration-300 hover:bg-red-50 text-red-600">
          <span className="text-xl">🚪</span>Logout
        </button>
      </nav>
    </div>
  );

  /* ---------- Dashboard (no Recent Leads) ---------- */
  const Dashboard = () => (
    <div className="space-y-6 fade-in">
      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
        {[
          { label:'Total Leads', value:stats.totalLeads, icon:'👥', color:'from-blue-500 to-blue-600' },
          { label:'Scheduled Today', value:stats.scheduledToday, icon:'📅', color:'from-green-500 to-green-600' },
          { label:'Ad Spend', value:`$${new Intl.NumberFormat().format(stats.adSpend)}`, icon:'💰', color:'from-purple-500 to-purple-600' },
          { label:'Conversion Rate', value:`${stats.conversionRate}%`, icon:'📈', color:'from-orange-500 to-orange-600' }
        ].map(({label,value,icon,color})=>(
          <div key={label} className={`bg-gradient-to-br ${color} text-white p-4 lg:p-6 rounded-2xl shadow-lg text-center`}>
            <div className="text-2xl mb-2">{icon}</div>
            <div className="text-2xl lg:text-3xl font-bold mb-1">{value}</div>
            <div className="text-xs lg:text-sm opacity-90">{label}</div>
          </div>
        ))}
      </div>

      {/* APV Totals */}
      <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Week</div>
          <div className="text-2xl font-bold">${apvStats.week.toLocaleString()}</div>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Month</div>
          <div className="text-2xl font-bold">${apvStats.month.toLocaleString()}</div>
        </div>
        <div className="bg-white rounded-2xl p-4 shadow-lg text-center">
          <div className="text-xs text-gray-500">APV This Year</div>
          <div className="text-2xl font-bold">${apvStats.year.toLocaleString()}</div>
        </div>
      </div>

      {/* Quick Actions */}
      <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
        <h3 className="text-lg lg:text-xl font-bold mb-4">Quick Actions</h3>
        <div className="grid grid-cols-1 sm:grid-cols-3 gap-3">
          <button onClick={()=>setActiveTab('ad-creator')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">🎯 Create New Ad</button>
          <button onClick={()=>setActiveTab('leads')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">👥 Manage Leads</button>
          <button onClick={()=>setActiveTab('voice-ai')} className="w-full p-3 lg:p-4 bg-gradient-to-r from-orange-500 to-red-600 text-white rounded-xl font-semibold hover:shadow-lg transition-all">🎙️ Test Voice AI</button>
        </div>
      </div>
    </div>
  );

  /* ---------- Ad Creator (with Creative Preview) ---------- */
  const AdCreator = () => {
    const [adForm, setAdForm] = useState({
      market: 'Insurance',
      subType: '',
      targetLocations: '',
      minAge: '',
      maxAge: '',
      dailyBudget: '',
      headline: '',
      copy: '',
      cta: 'learn-more'
    });

    const [localVariants, setLocalVariants] = useState(adLab.variants || []);
    const [rotate, setRotate] = useState(adLab.rotate || false);
    const [images, setImages] = useState(adLab.images || []); // {id,url}

    useEffect(()=>{ setAdForm(prev=>({...prev, subType:''})); }, [adForm.market]);

    const currentTemplates = (PROMPT_TEMPLATES[adForm.market] || {})[adForm.subType] || [];
    const applyTemplate = (tpl)=>{
      setAdForm(prev=>({
        ...prev,
        headline: tpl.h.replace('{{CITY}}','your area').replace('{{PRICE}}','500k'),
        copy: tpl.c.replace('{{CITY}}','your area'),
        cta: tpl.cta || prev.cta
      }));
    };

    const addVariantFromCurrent = ()=>{
      if (!adForm.headline || !adForm.copy) { alert('Set headline and copy first'); return; }
      const v = { id: Date.now(), headline: adForm.headline, copy: adForm.copy, cta: adForm.cta, impressions: 0, clicks: 0, imageId: images[0]?.id || null };
      const next = [v, ...localVariants];
      setLocalVariants(next);
      setAdLabPersist({ ...adLab, variants: next, rotate, images });
    };

    const uploadImage = (file)=>{
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = { id: Date.now(), url };
      const next = [img, ...images];
      setImages(next);
      setAdLabPersist({ ...adLab, images: next, variants: localVariants, rotate });
    };

    const generatePlaceholder = ()=>{
      // front-end only placeholder
      const canv = document.createElement('canvas'); canv.width=800; canv.height=450;
      const ctx = canv.getContext('2d'); ctx.fillStyle='#e5e7eb'; ctx.fillRect(0,0,800,450);
      ctx.fillStyle='#111827'; ctx.font='28px Inter'; ctx.fillText(adForm.subType || 'Ad Creative', 30, 60);
      ctx.font='20px Inter'; ctx.fillText(adForm.headline || 'Headline goes here', 30, 110);
      const url = canv.toDataURL('image/png');
      const img = { id: Date.now(), url };
      const next = [img, ...images];
      setImages(next);
      setAdLabPersist({ ...adLab, images: next, variants: localVariants, rotate });
    };

    const linkImageToVariant = (variantId, imageId)=>{
      const next = localVariants.map(v=> v.id===variantId ? { ...v, imageId } : v);
      setLocalVariants(next);
      setAdLabPersist({ ...adLab, variants: next, images, rotate });
    };

    const launchCampaign = async () => {
      if (!adForm.headline || !adForm.copy || !adForm.targetLocations || !adForm.subType) { alert('Fill headline, copy, locations, and sub-type'); return; }
      try{
        const body = {
          name: `${adForm.market}/${adForm.subType} - ${adForm.targetLocations}`,
          market: adForm.market, type: adForm.subType,
          budget: parseInt(adForm.dailyBudget) || 100,
          adContent: { headline: adForm.headline, copy: adForm.copy, cta: adForm.cta },
          targeting: { locations: adForm.targetLocations.split(',').map(s=>s.trim()).filter(Boolean), ageMin: parseInt(adForm.minAge)||25, ageMax: parseInt(adForm.maxAge)||65 },
          variants: localVariants,
          images
        };
        await fetch('/api/launch-campaign', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) }).catch(()=>{});
        const newCamp = { id:'c'+Date.now(), name: body.name, market: body.market, type: body.type, budget: body.budget, status:'active', leads:0, costPerLead:0, variants: localVariants, images };
        setCampaigns(prev => [newCamp, ...prev]); saveNow({ campaigns: [newCamp, ...campaigns], adLab: { ...adLab, variants: localVariants, images } });
        alert('🚀 Campaign launched (simulated).');
      } catch { alert('❌ Launch failed.'); }
    };

    const bestVariant = localVariants.reduce((b,v)=> ((v.clicks/(v.impressions||1)) > (b?.clicks/(b?.impressions||1) || 0) ? v : b), null);

    return (
      <div className="space-y-6 fade-in">
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-4 lg:gap-6">
          <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
            <h3 className="text-lg lg:text-xl font-bold mb-4">Category</h3>
            <div className="space-y-4">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
                <div>
                  <label className="block font-medium mb-2 text-sm lg:text-base">Market</label>
                  <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={adForm.market} onChange={(e)=>setAdForm(prev=>({...prev, market:e.target.value, subType:''}))}>
                    {Object.keys(MARKET_OPTIONS).map(m=><option key={m} value={m}>{m}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block font-medium mb-2 text-sm lg:text-base">Sub-Type</label>
                  <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={adForm.subType} onChange={(e)=>setAdForm(prev=>({...prev, subType:e.target.value}))}>
                    <option value="">Choose…</option>
                    {MARKET_OPTIONS[adForm.market].map(s=><option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
              </div>

              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Target Locations</label>
                <input type="text" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="FL, TX, CA" value={adForm.targetLocations} onChange={(e)=>setAdForm(prev=>({...prev, targetLocations:e.target.value}))}/>
              </div>

              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block font-medium mb-2 text-sm lg:text-base">Min Age</label>
                  <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="25" value={adForm.minAge} onChange={(e)=>setAdForm(prev=>({...prev, minAge:e.target.value}))}/>
                </div>
                <div>
                  <label className="block font-medium mb-2 text-sm lg:text-base">Max Age</label>
                  <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="65" value={adForm.maxAge} onChange={(e)=>setAdForm(prev=>({...prev, maxAge:e.target.value}))}/>
                </div>
              </div>

              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Daily Budget ($)</label>
                <input type="number" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="150" value={adForm.dailyBudget} onChange={(e)=>setAdForm(prev=>({...prev, dailyBudget:e.target.value}))}/>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
            <h3 className="text-lg lg:text-xl font-bold mb-4">Ad Content</h3>
            <div className="space-y-4">
              <div className="bg-gray-50 p-3 rounded-xl">
                <div className="text-sm font-semibold mb-2">Prompt Examples for {adForm.market}{adForm.subType? ' / '+adForm.subType:''}</div>
                <div className="flex flex-wrap gap-2">
                  {currentTemplates.length===0 && <div className="text-xs text-gray-500">Select Market and Sub-type to see examples.</div>}
                  {currentTemplates.map((tpl, i)=>(
                    <button key={i} onClick={()=>applyTemplate(tpl)} className="px-3 py-2 text-xs bg-white border rounded-lg hover:bg-blue-50">
                      “{tpl.h}”
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Headline</label>
                <input type="text" className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="Your compelling headline..." value={adForm.headline} onChange={(e)=>setAdForm(prev=>({...prev, headline:e.target.value}))}/>
              </div>
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Ad Copy</label>
                <textarea className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500 h-28 resize-none" placeholder="Write your ad copy here..." value={adForm.copy} onChange={(e)=>setAdForm(prev=>({...prev, copy:e.target.value}))}/>
              </div>
              <div>
                <label className="block font-medium mb-2 text-sm lg:text-base">Call-to-Action</label>
                <select className="w-full p-3 border rounded-xl focus:ring-2 focus:ring-blue-500" value={adForm.cta} onChange={(e)=>setAdForm(prev=>({...prev, cta:e.target.value}))}>
                  <option value="learn-more">Learn More</option>
                  <option value="get-quote">Get Free Quote</option>
                  <option value="call-now">Call Now</option>
                  <option value="apply-now">Apply Now</option>
                </select>
              </div>

              <div className="flex gap-2">
                <button onClick={addVariantFromCurrent} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-lg">➕ Add Variant</button>
                <button onClick={launchCampaign} className="px-3 py-2 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg">🚀 Launch Campaign</button>
              </div>
            </div>
          </div>
        </div>

        {/* Creative Preview */}
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-lg lg:text-xl font-bold">Creative Preview</h3>
            <div className="flex items-center gap-3">
              <span className="text-sm">Rotate Variants</span>
              <div className={`toggle-switch ${adLab.rotate ? 'active' : ''}`} onClick={()=>{ const nv = !adLab.rotate; setRotate(nv); setAdLabPersist({ ...adLab, rotate: nv }); }}>
                <div className="toggle-slider"></div>
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* image gallery */}
            <div>
              <div className="flex items-center gap-3 mb-2">
                <label className="px-3 py-2 bg-gray-100 rounded cursor-pointer">
                  Upload Image
                  <input type="file" accept="image/*" className="hidden" onChange={(e)=>uploadImage(e.target.files[0])}/>
                </label>
                <button onClick={generatePlaceholder} className="px-3 py-2 bg-gray-100 rounded">Generate Placeholder</button>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                {images.map(img=>(
                  <div key={img.id} className="border rounded-xl overflow-hidden">
                    <img src={img.url} alt="ad" className="w-full h-32 object-cover"/>
                  </div>
                ))}
                {images.length===0 && <div className="text-sm text-gray-500">No images yet.</div>}
              </div>
            </div>

            {/* live ad card */}
            <div className="border rounded-2xl p-4">
              <div className="border rounded-xl overflow-hidden mb-3">
                {images[0] ? <img src={images[0].url} alt="preview" className="w-full h-48 object-cover"/> : <div className="h-48 bg-gray-100 flex items-center justify-center text-gray-500">Add an image</div>}
              </div>
              <div className="text-lg font-semibold mb-1">{adForm.headline || 'Headline'}</div>
              <div className="text-sm text-gray-700 mb-2">{adForm.copy || 'Copy appears here'}</div>
              <button className="px-3 py-2 bg-blue-600 text-white rounded-lg text-sm">{(adForm.cta||'learn-more').replace('-',' ').toUpperCase()}</button>
            </div>
          </div>

          {/* variants table */}
          <div className="mt-6 overflow-auto border rounded-xl">
            <table className="min-w-full text-sm">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-3 py-2 text-left">Image</th>
                  <th className="px-3 py-2 text-left">Headline</th>
                  <th className="px-3 py-2 text-left">Copy</th>
                  <th className="px-3 py-2 text-left">CTA</th>
                  <th className="px-3 py-2 text-left">Stats</th>
                  <th className="px-3 py-2 text-left">Actions</th>
                </tr>
              </thead>
              <tbody>
                {localVariants.map(v=>{
                  const linked = images.find(i=>i.id===v.imageId);
                  return (
                    <tr key={v.id} className="border-t">
                      <td className="px-3 py-2">
                        <select className="p-2 border rounded" value={v.imageId || ''} onChange={(e)=>linkImageToVariant(v.id, e.target.value ? Number(e.target.value): null)}>
                          <option value="">None</option>
                          {images.map(i=> <option key={i.id} value={i.id}>{i.id}</option>)}
                        </select>
                      </td>
                      <td className="px-3 py-2 max-w-xs">
                        <input className="w-full p-2 border rounded" value={v.headline} onChange={(e)=>{ const nv = localVariants.map(x=>x.id===v.id? {...x, headline:e.target.value}:x); setLocalVariants(nv); setAdLabPersist({ ...adLab, variants:nv, images }); }}/>
                      </td>
                      <td className="px-3 py-2">
                        <textarea className="w-full p-2 border rounded h-16" value={v.copy} onChange={(e)=>{ const nv = localVariants.map(x=>x.id===v.id? {...x, copy:e.target.value}:x); setLocalVariants(nv); setAdLabPersist({ ...adLab, variants:nv, images }); }}/>
                      </td>
                      <td className="px-3 py-2">
                        <select className="p-2 border rounded" value={v.cta} onChange={(e)=>{ const nv = localVariants.map(x=>x.id===v.id? {...x, cta:e.target.value}:x); setLocalVariants(nv); setAdLabPersist({ ...adLab, variants:nv, images }); }}>
                          <option value="learn-more">Learn More</option>
                          <option value="get-quote">Get Free Quote</option>
                          <option value="call-now">Call Now</option>
                          <option value="apply-now">Apply Now</option>
                        </select>
                      </td>
                      <td className="px-3 py-2">Impr {v.impressions} • Clicks {v.clicks}</td>
                      <td className="px-3 py-2">
                        <button onClick={()=>{ const nv=localVariants.filter(x=>x.id!==v.id); setLocalVariants(nv); setAdLabPersist({ ...adLab, variants:nv, images }); }} className="px-2 py-1 bg-gray-100 rounded">Delete</button>
                      </td>
                    </tr>
                  );
                })}
                {localVariants.length===0 && <tr><td className="px-3 py-4 text-center text-gray-500" colSpan="6">No variants yet. Add one above.</td></tr>}
              </tbody>
            </table>
          </div>

          {bestVariant && <div className="mt-3 text-sm text-gray-700">Current best CTR: <strong>{((bestVariant.clicks/(bestVariant.impressions||1))*100).toFixed(1)}%</strong></div>}
        </div>
      </div>
    );
  };

  /* ---------- Leads (unchanged from last except no dashboard recent) ---------- */
  // ... (same as previous answer—you still have full CRUD, editor modal, imports, etc.)
  // For brevity in this message, I’m keeping the Leads/Editor/Imports code identical to the prior working version.
  // ↓↓↓ I am including them so your file is complete.

  const LeadManagement = () => {
    const [searchTerm, setSearchTerm] = useState('');
    const [filterMarket, setFilterMarket] = useState('');
    const [filterType, setFilterType] = useState('');
    const [filterStatus, setFilterStatus] = useState('');
    const [showImportModal, setShowImportModal] = useState(false);
    const [showTestModal, setShowTestModal] = useState(false);
    const [showAddLead, setShowAddLead] = useState(false);

    const filteredLeads = leads.filter(lead => {
      const term = searchTerm.toLowerCase();
      const matchesSearch = (lead.name||'').toLowerCase().includes(term) || (lead.phone||'').includes(searchTerm) || (lead.email||'').toLowerCase().includes(term);
      const matchesMarket = !filterMarket || lead.market===filterMarket;
      const matchesType = !filterType || (lead.type||'').toLowerCase() === filterType.toLowerCase();
      const matchesStatus = !filterStatus || lead.status===filterStatus;
      return matchesSearch && matchesMarket && matchesType && matchesStatus;
    });

    const parseCSV = (text)=>{
      const rows = []; let i=0, field='', row=[], inQuotes=false; const raw=[];
      const pushField=()=>{ row.push(field); field=''; };
      while(i<text.length){
        const c = text[i];
        if (c === '"'){ if (inQuotes && text[i+1]==='"'){ field+='"'; i++; } else inQuotes = !inQuotes; }
        else if (c === ',' && !inQuotes){ pushField(); }
        else if ((c === '\n' || c === '\r') && !inQuotes){ pushField(); if (row.length) raw.push(row); row=[]; }
        else { field+=c; }
        i++;
      }
      if (field.length>0 || row.length){ pushField(); if (row.length) raw.push(row); }
      if (!raw.length) return [];
      const headers = raw[0].map(h=>String(h||'').trim() || 'col_'+Math.random().toString(36).slice(2,7));
      for (let r=1; r<raw.length; r++){ const obj = {}; for (let c=0;c<headers.length;c++){ obj[headers[c]] = raw[r][c] ?? ''; } rows.push(obj); }
      return rows;
    };

    const handleFileUpload = async (event, type) => {
      const file = event.target.files[0]; if (!file) return;
      if (type === 'csv') {
        const text = await file.text();
        const rows = parseCSV(text).slice(0, 200);
        const imp = { id: Date.now(), filename: file.name, createdAt: new Date().toISOString(), rows, mapped: {}, dropPlaceholders: true };
        const next = [imp, ...imports];
        setImports(next); saveNow({ imports: next });
        alert(`✅ CSV loaded (${rows.length} preview rows). Go to Imports to map.`);
        setShowImportModal(false); setActiveTab('imports');
      } else {
        alert('🔍 PDF scanning simulated (connect OCR later).');
        const imp = { id: Date.now(), filename: file.name, createdAt: new Date().toISOString(), rows: [], mapped: {}, dropPlaceholders: true };
        const next = [imp, ...imports];
        setImports(next); saveNow({ imports: next });
        setShowImportModal(false); setActiveTab('imports');
      }
    };

    const addLead = (lead)=>{
      const created = { ...lead, id: Date.now(), time: new Date().toLocaleString(), callLogs: [], isClient: lead.status==='Paid' };
      setLeads(prev => [created, ...prev]);
    };
    const updateLead = (lead)=> setLeads(prev => prev.map(l => l.id===lead.id ? lead : l));
    const deleteLead = async (leadId) => { if (!confirm('Delete this lead?')) return; setLeads(prev => prev.filter(l=>l.id!==leadId)); };

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
            <h3 className="text-lg lg:text-xl font-bold">Lead Pipeline</h3>
            <div className="flex flex-wrap gap-2">
              <button onClick={()=>setShowAddLead(true)} className="px-3 py-2 bg-purple-100 text-purple-700 rounded-xl">➕ Add Lead</button>
              <input type="file" accept=".csv" onChange={(e)=>handleFileUpload(e,'csv')} className="hidden" id="csv-upload-direct"/>
              <label htmlFor="csv-upload-direct" className="px-3 py-2 bg-green-100 text-green-700 rounded-xl cursor-pointer">📊 Upload CSV</label>
              <input type="file" accept=".pdf" onChange={(e)=>handleFileUpload(e,'pdf')} className="hidden" id="pdf-upload-direct"/>
              <label htmlFor="pdf-upload-direct" className="px-3 py-2 bg-red-100 text-red-700 rounded-xl cursor-pointer">📄 Scan PDF → CSV</label>
              <button onClick={()=>setShowImportModal(true)} className="px-3 py-2 bg-blue-100 text-blue-700 rounded-xl">📋 Import Options</button>
              <button onClick={()=>setShowTestModal(true)} className="px-3 py-2 bg-amber-100 text-amber-700 rounded-xl">🧪 Test System</button>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <select className="p-3 border rounded-xl" value={filterMarket} onChange={(e)=>setFilterMarket(e.target.value)}>
              <option value="">All Markets</option>
              {Object.keys(MARKET_OPTIONS).map(m=><option key={m} value={m}>{m}</option>)}
            </select>
            <select className="p-3 border rounded-xl" value={filterType} onChange={(e)=>setFilterType(e.target.value)}>
              <option value="">All Sub-Types</option>
              {Object.values(MARKET_OPTIONS).flat().map(t=><option key={t} value={t}>{t}</option>)}
            </select>
            <input type="text" className="p-3 border rounded-xl" placeholder="Search leads…" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)}/>
            <select className="p-3 border rounded-xl" value={filterStatus} onChange={(e)=>setFilterStatus(e.target.value)}>
              <option value="">All Status</option>
              {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
            </select>
          </div>

          <div className="space-y-4">
            {filteredLeads.map(lead=>(
              <div key={lead.id} className="p-4 border border-gray-200 rounded-xl hover:border-blue-300 transition-all">
                <div className="flex flex-col sm:flex-row justify-between items-start gap-3 mb-3">
                  <div>
                    <button onClick={()=>openLeadEditor(lead)} className="font-semibold text-lg text-left hover:underline">{lead.name}</button>
                    <div className="text-sm text-gray-600">{lead.phone || '—'} • {lead.email || '—'}</div>
                  </div>
                  <div className="flex items-center gap-2">
                    <span className={`badge ${lead.status==='Paid'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}`}>{lead.status}</span>
                    {lead.isClient && <span className="badge bg-green-50 text-green-700 border border-green-200">Client</span>}
                    <button onClick={()=>openLeadEditor(lead)} className="px-2 py-1 text-sm bg-blue-100 text-blue-700 rounded">✏️ Edit</button>
                    <button onClick={()=>{ if(confirm('Delete this lead?')) deleteLead(lead.id); }} className="px-2 py-1 text-sm bg-gray-100 rounded">🗑️</button>
                  </div>
                </div>
                <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                  <div className="text-sm text-gray-600">{lead.market}/{lead.type} • {lead.location || '—'} • {lead.time || '—'}</div>
                </div>
                {lead.apv ? <div className="mt-2 text-xs text-gray-700">APV: <strong>${Number(lead.apv).toLocaleString()}</strong> {lead.carrier? `• Carrier: ${lead.carrier}`:''}</div> : null}
              </div>
            ))}
            {filteredLeads.length===0 && <div className="text-center py-8 text-gray-500">No leads found</div>}
          </div>
        </div>

        {/* Import Modal */}
        {showImportModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">Import Leads</h3>
              <div className="space-y-4">
                <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                  <div className="text-2xl mb-2">📄</div>
                  <h4 className="font-semibold mb-2">Upload PDF</h4>
                  <p className="text-sm text-gray-600 mb-3">Front-end sim. Connect OCR later.</p>
                  <input type="file" accept=".pdf" onChange={(e)=>handleFileUpload(e,'pdf')} className="hidden" id="pdf-upload"/>
                  <label htmlFor="pdf-upload" className="px-4 py-2 bg-red-100 text-red-700 rounded-lg cursor-pointer hover:bg-red-200 transition-all">Choose PDF File</label>
                </div>
                <div className="p-4 border-2 border-dashed border-gray-300 rounded-xl text-center">
                  <div className="text-2xl mb-2">📊</div>
                  <h4 className="font-semibold mb-2">Upload CSV</h4>
                  <p className="text-sm text-gray-600 mb-3">Preview first 200 rows.</p>
                  <input type="file" accept=".csv" onChange={(e)=>handleFileUpload(e,'csv')} className="hidden" id="csv-upload"/>
                  <label htmlFor="csv-upload" className="px-4 py-2 bg-green-100 text-green-700 rounded-lg cursor-pointer hover:bg-green-200 transition-all">Choose CSV File</label>
                </div>
              </div>
              <div className="flex gap-3 mt-6">
                <button onClick={()=>setShowImportModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">Close</button>
              </div>
            </div>
          </div>
        )}

        {/* Test Modal (simulated) */}
        {showTestModal && (
          <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
            <div className="bg-white rounded-2xl p-6 max-w-md w-full">
              <h3 className="text-xl font-bold mb-4">🧪 Test Complete System</h3>
              <p className="text-gray-600 mb-4">Simulates voice, SMS, objections, scoring, and calendar.</p>
              <div className="bg-yellow-50 p-4 rounded-xl mb-4">
                <ul className="text-sm text-yellow-700 space-y-1">
                  <li>• AI voice call simulation</li>
                  <li>• SMS backup message</li>
                  <li>• Objection handling test</li>
                  <li>• Lead scoring verification</li>
                  <li>• Calendar integration check</li>
                </ul>
              </div>
              <div className="flex gap-3">
                <button onClick={()=>setShowTestModal(false)} className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50 transition-all">Close</button>
                <button onClick={()=>{ alert('✅ All checks passed (sim).'); setShowTestModal(false); }} className="flex-1 px-4 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">Run</button>
              </div>
            </div>
          </div>
        )}

        {/* Add Lead Modal */}
        {showAddLead && (
          <LeadEditorModal
            initialLead={{ id: 'new', market:'Insurance', type:'Life', source:'Manual', name:'', phone:'', email:'', location:'', status:'New', notes:'' }}
            onClose={()=>setShowAddLead(false)}
            onSave={(lead)=>{
              if (lead.id==='new') {
                addLead(lead);
              } else {
                updateLead(lead);
              }
              setShowAddLead(false);
            }}
          />
        )}
      </div>
    );
  };

  /* ---------- Lead Editor Modal (short form) ---------- */
  function LeadEditorModal({ initialLead, onClose, onSave }) {
    const [lead, setLead] = useState({ ...initialLead, callLogs: initialLead.callLogs || [], debt: initialLead.debt || { creditCards:[], mortgages:[], cars:[], others:[] } });
    const [tab, setTab] = useState('profile');

    const isInsurance = lead.market === 'Insurance';
    const showAPVSection = isInsurance && STATUS_ADVANCED.has(lead.status);

    const addDebtRow = (key)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: [ ...(prev.debt[key]||[]), { amount:'', apr:'', label:'' } ] } }));
    const updateDebtRow = (key, idx, field, value)=> {
      setLead(prev=>{
        const arr = [...(prev.debt[key]||[])];
        arr[idx] = { ...arr[idx], [field]: value };
        return { ...prev, debt: { ...prev.debt, [key]: arr } };
      });
    };
    const removeDebtRow = (key, idx)=> setLead(prev=>({ ...prev, debt: { ...prev.debt, [key]: (prev.debt[key]||[]).filter((_,i)=>i!==idx) } }));

    const addCallLog = ()=> setLead(prev=>({ ...prev, callLogs: [{ id: Date.now(), date: new Date().toLocaleString(), direction:'outbound', result:'no_answer', recordingUrl:'', transcript:'' }, ...(prev.callLogs||[]) ] }));
    const updateCallLog = (id, field, value)=> setLead(prev=>({ ...prev, callLogs: prev.callLogs.map(c => c.id===id ? { ...c, [field]: value } : c) }));
    const onUploadRecording = (id, file)=>{ if (!file) return; const url = URL.createObjectURL(file); updateCallLog(id, 'recordingUrl', url); };

    const saveLead = ()=>{
      const isClient = lead.status === 'Paid';
      const apvDate = showAPVSection && lead.apv && !lead.apvDate ? new Date().toISOString() : lead.apvDate;
      onSave({ ...lead, isClient, apvDate, id: lead.id==='new' ? Date.now() : lead.id });
      onClose();
    };

    return (
      <div className="fixed inset-0 bg-black bg-opacity-50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl p-6 max-w-4xl w-full">
          <div className="flex items-center justify-between mb-4">
            <h3 className="text-xl font-bold">Lead — {lead.name || 'New'}</h3>
            <button onClick={onClose} className="px-3 py-1 rounded bg-gray-100">Close</button>
          </div>

          <div className="flex gap-2 flex-wrap mb-4">
            {['profile','status','debt','notes','calls'].map(t=>(
              <button key={t} onClick={()=>setTab(t)} className={`px-3 py-2 rounded ${tab===t ? 'bg-blue-600 text-white':'bg-gray-100'}`}>{t==='profile'?'Profile':t==='status'?'Status & APV':t==='debt'?'Debt Worksheet':t==='notes'?'Notes':'Calls'}</button>
            ))}
          </div>

          {tab==='profile' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium mb-1">Market</label>
                <select className="w-full p-3 border rounded-xl" value={lead.market} onChange={(e)=>setLead(prev=>({...prev, market:e.target.value, type:''}))}>
                  {Object.keys(MARKET_OPTIONS).map(m=><option key={m} value={m}>{m}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Sub-Type</label>
                <select className="w-full p-3 border rounded-xl" value={lead.type} onChange={(e)=>setLead(prev=>({...prev, type:e.target.value}))}>
                  <option value="">Choose…</option>
                  {(MARKET_OPTIONS[lead.market]||[]).map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Source</label>
                <select className="w-full p-3 border rounded-xl" value={lead.source||'Manual'} onChange={(e)=>setLead(prev=>({...prev, source:e.target.value}))}>
                  {['Manual','Meta','Website','Other'].map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">Status</label>
                <select className="w-full p-3 border rounded-xl" value={lead.status||'New'} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                  {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                </select>
              </div>
              <div><label className="block text-sm font-medium mb-1">Name</label><input className="w-full p-3 border rounded-xl" value={lead.name||''} onChange={(e)=>setLead(prev=>({...prev, name:e.target.value}))}/></div>
              <div><label className="block text-sm font-medium mb-1">Phone</label><input className="w-full p-3 border rounded-xl" value={lead.phone||''} onChange={(e)=>setLead(prev=>({...prev, phone:e.target.value}))}/></div>
              <div><label className="block text-sm font-medium mb-1">Email</label><input className="w-full p-3 border rounded-xl" value={lead.email||''} onChange={(e)=>setLead(prev=>({...prev, email:e.target.value}))}/></div>
              <div><label className="block text-sm font-medium mb-1">Location</label><input className="w-full p-3 border rounded-xl" value={lead.location||''} onChange={(e)=>setLead(prev=>({...prev, location:e.target.value}))}/></div>
            </div>
          )}

          {tab==='status' && (
            <div className="space-y-4">
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Status</label>
                  <select className="w-full p-3 border rounded-xl" value={lead.status||'New'} onChange={(e)=>setLead(prev=>({...prev, status:e.target.value}))}>
                    {STATUS_LABELS.map(s=><option key={s} value={s}>{s}</option>)}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Carrier (Insurance)</label>
                  <input className="w-full p-3 border rounded-xl" value={lead.carrier || ''} onChange={(e)=>setLead(prev=>({...prev, carrier:e.target.value}))} disabled={!showAPVSection}/>
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">APV ($)</label>
                  <input type="number" className="w-full p-3 border rounded-xl" value={lead.apv || ''} onChange={(e)=>setLead(prev=>({...prev, apv:e.target.value}))} disabled={!showAPVSection}/>
                </div>
              </div>
              <div className="text-xs text-gray-600">When status becomes <strong>Paid</strong>, the lead is marked as a <strong>Client</strong>.</div>
            </div>
          )}

          {tab==='debt' && lead.market==='Insurance' && lead.type==='Debt Free' && (
            <div className="space-y-4">
              {[
                ['creditCards','Credit Cards'],
                ['mortgages','Mortgage'],
                ['cars','Car Loans'],
                ['others','Other Debts']
              ].map(([key,label])=>(
                <div key={key} className="bg-gray-50 p-4 rounded-xl">
                  <div className="flex items-center justify-between mb-2">
                    <h4 className="font-semibold">{label}</h4>
                    <button onClick={()=>addDebtRow(key)} className="px-2 py-1 bg-white border rounded">➕ Add</button>
                  </div>
                  <div className="space-y-2">
                    {(lead.debt[key]||[]).map((row,idx)=>(
                      <div key={idx} className="grid grid-cols-1 md:grid-cols-4 gap-2">
                        {key==='others' && (<input placeholder="Label" className="p-2 border rounded" value={row.label||''} onChange={(e)=>updateDebtRow(key, idx, 'label', e.target.value)}/>)}
                        <input placeholder="Amount" type="number" className="p-2 border rounded" value={row.amount||''} onChange={(e)=>updateDebtRow(key, idx, 'amount', e.target.value)}/>
                        <input placeholder="APR %" type="number" className="p-2 border rounded" value={row.apr||''} onChange={(e)=>updateDebtRow(key, idx, 'apr', e.target.value)}/>
                        <button onClick={()=>removeDebtRow(key, idx)} className="px-2 py-1 bg-gray-100 rounded">Remove</button>
                      </div>
                    ))}
                    {(lead.debt[key]||[]).length===0 && <div className="text-sm text-gray-500">No entries. Click Add.</div>}
                  </div>
                </div>
              ))}
            </div>
          )}
          {tab==='debt' && !(lead.market==='Insurance' && lead.type==='Debt Free') && (
            <div className="text-gray-500">Debt worksheet appears when sub-type is <strong>Debt Free</strong> under Insurance.</div>
          )}

          {tab==='notes' && (
            <div>
              <label className="block text-sm font-medium mb-1">Notes</label>
              <textarea className="w-full p-3 border rounded-xl h-40" value={lead.notes||''} onChange={(e)=>setLead(prev=>({...prev, notes:e.target.value}))}/>
            </div>
          )}

          {tab==='calls' && (
            <div className="space-y-3">
              <div className="flex justify-between items-center">
                <h4 className="font-semibold">Call Logs</h4>
                <button onClick={()=>addCallLog()} className="px-3 py-2 bg-gray-100 rounded">➕ Add Log</button>
              </div>
              {(lead.callLogs||[]).map(log=>(
                <div key={log.id} className="p-3 border rounded-xl">
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-2">
                    <input className="p-2 border rounded" value={log.date} onChange={(e)=>updateCallLog(log.id,'date',e.target.value)}/>
                    <select className="p-2 border rounded" value={log.direction} onChange={(e)=>updateCallLog(log.id,'direction',e.target.value)}>
                      <option value="outbound">Outbound</option>
                      <option value="inbound">Inbound</option>
                    </select>
                    <select className="p-2 border rounded" value={log.result} onChange={(e)=>updateCallLog(log.id,'result',e.target.value)}>
                      <option value="answered">Answered</option>
                      <option value="no_answer">No Answer</option>
                      <option value="voicemail">Voicemail</option>
                      <option value="call_back">Call Back</option>
                    </select>
                    <label className="p-2 border rounded flex items-center justify-between">
                      <span>Recording</span>
                      <input type="file" accept="audio/*" onChange={(e)=>onUploadRecording(log.id, e.target.files[0])}/>
                    </label>
                  </div>
                  {log.recordingUrl && <audio controls src={log.recordingUrl} className="mt-2 w-full"></audio>}
                  <div className="mt-2">
                    <label className="block text-sm font-medium mb-1">Transcript</label>
                    <textarea className="w-full p-2 border rounded h-24" value={log.transcript||''} onChange={(e)=>updateCallLog(log.id,'transcript',e.target.value)}/>
                  </div>
                </div>
              ))}
              {(lead.callLogs||[]).length===0 && <div className="text-sm text-gray-500">No call logs.</div>}
            </div>
          )}

          <div className="flex gap-3 mt-6">
            <button onClick={saveLead} className="flex-1 px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl hover:shadow-lg">Save</button>
            <button onClick={onClose} className="flex-1 px-4 py-2 border border-gray-300 rounded-xl hover:bg-gray-50">Cancel</button>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Voice + SMS (providers now controlled in Settings → APIs) ---------- */
  const VoiceAI = () => {
    const [local, setLocal] = useState({ ...voiceSettings, provider: apiSelection.voiceProvider });
    useEffect(()=>{ setLocal(prev=>({ ...prev, provider: apiSelection.voiceProvider })); }, [apiSelection.voiceProvider]);

    const voices = VOICE_CATALOG[local.provider] || [];
    const saveVoiceSettings = () => { setVoiceSettings(local); saveNow(); alert('✅ Voice settings saved.'); };

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h3 className="text-xl font-bold mb-2">🎙️ Voice AI Configuration</h3>
          <p className="text-xs text-gray-600 mb-4">Provider is set in <strong>Settings → API Selection</strong>.</p>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              <div>
                <label className="block font-medium mb-2">Provider</label>
                <input className="w-full p-3 border rounded-xl bg-gray-50" value={local.provider} readOnly/>
              </div>
              <div>
                <label className="block font-medium mb-2">Voice</label>
                <select className="w-full p-3 border rounded-xl" value={local.voice} onChange={(e)=>setLocal(prev=>({...prev, voice:e.target.value}))}>
                  <option value="">Select…</option>
                  {voices.map(v=><option key={v} value={v}>{v}</option>)}
                </select>
              </div>
              <div>
                <label className="block font-medium mb-2">Style</label>
                <select className="w-full p-3 border rounded-xl" value={local.style} onChange={(e)=>setLocal(prev=>({...prev, style:e.target.value}))}>
                  <option value="professional">Professional</option>
                  <option value="friendly">Friendly</option>
                  <option value="authoritative">Authoritative</option>
                  <option value="conversational">Conversational</option>
                </select>
              </div>
              <div>
                <label className="block font-medium mb-2">Response Speed</label>
                <select className="w-full p-3 border rounded-xl" value={local.speed} onChange={(e)=>setLocal(prev=>({...prev, speed:e.target.value}))}>
                  <option value="fast">Fast (0.5–1s)</option>
                  <option value="normal">Normal (1–2s)</option>
                  <option value="thoughtful">Thoughtful (2–3s)</option>
                </select>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div>
                  <label className="block font-medium mb-2">Immediate Callback Attempts</label>
                  <select className="w-full p-3 border rounded-xl" value={local.immediateAttempts} onChange={(e)=>setLocal(prev=>({...prev, immediateAttempts: parseInt(e.target.value)}))}>
                    <option value="1">1</option>
                    <option value="2">2</option>
                  </select>
                </div>
                <div>
                  <label className="block font-medium mb-2">Call Attempts</label>
                  <select className="w-full p-3 border rounded-xl" value={local.callAttempts} onChange={(e)=>setLocal(prev=>({...prev, callAttempts: parseInt(e.target.value)}))}>
                    {[1,2,3,4,5].map(n=> <option key={n} value={n}>{n}</option>)}
                  </select>
                </div>
              </div>
              <div>
                <label className="block font-medium mb-2">Time Between Calls</label>
                <select className="w-full p-3 border rounded-xl" value={local.callInterval} onChange={(e)=>setLocal(prev=>({...prev, callInterval: parseInt(e.target.value)}))}>
                  <option value="15">15 minutes</option>
                  <option value="30">30 minutes</option>
                  <option value="60">1 hour</option>
                  <option value="120">2 hours</option>
                  <option value="240">4 hours</option>
                  <option value="1440">1 day</option>
                </select>
              </div>
            </div>

            <div className="space-y-4">
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span className="font-medium text-sm">Immediate callback on no answer</span>
                <div className={`toggle-switch ${local.immediateCallbackOnNoAnswer ? 'active' : ''}`} onClick={()=>setLocal(prev=>({...prev, immediateCallbackOnNoAnswer: !prev.immediateCallbackOnNoAnswer}))}><div className="toggle-slider"></div></div>
              </label>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span className="font-medium text-sm">Immediate callback after voicemail</span>
                <div className={`toggle-switch ${local.immediateCallbackOnVoicemail ? 'active' : ''}`} onClick={()=>setLocal(prev=>({...prev, immediateCallbackOnVoicemail: !prev.immediateCallbackOnVoicemail}))}><div className="toggle-slider"></div></div>
              </label>
              <div>
                <label className="block font-medium mb-2">Voicemail Behavior</label>
                <select className="w-full p-3 border rounded-xl" value={local.voicemailBehavior} onChange={(e)=>setLocal(prev=>({...prev, voicemailBehavior:e.target.value}))}>
                  <option value="hangup">Detect beep → hang up</option>
                  <option value="leave_message">Detect beep → leave message</option>
                </select>
              </div>
              <div>
                <label className="block font-medium mb-2">Voicemail Script</label>
                <textarea className="w-full p-3 border rounded-xl h-24" value={local.voicemailScript} onChange={(e)=>setLocal(prev=>({...prev, voicemailScript:e.target.value}))}/>
              </div>
              <div>
                <label className="block font-medium mb-2">Script (Generic)</label>
                <textarea className="w-full p-3 border rounded-xl h-24" value={local.scripts.generic} onChange={(e)=>setLocal(prev=>({...prev, scripts:{...prev.scripts, generic:e.target.value}}))}/>
              </div>
              <button onClick={saveVoiceSettings} className="w-full p-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl">💾 Save Voice Settings</button>
            </div>
          </div>
        </div>

        <SMSConfig smsSettings={smsSettings} setSmsSettings={(s)=>{ setSmsSettings(s); saveNow(); }}/>
      </div>
    );
  };

  function SMSConfig({ smsSettings, setSmsSettings }){
    const DELAY_OPTIONS = [
      { v: 5, label: '5 minutes' },
      { v: 15, label: '15 minutes' },
      { v: 30, label: '30 minutes' },
      { v: 60, label: '1 hour' },
      { v: 1440, label: '1 day' },
      { v: 2880, label: '2 days' },
      { v: 10080, label: 'Next week' }
    ];
    return (
      <div className="bg-white rounded-2xl p-6 shadow-lg">
        <h3 className="text-xl font-bold mb-2">💬 SMS Configuration & Drip</h3>
        <p className="text-xs text-gray-600 mb-4">Provider is set in <strong>Settings → API Selection</strong>.</p>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div className="space-y-4">
            <div>
              <label className="block font-medium mb-2">Provider</label>
              <input className="w-full p-3 border rounded-xl bg-gray-50" value={smsSettings.provider} readOnly/>
            </div>
            <div className="flex items-center justify-between">
              <div>
                <label className="font-medium">Auto-Respond</label>
                <p className="text-sm text-gray-600">AI replies to inbound texts</p>
              </div>
              <div className={`toggle-switch ${smsSettings.autoRespond ? 'active' : ''}`} onClick={()=>setSmsSettings(prev=>({...prev, autoRespond: !prev.autoRespond}))}>
                <div className="toggle-slider"></div>
              </div>
            </div>
            <div>
              <label className="block font-medium mb-2">Default Follow-Up Delay</label>
              <select className="w-full p-3 border rounded-xl" value={smsSettings.followUpDelay} onChange={(e)=>setSmsSettings(prev=>({...prev, followUpDelay: parseInt(e.target.value)}))}>
                {DELAY_OPTIONS.map(o=><option key={o.v} value={o.v}>{o.label}</option>)}
              </select>
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="block font-medium mb-2">Business Start</label>
                <input type="time" className="w-full p-3 border rounded-xl" value={smsSettings.businessHours.start} onChange={(e)=>setSmsSettings(prev=>({...prev, businessHours:{...prev.businessHours, start:e.target.value}}))}/>
              </div>
              <div>
                <label className="block font-medium mb-2">Business End</label>
                <input type="time" className="w-full p-3 border rounded-xl" value={smsSettings.businessHours.end} onChange={(e)=>setSmsSettings(prev=>({...prev, businessHours:{...prev.businessHours, end:e.target.value}}))}/>
              </div>
            </div>
          </div>

          <div className="space-y-4">
            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-2">📆 Drip Scripts (by day)</h4>
              {Object.entries(smsSettings.scripts).map(([key,val])=>(
                <div key={key} className="mb-2">
                  <label className="block text-sm font-medium mb-1 uppercase">{key}</label>
                  <textarea className="w-full p-3 border rounded-xl h-20 resize-none" value={val} onChange={(e)=>setSmsSettings(prev=>({...prev, scripts:{...prev.scripts, [key]: e.target.value}}))}/>
                </div>
              ))}
            </div>

            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-2">🎯 Situational Scripts</h4>
              {Object.entries(smsSettings.scriptVariants).map(([key,val])=>(
                <div key={key} className="mb-2">
                  <label className="block text-sm font-medium mb-1 capitalize">{key}</label>
                  <textarea className="w-full p-3 border rounded-xl h-16 resize-none" value={val} onChange={(e)=>setSmsSettings(prev=>({...prev, scriptVariants:{...prev.scriptVariants, [key]: e.target.value}}))}/>
                </div>
              ))}
            </div>

            <button onClick={()=>{ alert('✅ SMS settings saved.'); }} className="w-full p-3 bg-gradient-to-r from-green-500 to-green-600 text-white font-semibold rounded-xl">💾 Save SMS Settings</button>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Objections ---------- */
  const ObjectionHandling = () => {
    const [newObjection, setNewObjection] = useState({ objection:'', response:'' });
    const addObjection = () => {
      if (!newObjection.objection || !newObjection.response) { alert('Fill both fields'); return; }
      const obj = { id: Date.now(), ...newObjection };
      setObjections(prev=>[...prev, obj]); saveNow({ objections: [...objections, obj] });
      setNewObjection({ objection:'', response:'' });
      alert('✅ Objection added.');
    };
    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h2 className="text-2xl font-bold mb-4">💬 Objection Handling</h2>
          <div className="bg-gray-50 p-4 rounded-xl mb-6">
            <h4 className="font-semibold mb-3">Add New Objection</h4>
            <div className="space-y-3">
              <div>
                <label className="block text-sm font-medium mb-1">Common Objection</label>
                <input type="text" className="w-full p-3 border rounded-xl" placeholder="e.g., I can't afford it right now" value={newObjection.objection} onChange={(e)=>setNewObjection(prev=>({...prev, objection:e.target.value}))}/>
              </div>
              <div>
                <label className="block text-sm font-medium mb-1">AI Response</label>
                <textarea className="w-full p-3 border rounded-xl h-24" placeholder="Write a helpful, empathetic response..." value={newObjection.response} onChange={(e)=>setNewObjection(prev=>({...prev, response:e.target.value}))}/>
              </div>
              <button onClick={addObjection} className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">➕ Add Objection</button>
            </div>
          </div>

          <div className="space-y-3">
            <h4 className="font-semibold">Current Objections ({objections.length})</h4>
            {objections.map(obj=>(
              <div key={obj.id} className="p-4 border border-gray-200 rounded-xl">
                <div className="font-semibold text-red-600 mb-2">"{obj.objection}"</div>
                <div className="text-sm text-gray-700 bg-green-50 p-3 rounded-lg"><strong>Response:</strong> {obj.response}</div>
              </div>
            ))}
            {objections.length===0 && <div className="text-center py-6 text-gray-500">No objections yet.</div>}
          </div>
        </div>
      </div>
    );
  };

  /* ---------- Campaigns (now view/edit creatives) ---------- */
  const CampaignManager = () => {
    const [editing, setEditing] = useState(null); // campaign object
    const onDelete = (id)=>{
      if (!confirm('Delete this campaign?')) return;
      const next = campaigns.filter(c=>c.id!==id);
      setCampaigns(next); saveNow({ campaigns: next });
    };
    const onSave = (camp)=>{
      const next = campaigns.map(c=> c.id===camp.id ? camp : c);
      setCampaigns(next); saveNow({ campaigns: next });
      setEditing(null);
    };
    return (
      <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">
        <h2 className="text-2xl font-bold mb-4">📈 Campaign Manager</h2>
        <div className="space-y-4">
          {campaigns.map(c=>(
            <div key={c.id} className="p-4 border border-gray-200 rounded-xl">
              <div className="flex justify-between items-start">
                <div>
                  <div className="font-semibold">{c.name}</div>
                  <div className="text-sm text-gray-600">{c.market}/{c.type} • ${c.budget}/day</div>
                </div>
                <div className="flex items-center gap-2">
                  <span className={`badge ${c.status==='active'?'bg-green-100 text-green-800':'bg-gray-100 text-gray-800'}`}>{c.status}</span>
                  <button onClick={()=>setEditing(c)} className="px-2 py-1 bg-blue-100 text-blue-700 rounded text-sm">Edit</button>
                  <button onClick={()=>onDelete(c.id)} className="px-2 py-1 bg-gray-100 rounded text-sm">🗑️</button>
                </div>
              </div>
              <div className="mt-2 text-sm">{c.leads||0} leads • ${c.costPerLead||0} CPL</div>
            </div>
          ))}
          {campaigns.length===0 && <div className="text-gray-500">No campaigns yet.</div>}
        </div>

        {editing && <CampaignEditor campaign={editing} onClose={()=>setEditing(null)} onSave={onSave}/>}
      </div>
    );
  };

  function CampaignEditor({ campaign, onClose, onSave }){
    const [draft, setDraft] = useState({ ...campaign, variants: campaign.variants || [], images: campaign.images || [] });

    const addImage = (file)=>{
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = { id: Date.now(), url };
      setDraft(prev=>({ ...prev, images: [img, ...(prev.images||[])] }));
    };
    const linkImage = (variantId, imageId)=>{
      setDraft(prev=>({ ...prev, variants: prev.variants.map(v=> v.id===variantId ? { ...v, imageId } : v) }));
    };

    return (
      <div className="fixed inset-0 bg-black/40 z-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-2xl p-6 w-full max-w-5xl">
          <div className="flex justify-between items-center mb-3">
            <h3 className="text-xl font-bold">Edit Campaign</h3>
            <button onClick={onClose} className="px-3 py-1 bg-gray-100 rounded">Close</button>
          </div>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
            <input className="p-3 border rounded" value={draft.name} onChange={(e)=>setDraft(prev=>({...prev,name:e.target.value}))}/>
            <select className="p-3 border rounded" value={draft.status} onChange={(e)=>setDraft(prev=>({...prev,status:e.target.value}))}>
              {['active','paused','ended'].map(s=><option key={s} value={s}>{s}</option>)}
            </select>
            <input type="number" className="p-3 border rounded" value={draft.budget} onChange={(e)=>setDraft(prev=>({...prev,budget:parseInt(e.target.value)||0}))}/>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <div className="flex items-center gap-3 mb-2">
                <label className="px-3 py-2 bg-gray-100 rounded cursor-pointer">
                  Upload Image
                  <input type="file" accept="image/*" className="hidden" onChange={(e)=>addImage(e.target.files[0])}/>
                </label>
              </div>
              <div className="grid grid-cols-2 md:grid-cols-3 gap-3">
                {(draft.images||[]).map(i=>(
                  <div key={i.id} className="border rounded-xl overflow-hidden">
                    <img src={i.url} className="w-full h-28 object-cover"/>
                  </div>
                ))}
                {(draft.images||[]).length===0 && <div className="text-sm text-gray-500">No images</div>}
              </div>
            </div>
            <div className="overflow-auto border rounded-xl">
              <table className="min-w-full text-sm">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-3 py-2 text-left">Image</th>
                    <th className="px-3 py-2 text-left">Headline</th>
                    <th className="px-3 py-2 text-left">Copy</th>
                    <th className="px-3 py-2 text-left">CTA</th>
                  </tr>
                </thead>
                <tbody>
                  {(draft.variants||[]).map(v=>(
                    <tr key={v.id} className="border-t">
                      <td className="px-3 py-2">
                        <select className="p-2 border rounded" value={v.imageId || ''} onChange={(e)=>linkImage(v.id, e.target.value ? Number(e.target.value): null)}>
                          <option value="">None</option>
                          {(draft.images||[]).map(i=> <option key={i.id} value={i.id}>{i.id}</option>)}
                        </select>
                      </td>
                      <td className="px-3 py-2 max-w-xs"><input className="w-full p-2 border rounded" value={v.headline} onChange={(e)=>setDraft(prev=>({...prev, variants: prev.variants.map(x=>x.id===v.id? {...x, headline:e.target.value}:x)}))}/></td>
                      <td className="px-3 py-2"><textarea className="w-full p-2 border rounded h-16" value={v.copy} onChange={(e)=>setDraft(prev=>({...prev, variants: prev.variants.map(x=>x.id===v.id? {...x, copy:e.target.value}:x)}))}/></td>
                      <td className="px-3 py-2">
                        <select className="p-2 border rounded" value={v.cta} onChange={(e)=>setDraft(prev=>({...prev, variants: prev.variants.map(x=>x.id===v.id? {...x, cta:e.target.value}:x)}))}>
                          <option value="learn-more">Learn More</option>
                          <option value="get-quote">Get Free Quote</option>
                          <option value="call-now">Call Now</option>
                          <option value="apply-now">Apply Now</option>
                        </select>
                      </td>
                    </tr>
                  ))}
                  {(draft.variants||[]).length===0 && <tr><td className="px-3 py-4 text-center text-gray-500" colSpan="4">No variants</td></tr>}
                </tbody>
              </table>
            </div>
          </div>

          <div className="flex gap-3 mt-4">
            <button onClick={()=>onSave(draft)} className="px-4 py-2 bg-blue-600 text-white rounded">Save</button>
            <button onClick={onClose} className="px-4 py-2 border rounded">Cancel</button>
          </div>
        </div>
      </div>
    );
  }

  /* ---------- Analytics (same logic as before) ---------- */
  const Analytics = () => {
    const a = analyticsData;
    const statusCounts = STATUS_LABELS.reduce((acc,s)=> (acc[s]=leads.filter(l=>l.status===s).length, acc), {});
    const calls = leads.flatMap(l => l.callLogs || []);
    const callsTotal = calls.length;
    const callsInbound = calls.filter(c=>c.direction==='inbound').length;
    const callsOutbound = calls.filter(c=>c.direction!=='inbound').length;
    const answered = calls.filter(c=>c.result==='answered').length;
    const noAnswer = calls.filter(c=>c.result==='no_answer').length;
    const voicemail = calls.filter(c=>c.result==='voicemail').length;
    const callbacks = calls.filter(c=>c.result==='call_back').length;
    const voicemailRate = callsTotal ? Math.round((voicemail/callsTotal)*100) : 0;
    const clientCount = leads.filter(l=>l.isClient).length;
    const policySummary = `${voiceSettings.callAttempts} attempts • ${voiceSettings.callInterval===1440?'1 day': voiceSettings.callInterval+' min'} between • immediate ${voiceSettings.immediateAttempts}×`;

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h2 className="text-2xl font-bold mb-6">📊 Analytics & Reporting</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-6">
            <div className="text-center p-4 bg-blue-50 rounded-xl"><div className="text-2xl font-bold text-blue-600">${a?.overview?.avgCostPerLead || 0}</div><div className="text-sm text-blue-800">Avg CPL</div></div>
            <div className="text-center p-4 bg-green-50 rounded-xl"><div className="text-2xl font-bold text-green-600">{a?.performance?.callAnswerRate || 0}%</div><div className="text-sm text-green-800">Call Answer Rate</div></div>
            <div className="text-center p-4 bg-purple-50 rounded-xl"><div className="text-2xl font-bold text-purple-600">{a?.performance?.schedulingRate || 0}%</div><div className="text-sm text-purple-800">Scheduling Rate</div></div>
            <div className="text-center p-4 bg-orange-50 rounded-xl"><div className="text-2xl font-bold text-orange-600">${a?.performance?.revenuePerLead || 0}</div><div className="text-sm text-orange-800">Revenue / Lead</div></div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-2">Pipeline</h4>
              <ul className="text-sm grid grid-cols-2 gap-1">
                {STATUS_LABELS.map(s => <li key={s}>{s}: <strong>{statusCounts[s]}</strong></li>)}
              </ul>
            </div>
            <div className="bg-gray-50 p-4 rounded-xl">
              <h4 className="font-semibold mb-2">Calls</h4>
              <div className="text-sm">Total: <strong>{callsTotal}</strong> • Inbound: <strong>{callsInbound}</strong> • Outbound: <strong>{callsOutbound}</strong></div>
              <div className="text-sm">Answered: <strong>{answered}</strong> • No Answer: <strong>{noAnswer}</strong> • Voicemail: <strong>{voicemail}</strong> • Callbacks: <strong>{callbacks}</strong></div>
              <div className="text-xs text-gray-600 mt-1">Policy: {policySummary}</div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* ---------- Inbound Center (same) ---------- */
  const InboundCenter = () => {
    const [autoMatchUnknown, setAutoMatchUnknown] = useState(true);
    const [testing, setTesting] = useState(false);
    const matchLeadByPhone = (num) => { const clean = (num||'').replace(/\D/g,''); return leads.find(l => (l.phone||'').replace(/\D/g,'') === clean); };
    const handleInbound = async (evt) => {
      let matched = matchLeadByPhone(evt.from);
      let askName = false;
      if (!matched && autoMatchUnknown) {
        const nameMatch = (evt.text||'').match(/\b(I'm|I am|This is)\s+([A-Z][a-zA-Z]+)\b/);
        if (nameMatch) matched = leads.find(l=> (l.name||'').toLowerCase().includes(nameMatch[2].toLowerCase()));
        if (!matched) askName = true;
      }
      const record = { id: Date.now(), ...evt, time: new Date().toLocaleString(), matchedLeadId: matched?.id, status:'received', askName };
      setInboundEvents(prev => [record, ...prev]); saveNow({ inbound: [record, ...inboundEvents] });
    };
    useEffect(()=>{
      let stop=false;
      (async ()=>{
        if (testing) {
          await new Promise(r=>setTimeout(r, 1000));
          if (!stop) handleInbound({ type:'sms', from:'+1 (555) 333-1212', to:'+1 (555) 111-0000', text:'Hey this is Chris, calling back about the quote' });
        }
      })();
      return ()=>{ stop=true; };
    },[testing]);
    const copy = async (text)=>{ try{ await navigator.clipboard.writeText(text); alert('Copied'); } catch{} };
    const webhookBase = window.location.origin || 'https://your-server.com';
    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-6 shadow-lg">
          <h3 className="text-xl font-bold mb-4">📞 Inbound Center</h3>
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="space-y-4">
              <div className="bg-gray-50 p-4 rounded-xl">
                <h4 className="font-semibold mb-2">Webhooks (configure at provider)</h4>
                <div className="text-sm">
                  <div className="flex items-center justify-between mb-2"><span>Inbound Call URL</span><button onClick={()=>copy(`${webhookBase}/webhooks/inbound/call`)} className="text-blue-600 text-sm">Copy</button></div>
                  <code className="inline block mb-2">{webhookBase}/webhooks/inbound/call</code>
                </div>
                <div className="text-sm">
                  <div className="flex items-center justify-between mb-2"><span>Inbound SMS URL</span><button onClick={()=>copy(`${webhookBase}/webhooks/inbound/sms`)} className="text-blue-600 text-sm">Copy</button></div>
                  <code className="inline block">{webhookBase}/webhooks/inbound/sms</code>
                </div>
              </div>
              <div className="flex items-center justify-between p-4 bg-gray-50 rounded-xl">
                <div>
                  <div className="font-medium">Auto-match unknown callers</div>
                  <div className="text-xs text-gray-600">Try number/name; otherwise ask their name</div>
                </div>
                <div className={`toggle-switch ${autoMatchUnknown ? 'active' : ''}`} onClick={()=>setAutoMatchUnknown(!autoMatchUnknown)}><div className="toggle-slider"></div></div>
              </div>
              <button onClick={()=>setTesting(v=>!v)} className="w-full p-3 bg-gradient-to-r from-orange-500 to-red-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">{testing ? '⏹️ Stop Simulated Inbound' : '▶️ Simulate Inbound'}</button>
            </div>
            <div className="space-y-3">
              <h4 className="font-semibold">Recent Inbound</h4>
              {inboundEvents.map(evt=>(
                <div key={evt.id} className="p-3 border rounded-xl">
                  <div className="flex justify-between">
                    <div className="font-semibold">{evt.type==='call'?'📞 Call':'💬 SMS'} from {evt.from || 'unknown'}</div>
                    <span className="text-xs text-gray-500">{evt.time}</span>
                  </div>
                  {evt.text && <div className="text-sm text-gray-700 mt-1">“{evt.text}”</div>}
                  <div className="text-xs text-gray-600 mt-1">Matched lead: {evt.matchedLeadId ? `#${evt.matchedLeadId}` : (evt.askName ? 'ask for name' : 'not found')}</div>
                </div>
              ))}
              {inboundEvents.length===0 && <div className="text-gray-500 text-sm">No inbound yet.</div>}
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* ---------- Imports page is same as before (kept minimal) ---------- */
  const Imports = () => <div className="bg-white rounded-2xl p-6 shadow-lg fade-in">Use the imports flow from Leads.</div>;

  /* ---------- Settings (API Selection centralizes providers) ---------- */
  const Settings = () => {
    const [tab, setTab] = useState('apis');
    const saveAll = () => { 
      // mirror providers across voice/sms settings
      setVoiceSettings(prev=>({ ...prev, provider: apiSelection.voiceProvider }));
      setSmsSettings(prev=>({ ...prev, provider: apiSelection.smsProvider }));
      saveNow(); 
      alert('✅ Settings saved.');
    };

    return (
      <div className="space-y-6 fade-in">
        <div className="bg-white rounded-2xl p-4 lg:p-6 shadow-lg">
          <div className="flex gap-2 mb-4 flex-wrap">
            <button onClick={()=>setTab('apis')} className={`px-3 py-2 rounded ${tab==='apis'?'bg-blue-600 text-white':'bg-gray-100'}`}>API Selection</button>
            <button onClick={()=>setTab('routing')} className={`px-3 py-2 rounded ${tab==='routing'?'bg-blue-600 text-white':'bg-gray-100'}`}>AI Routing & Workers</button>
            <button onClick={()=>setTab('automation')} className={`px-3 py-2 rounded ${tab==='automation'?'bg-blue-600 text-white':'bg-gray-100'}`}>Automation</button>
            <button onClick={()=>setTab('account')} className={`px-3 py-2 rounded ${tab==='account'?'bg-blue-600 text-white':'bg-gray-100'}`}>Account</button>
            {me.isAdmin && <button onClick={()=>setTab('users')} className={`px-3 py-2 rounded ${tab==='users'?'bg-blue-600 text-white':'bg-gray-100'}`}>Users (Admin)</button>}
          </div>

          {tab==='apis' && (
            <>
              <h3 className="text-lg lg:text-xl font-bold mb-4">API Selection (centralized)</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div>
                  <label className="block font-medium mb-2">Voice Provider</label>
                  <select className="w-full p-3 border rounded-xl" value={apiSelection.voiceProvider} onChange={(e)=>setApiSelection(prev=>({...prev, voiceProvider:e.target.value}))}>
                    <option value="elevenlabs">ElevenLabs</option>
                    <option value="openai">OpenAI Voice</option>
                    <option value="azure">Azure Speech</option>
                    <option value="google">Google Cloud Speech</option>
                  </select>
                </div>
                <div>
                  <label className="block font-medium mb-2">SMS Provider</label>
                  <select className="w-full p-3 border rounded-xl" value={apiSelection.smsProvider} onChange={(e)=>setApiSelection(prev=>({...prev, smsProvider:e.target.value}))}>
                    <option value="twilio">Twilio</option>
                    <option value="messagebird">MessageBird</option>
                    <option value="vonage">Vonage</option>
                  </select>
                </div>
              </div>
              <p className="text-xs text-gray-600 mt-3">These selections automatically flow to Voice AI and SMS pages.</p>
            </>
          )}

          {tab==='routing' && (
            <>
              <h3 className="text-lg lg:text-xl font-bold mb-4">Model Routing & Workers</h3>
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div className="bg-gray-50 p-4 rounded-xl">
                  <h4 className="font-semibold mb-2">Brains</h4>
                  {[
                    ['callsModel','Calls/SMS brain','gpt-5-mini'],
                    ['callsEscalationModel','Escalation model','gpt-5'],
                    ['smsModel','SMS brain','gpt-5-mini'],
                    ['adsDraftModel','Ads draft model','gpt-5-mini'],
                    ['adsPolishModel','Ads polish model','gpt-5'],
                    ['adsImageModel','Ad images model','gpt-image-3.5']
                  ].map(([field,label,def])=>(
                    <div key={field} className="mb-2">
                      <label className="block text-sm font-medium mb-1">{label}</label>
                      <input type="text" className="w-full p-2 border rounded" value={routing[field]} onChange={(e)=>setRouting(prev=>({...prev, [field]: e.target.value || def}))}/>
                    </div>
                  ))}
                  <p className="text-xs text-gray-600 mt-2">Realtime worker for calls/SMS; batch worker for ads. Kept isolated so calls never lag.</p>
                </div>

                <div className="bg-gray-50 p-4 rounded-xl">
                  <h4 className="font-semibold mb-2">Workers (limits)</h4>
                  <div className="mb-3">
                    <div className="font-medium mb-1">Realtime (calls/SMS)</div>
                    {['maxTokens','timeoutMs','rpm','tpm'].map(k=>(
                      <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                        <label className="text-sm text-gray-600">{k}</label>
                        <input type="number" className="p-2 border rounded" value={routing.realtimeWorker[k]} onChange={(e)=>setRouting(prev=>({...prev, realtimeWorker:{...prev.realtimeWorker, [k]: parseInt(e.target.value)||0}}))}/>
                      </div>
                    ))}
                  </div>
                  <div>
                    <div className="font-medium mb-1">Batch (ads copy/image)</div>
                    {['maxTokens','timeoutMs','rpm','tpm'].map(k=>(
                      <div key={k} className="grid grid-cols-2 gap-2 mb-2">
                        <label className="text-sm text-gray-600">{k}</label>
                        <input type="number" className="p-2 border rounded" value={routing.batchWorker[k]} onChange={(e)=>setRouting(prev=>({...prev, batchWorker:{...prev.batchWorker, [k]: parseInt(e.target.value)||0}}))}/>
                      </div>
                    ))}
                  </div>
                </div>
              </div>

              <div className="bg-gray-50 p-4 rounded-xl mt-4">
                <h4 className="font-semibold mb-2">Spend Tracking Metadata</h4>
                {[
                  ['call','call'],
                  ['sms','sms'],
                  ['adsCopy','ads-copy'],
                  ['adsImage','ads-image']
                ].map(([key,def])=>(
                  <div key={key} className="mb-3">
                    <div className="text-sm font-medium mb-1">{key}</div>
                    <div className="grid grid-cols-3 gap-2 items-center">
                      <span className="text-xs text-gray-600 col-span-1">channel</span>
                      <input type="text" className="p-2 border rounded col-span-2" value={routing.metadata[key]?.channel || def} onChange={(e)=>setRouting(prev=>({...prev, metadata:{...prev.metadata, [key]: { ...prev.metadata[key], channel: e.target.value }}}))}/>
                    </div>
                  </div>
                ))}
                <p className="text-xs text-gray-600">Requests are tagged like <code className="inline">{'{channel:"call"|"sms"|"ads-copy"|"ads-image"}'}</code></p>
              </div>
            </>
          )}

          {tab==='automation' && (
            <div className="space-y-4">
              <h3 className="text-lg lg:text-xl font-bold">Automation</h3>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Auto-start outreach when a Meta lead arrives</span>
                <div className={`toggle-switch ${automation.autoStartOnMeta ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, autoStartOnMeta: !prev.autoStartOnMeta}))}><div className="toggle-slider"></div></div>
              </label>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Immediate retry on No Answer</span>
                <div className={`toggle-switch ${automation.immediateRetryOnNoAnswer ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, immediateRetryOnNoAnswer: !prev.immediateRetryOnNoAnswer}))}><div className="toggle-slider"></div></div>
              </label>
              <label className="flex items-center justify-between p-3 bg-gray-50 rounded-xl">
                <span>Immediate retry after Voicemail</span>
                <div className={`toggle-switch ${automation.immediateRetryOnVoicemail ? 'active' : ''}`} onClick={()=>setAutomation(prev=>({...prev, immediateRetryOnVoicemail: !prev.immediateRetryOnVoicemail}))}><div className="toggle-slider"></div></div>
              </label>
            </div>
          )}

          {tab==='account' && (
            <div className="space-y-4">
              <h3 className="text-lg lg:text-xl font-bold">Account</h3>
              <div className="p-4 bg-gray-50 rounded-xl">
                <div className="text-sm text-gray-700"><strong>Email:</strong> {me.email}</div>
                <div className="text-sm text-gray-700"><strong>Role:</strong> {me.isAdmin ? 'Admin' : 'User'}</div>
              </div>
              <div className="flex gap-2">
                <button onClick={async ()=>{
                  const oldp = prompt('Enter current password:'); if (!oldp) return;
                  const newp = prompt('Enter new password:'); if (!newp) return;
                  const conf = prompt('Confirm new password:'); if (conf !== newp) { alert('Passwords do not match'); return; }
                  const users = loadUsers();
                  const idx = users.findIndex(x=>emailEq(x.email, me.email)); if (idx<0) return alert('User not found');
                  const oldHash = await sha256(oldp);
                  if (oldHash !== users[idx].passHash) return alert('Current password incorrect');
                  users[idx] = { ...users[idx], passHash: await sha256(newp) };
                  saveUsers(users);
                  alert('✅ Password changed.');
                }} className="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-600 text-white rounded-xl">Change Password</button>
                <button onClick={onLogout} className="px-4 py-2 bg-red-100 text-red-700 rounded-xl">Logout</button>
              </div>
            </div>
          )}

          {tab==='users' && me.isAdmin && (
            <UsersAdmin me={me} onImpersonate={(email)=>{
              saveSession({ email, isAdmin: loadUsers().find(u=>emailEq(u.email,email))?.isAdmin || false });
              onImpersonate(email);
            }}/>
          )}

          {(tab==='apis' || tab==='routing' || tab==='automation') && (
            <div className="mt-6">
              <button onClick={saveAll} className="px-6 py-3 bg-gradient-to-r from-blue-500 to-purple-600 text-white font-semibold rounded-xl hover:shadow-lg transition-all">💾 Save</button>
            </div>
          )}
        </div>
      </div>
    );
  };

  /* ---------- Utility actions ---------- */
  const getLeadFollowUp = (lead) => ({ enabled: true, followUpDelay: smsSettings.followUpDelay, scripts: smsSettings.scripts });
  const followUpLabel = (mins)=>{ const n = Number(mins)||0; if (n < 120) return `${n} minutes`; if (n < 24*60) return `${Math.round(n/60)} hours`; if (n % (7*24*60) === 0) return `${n/(7*24*60)} week`; return `${Math.round(n/1440)} day(s)`; };
  const initiateContact = async (lead, method) => {
    try {
      const f = getLeadFollowUp(lead);
      await fetch('/api/ai-call', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ leadId: lead.id, phoneNumber: lead.phone, method, routing, followUp: f }) }).catch(()=>{});
      alert(`✅ ${method==='call'?'Call':'SMS'} initiated (sim).\nFollow-up: ${f.enabled ? followUpLabel(f.followUpDelay) : 'OFF'}`);
    } catch { alert(`❌ ${method==='call'?'Call':'SMS'} failed.`); }
  };

  /* ---------- Mount helpers ---------- */
  function openLeadEditor(lead){
    const onClose = ()=>{ setEditor(null); };
    const onSave = (updated)=>{ setLeads(prev => prev.map(l => l.id===updated.id ? updated : l)); };
    setEditor(<LeadEditorModal initialLead={lead} onClose={onClose} onSave={onSave}/>);
  }
  const [editor, setEditor] = useState(null);

  /* ---------- Render ---------- */
  const renderContent = () => {
    switch(activeTab) {
      case 'dashboard': return <Dashboard/>;
      case 'ad-creator': return <AdCreator/>;
      case 'leads': return <LeadManagement/>;
      case 'voice-ai': return <VoiceAI/>;
      case 'objections': return <ObjectionHandling/>;
      case 'campaigns': return <CampaignManager/>;
      case 'analytics': return <Analytics/>;
      case 'inbound': return <InboundCenter/>;
      case 'imports': return <Imports/>;
      case 'settings': return <Settings/>;
      case 'admin-users': return <UsersAdmin me={me} onImpersonate={(email)=>{ saveSession({ email, isAdmin: loadUsers().find(u=>emailEq(u.email,email))?.isAdmin || false }); onImpersonate(email); }}/>;
      default: return <Dashboard/>;
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 via-purple-50 to-pink-50">
      <div className="flex flex-col lg:flex-row">
        <MobileNav/>
        <Sidebar/>
        <div className="flex-1 p-4 lg:p-8">
          <div className="mb-6 lg:mb-8">
            <h1 className="text-2xl lg:text-4xl font-bold bg-gradient-to-r from-blue-600 to-purple-600 bg-clip-text text-transparent mb-2">
              {activeTab==='dashboard' && 'Dashboard Overview'}
              {activeTab==='ad-creator' && 'Professional Ad Creator'}
              {activeTab==='leads' && 'Lead Management'}
              {activeTab==='voice-ai' && 'Voice AI System'}
              {activeTab==='objections' && 'Objection Handling'}
              {activeTab==='campaigns' && 'Campaign Manager'}
              {activeTab==='analytics' && 'Analytics & Reporting'}
              {activeTab==='inbound' && 'Inbound Center'}
              {activeTab==='imports' && 'Imports & Field Mapping'}
              {activeTab==='settings' && 'Settings & Configuration'}
              {activeTab==='admin-users' && 'Users (Admin)'}
            </h1>
            <p className="text-sm lg:text-base text-gray-600">Multi-tenant workspace • Logged in as {me.email}</p>
          </div>
          {renderContent()}
        </div>
      </div>
      {editor}
    </div>
  );
}

/* =========================
   APP WRAPPER
   ========================= */
function AppWrapper(){
  const [me, setMe] = useState(null);
  useEffect(()=>{ (async ()=>{ await ensureAdmin(); const sess = loadSession(); if (sess) setMe(sess); })(); },[]);
  if (!me) return <LoginView onLoggedIn={setMe}/>;
  const logout = ()=>{ clearSession(); setMe(null); };
  const impersonate = (email)=>{ const u = loadUsers().find(x=>emailEq(x.email,email)); if (!u) return; setMe({ email: u.email, isAdmin: !!u.isAdmin }); };
  return <LeadFlowApp me={me} onLogout={logout} onImpersonate={impersonate}/>;
}

/* =========================
   MOUNT
   ========================= */
const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<ErrorBoundary><AppWrapper/></ErrorBoundary>);
</script>
</body>
</html>